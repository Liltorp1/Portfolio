<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passive Income Portfolio</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #0a0e1a; color: #e8edf4; padding: 20px 20px 100px; min-height: 100vh; }
        h1 { font-size: 28px; margin-bottom: 10px; }
        .card { background: #1a2237; border: 1px solid #2a3550; border-radius: 12px; padding: 20px; margin-bottom: 15px; }
        .label { font-size: 12px; color: #9ba5b8; text-transform: uppercase; margin-bottom: 8px; }
        .value { font-size: 32px; font-weight: 300; margin-bottom: 5px; }
        .change { font-size: 14px; color: #9ba5b8; }
        .positive { color: #00ff88; }
        .negative { color: #ff4466; }
        .btn { background: #4d94ff; color: white; border: none; border-radius: 10px; padding: 14px 24px; font-size: 16px; width: 100%; cursor: pointer; }
        .btn:active { opacity: 0.8; }
        .btn-small { width: auto; padding: 10px 20px; font-size: 14px; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); padding: 20px; overflow-y: auto; z-index: 1000; }
        .modal.show { display: block; }
        .modal-content { background: #1a2237; border-radius: 16px; padding: 24px; max-width: 500px; margin: 40px auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close { font-size: 30px; color: #9ba5b8; cursor: pointer; background: none; border: none; }
        input, select { width: 100%; background: #0a0e1a; border: 1px solid #2a3550; border-radius: 8px; padding: 12px; color: #e8edf4; font-size: 16px; margin-bottom: 15px; }
        label { display: block; font-size: 14px; color: #9ba5b8; margin-bottom: 5px; }
        .holding { background: #1a2237; border: 1px solid #2a3550; border-radius: 10px; padding: 15px; margin-bottom: 10px; cursor: pointer; }
        .holding:active { background: #202840; }
        .holding-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .ticker { font-size: 18px; font-weight: 600; }
        .meta { font-size: 12px; color: #9ba5b8; margin-top: 4px; }
        .section-title { font-size: 12px; text-transform: uppercase; color: #9ba5b8; margin: 20px 0 15px; display: flex; justify-content: space-between; align-items: center; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: #151b2e; padding: 12px; display: flex; gap: 8px; }
        .nav-btn { flex: 1; padding: 12px; background: #1a2237; border: 1px solid #2a3550; border-radius: 8px; color: #9ba5b8; font-size: 14px; cursor: pointer; border: none; }
        .status { font-size: 10px; margin-top: 3px; }
        .currency-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .currency-row input { flex: 2; margin-bottom: 0; }
        .currency-row select { flex: 1; margin-bottom: 0; }
        .live { color: #00ff88; }
        .manual-price { color: #ffc044; }
        .failed { color: #ff4466; }
        .fund-badge { background: #2a3550; padding: 2px 8px; border-radius: 4px; font-size: 10px; margin-left: 8px; }
        .info-text { font-size: 12px; color: #9ba5b8; margin-top: -10px; margin-bottom: 15px; font-style: italic; }
        .filter-tabs { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 4px; }
        .filter-tab { padding: 8px 16px; background: #1a2237; border: 1px solid #2a3550; border-radius: 8px; color: #9ba5b8; font-size: 13px; cursor: pointer; white-space: nowrap; }
        .filter-tab.active { background: #4d94ff; color: white; border-color: #4d94ff; }
        .next-update { font-size: 11px; color: #9ba5b8; margin-top: 5px; }
        .loading-indicator { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1a2237; padding: 20px 40px; border-radius: 12px; border: 2px solid #4d94ff; z-index: 2000; display: none; }
        .loading-indicator.show { display: block; }
        .error-list { background: #ff446620; border: 1px solid #ff4466; border-radius: 8px; padding: 12px; margin: 15px 0; font-size: 12px; }
        .error-item { margin: 4px 0; }
        .chart-container { position: relative; max-height: 250px; }
        
        /* Chat styles */
        .chat-container { position: fixed; bottom: 80px; right: 20px; width: 380px; max-width: calc(100vw - 40px); height: 500px; background: #1a2237; border: 1px solid #2a3550; border-radius: 16px; display: none; flex-direction: column; z-index: 999; box-shadow: 0 8px 32px rgba(0,0,0,0.4); }
        .chat-container.show { display: flex; }
        .chat-header { padding: 16px; border-bottom: 1px solid #2a3550; display: flex; justify-content: space-between; align-items: center; }
        .chat-header h3 { font-size: 16px; margin: 0; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
        .chat-message { padding: 12px; border-radius: 8px; max-width: 85%; word-wrap: break-word; }
        .chat-message.user { background: #4d94ff; color: white; align-self: flex-end; margin-left: auto; }
        .chat-message.assistant { background: #2a3550; color: #e8edf4; align-self: flex-start; }
        .chat-message.assistant ul, .chat-message.assistant ol { margin: 8px 0; padding-left: 20px; }
        .chat-message.assistant li { margin: 4px 0; }
        .chat-input-container { padding: 12px; border-top: 1px solid #2a3550; display: flex; gap: 8px; }
        .chat-input { flex: 1; background: #0a0e1a; border: 1px solid #2a3550; border-radius: 8px; padding: 10px; color: #e8edf4; font-size: 14px; margin: 0; }
        .chat-send-btn { background: #4d94ff; color: white; border: none; border-radius: 8px; padding: 10px 20px; cursor: pointer; font-size: 14px; }
        .chat-send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .typing-indicator { padding: 12px; background: #2a3550; border-radius: 8px; align-self: flex-start; max-width: 85px; }
        .typing-indicator span { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #9ba5b8; margin: 0 2px; animation: typing 1.4s infinite; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 60%, 100% { opacity: 0.3; } 30% { opacity: 1; } }
        
        /* Settings styles */
        .settings-section { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #2a3550; }
        .settings-section:last-child { border-bottom: none; }
        .settings-section h4 { margin-bottom: 10px; font-size: 14px; color: #e8edf4; }
        .key-status { display: inline-block; margin-left: 10px; padding: 4px 8px; border-radius: 4px; font-size: 11px; }
        .key-status.configured { background: #00ff8820; color: #00ff88; }
        .key-status.missing { background: #ff446620; color: #ff4466; }
        .btn-secondary { background: #2a3550; margin-top: 10px; }
        .warning-text { color: #ffc044; font-size: 12px; margin-top: 5px; }
        
        body.light { background: #f8f9fa; color: #212529; }
        body.light .card { background: #ffffff; border-color: #dee2e6; }
        body.light input, body.light select { background: #ffffff; color: #212529; border-color: #ced4da; }
        body.light .holding { background: #ffffff; border-color: #dee2e6; }
        body.light .filter-tab { background: #ffffff; border-color: #dee2e6; }
        body.light .filter-tab.active { background: #007bff; color: white; }
        body.light .bottom-nav { background: #ffffff; border-top: 1px solid #dee2e6; }
        body.light .nav-btn { background: #ffffff; border-color: #dee2e6; color: #495057; }
        body.light .modal-content { background: #ffffff; }
        body.light .loading-indicator { background: #ffffff; border-color: #007bff; }
        body.light .chat-container { background: #ffffff; border-color: #dee2e6; }
        body.light .chat-header { border-color: #dee2e6; }
        body.light .chat-message.assistant { background: #f8f9fa; color: #212529; }
        body.light .chat-input { background: #ffffff; border-color: #ced4da; color: #212529; }
        body.light .chat-input-container { border-color: #dee2e6; }
        body.light .typing-indicator { background: #f8f9fa; }
        body.light .settings-section { border-color: #dee2e6; }
        
        #theme-toggle { position: fixed; top: 1rem; right: 1rem; z-index: 1000; padding: 0.5rem 1rem; background: #4d94ff; color: white; border: none; border-radius: 6px; cursor: pointer; }
        body.light #theme-toggle { background: #007bff; }
        input[type="file"] { display: none; }
    </style>
</head>
<body class="dark">

    <button id="theme-toggle">‚òÄÔ∏è Light</button>

    <div class="loading-indicator" id="loadingIndicator">
        <div>‚è≥ Updating prices...</div>
    </div>

    <h1>Passive Income</h1>
    <div class="meta" id="lastUpdate" style="margin-bottom:5px;">Never updated</div>
    <div class="next-update" id="nextUpdate">Next auto-update: calculating...</div>

    <div id="errorContainer"></div>

    <div class="card">
        <div class="label">Portfolio Value <span id="filterLabel" style="text-transform:none;">(All)</span></div>
        <div class="value" id="totalValue">0 DKK</div>
        <div class="change" id="totalChange">‚Äî</div>
    </div>

    <div class="card">
        <div class="label">Annual Income <span id="incomeFilterLabel" style="text-transform:none;">(All)</span></div>
        <div class="value" id="annualIncome">0 DKK</div>
        <div class="change"><span id="yieldPercent">0.0%</span> yield</div>
    </div>

    <div class="card" id="allocation-card">
        <h3 style="margin-bottom: 15px;">Portfolio Allocation</h3>
        <div class="chart-container">
            <canvas id="allocationChart"></canvas>
        </div>
    </div>

    <div class="filter-tabs">
        <div class="filter-tab active" data-filter="all">All</div>
        <div class="filter-tab" data-filter="stock">Stocks</div>
        <div class="filter-tab" data-filter="fund">Funds</div>
        <div class="filter-tab" data-filter="rsu">RSU</div>
        <div class="filter-tab" data-filter="stock,fund">Stocks + Funds</div>
        <div class="filter-tab" data-filter="stock,rsu">Stocks + RSU</div>
        <div class="filter-tab" data-filter="fund,rsu">Funds + RSU</div>
    </div>

    <div class="section-title">
        <span>HOLDINGS</span>
        <button class="btn btn-small" id="addBtn">+ Add</button>
    </div>

    <div style="margin: 1rem 0; display: flex; gap: 1rem; flex-wrap: wrap;">
        <input type="text" id="searchInput" placeholder="Search by name/ticker..." style="padding: 0.5rem; flex: 1; min-width: 200px;">
        <select id="sortSelect" style="width: auto; min-width: 150px;">
            <option value="value-desc">Value (High ‚Üí Low)</option>
            <option value="value-asc">Value (Low ‚Üí High)</option>
            <option value="yield-desc">Yield (High ‚Üí Low)</option>
            <option value="name">Name (A-Z)</option>
        </select>
    </div>

    <div id="holdings"></div>

    <!-- Chat Container -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <h3>üí∞ Passive Income Advisor</h3>
            <button class="close" id="closeChatBtn">√ó</button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="chat-message assistant">
                üëã Hi! I'm your passive income investment advisor. I can help you with:
                <ul>
                    <li>Portfolio diversification strategies</li>
                    <li>Dividend analysis & optimization</li>
                    <li>Long-term wealth building advice</li>
                    <li>Risk assessment</li>
                </ul>
                Ask me anything about your investments!
            </div>
        </div>
        <div class="chat-input-container">
            <input type="text" class="chat-input" id="chatInput" placeholder="Ask about your portfolio...">
            <button class="chat-send-btn" id="chatSendBtn">Send</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Settings</h2>
                <button class="close" id="closeSettingsBtn">√ó</button>
            </div>

            <div class="settings-section">
                <h4>OpenRouter API Key 
                    <span class="key-status" id="openrouterKeyStatus">Not configured</span>
                </h4>
                <div class="info-text">
                    Required for AI chat advisor. Get your free key at <a href="https://openrouter.ai/keys" target="_blank" style="color:#4d94ff;">openrouter.ai/keys</a>
                    <br>OpenRouter provides access to Claude and other models with browser support.
                </div>
                <input type="password" id="openrouterApiKeyInput" placeholder="sk-or-v1-...">
                <div class="warning-text">‚ö†Ô∏è Your API key is stored locally in your browser only. Never shared.</div>
                <button class="btn btn-secondary" id="saveOpenrouterKey">Save API Key</button>
                <button class="btn btn-secondary" id="removeOpenrouterKey" style="background:#ff4466;display:none;">Remove API Key</button>
            </div>

            <div class="settings-section">
                <h4>Data Management</h4>
                <button class="btn btn-secondary" id="clearAllData">Clear All Portfolio Data</button>
                <div class="warning-text">‚ö†Ô∏è This will delete all your holdings and settings. Export first!</div>
            </div>
        </div>
    </div>

    <!-- Modal for adding holdings -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add Holding</h2>
                <button class="close" id="closeBtn">√ó</button>
            </div>

            <label>Type</label>
            <select id="type">
                <option value="stock">Stock (auto-updates)</option>
                <option value="fund">Fund (manual only)</option>
                <option value="rsu">RSU (auto-updates)</option>
            </select>

            <div id="tickerField">
                <label>Ticker Symbol</label>
                <input type="text" id="ticker" placeholder="e.g., ASTK.CO, FLYW, IBE.MC">
            </div>

            <label>Name</label>
            <input type="text" id="name" placeholder="e.g., Asetek A/S">

            <label>Shares / Units</label>
            <input type="number" step="0.01" id="shares">

            <label>Average Cost per Share/Unit</label>
            <div class="currency-row">
                <input type="number" step="0.01" id="cost">
                <select id="costCurrency">
                    <option value="DKK">DKK</option>
                    <option value="EUR">EUR</option>
                    <option value="USD">USD</option>
                </select>
            </div>

            <div id="currentPriceField">
                <label>Current Price <span id="priceLabel">(required for funds, optional backup for others)</span></label>
                <div class="info-text" id="priceInfoStock" style="display:block;">
                    Stocks/RSU: Auto-updates via EODHD Intraday API. Enter manually only as backup.
                </div>
                <div class="info-text" id="priceInfoFund" style="display:none;">
                    Funds: Required field - will NOT auto-update. Must be > 0.
                </div>
                <div class="currency-row">
                    <input type="number" step="0.01" id="currentPrice" placeholder="Required for funds, optional for stocks/RSU">
                    <select id="priceCurrency">
                        <option value="DKK">DKK</option>
                        <option value="EUR">EUR</option>
                        <option value="USD">USD</option>
                    </select>
                </div>
            </div>

            <label>Annual Dividend/Distribution per Share</label>
            <div class="currency-row">
                <input type="number" step="0.01" id="dividend" placeholder="0 if none">
                <select id="dividendCurrency">
                    <option value="DKK">DKK</option>
                    <option value="EUR">EUR</option>
                    <option value="USD">USD</option>
                </select>
            </div>

            <button class="btn" id="saveBtn">Save</button>
            <button class="btn" id="deleteBtn" style="display:none; background:#ff4466; margin-top:10px;">Delete</button>
        </div>
    </div>

    <div class="bottom-nav">
        <button class="nav-btn" id="dashBtn">Dashboard</button>
        <button class="nav-btn" id="refreshBtn">‚Üª Refresh</button>
        <button class="nav-btn" id="chatBtn">üí¨ Chat</button>
        <button class="nav-btn" id="exportBtn">Export</button>
        <button class="nav-btn" id="importBtn">Import</button>
        <button class="nav-btn" id="settingsBtn">‚öôÔ∏è</button>
    </div>

    <input type="file" id="importFile" accept=".json">

    <script>
        // API KEYS
        const EODHD_API_KEY = '698fa6d0d113a5.96289084';
        const TWELVEDATA_API_KEY = 'f4faaf5fc1f149eeb9364b8065b8298b';
        
        function getOpenRouterApiKey() {
            return localStorage.getItem('openrouter_api_key') || null;
        }

        let data = JSON.parse(localStorage.getItem('portfolio') || '{"holdings":[],"lastUpdate":null,"lastScheduledUpdate":null}');
        let editing = null;
        let isRefreshing = false;
        let activeFilter = 'all';
        let searchTerm = '';
        let sortBy = 'value-desc';
        let fetchErrors = [];
        let chatHistory = [];

        let exchangeRates = { DKK: 1, EUR: 7.46, USD: 6.88 };
        let allocationChart = null;

        // SETTINGS MODAL
        function showSettingsModal() {
            updateSettingsUI();
            document.getElementById('settingsModal').classList.add('show');
        }

        function hideSettingsModal() {
            document.getElementById('settingsModal').classList.remove('show');
        }

        function updateSettingsUI() {
            const apiKey = getOpenRouterApiKey();
            const statusEl = document.getElementById('openrouterKeyStatus');
            const removeBtn = document.getElementById('removeOpenrouterKey');
            const inputEl = document.getElementById('openrouterApiKeyInput');
            
            if (apiKey) {
                statusEl.textContent = '‚úì Configured';
                statusEl.className = 'key-status configured';
                removeBtn.style.display = 'block';
                inputEl.placeholder = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
            } else {
                statusEl.textContent = '‚úó Not configured';
                statusEl.className = 'key-status missing';
                removeBtn.style.display = 'none';
                inputEl.placeholder = 'sk-or-v1-...';
            }
        }

        // SETTINGS EVENT LISTENERS - FIXED
        setTimeout(() => {
            document.getElementById('settingsBtn').onclick = showSettingsModal;
            document.getElementById('closeSettingsBtn').onclick = hideSettingsModal;

            document.getElementById('saveOpenrouterKey').onclick = () => {
                const keyInput = document.getElementById('openrouterApiKeyInput');
                const key = keyInput.value.trim();
                
                if (!key) {
                    alert('Please enter an API key');
                    return;
                }
                
                if (!key.startsWith('sk-or-')) {
                    alert('Invalid OpenRouter API key format. Should start with "sk-or-"');
                    return;
                }
                
                localStorage.setItem('openrouter_api_key', key);
                keyInput.value = '';
                updateSettingsUI();
                alert('‚úÖ API key saved successfully!');
            };

            document.getElementById('removeOpenrouterKey').onclick = () => {
                if (confirm('Remove your OpenRouter API key? Chat advisor will stop working.')) {
                    localStorage.removeItem('openrouter_api_key');
                    updateSettingsUI();
                    alert('‚úÖ API key removed');
                }
            };

            document.getElementById('clearAllData').onclick = () => {
                if (confirm('‚ö†Ô∏è Delete ALL portfolio data? This cannot be undone!\n\nMake sure you have exported your data first.')) {
                    if (confirm('Are you absolutely sure? This will delete all your holdings and settings.')) {
                        localStorage.clear();
                        location.reload();
                    }
                }
            };
        }, 100);

        // DATA MIGRATION
        function migrateData() {
            let migrated = false;
            data.holdings = data.holdings.map(h => {
                if (h.price !== undefined && h.currentPrice === undefined) {
                    h.currentPrice = h.priceOriginal || h.price;
                    delete h.price;
                    delete h.priceOriginal;
                    migrated = true;
                }
                if (!h.priceCurrency) h.priceCurrency = h.costCurrency || 'DKK';
                if (!h.dividendCurrency) h.dividendCurrency = h.costCurrency || 'DKK';
                if (!h.costCurrency) h.costCurrency = 'DKK';
                return h;
            });
            if (migrated) {
                localStorage.setItem('portfolio', JSON.stringify(data));
                console.log('‚úÖ Data migrated');
            }
        }

        // EXCHANGE RATES
        async function updateExchangeRates() {
            try {
                const res = await fetch('https://api.frankfurter.app/latest?from=DKK&to=EUR,USD');
                if (!res.ok) throw new Error();
                const json = await res.json();
                exchangeRates.EUR = 1 / (json.rates.EUR || 0.134);
                exchangeRates.USD = 1 / (json.rates.USD || 0.145);
                console.log('‚úÖ Rates updated:', exchangeRates);
            } catch (e) {
                console.warn('‚ö†Ô∏è Using fallback rates');
            }
        }

        function convertToDKK(amount, currency) {
            return (amount || 0) * (exchangeRates[currency] || 1);
        }

        // SCHEDULED UPDATES
        function getNextUpdateTime() {
            const now = new Date();
            let cet = new Date(now.getTime() + (now.getTimezoneOffset() + 60) * 60000);
            let h = cet.getHours();
            let next = new Date(cet);
            if (h < 8) next.setHours(8,0,0,0);
            else if (h < 22) next.setHours(22,0,0,0);
            else { next.setDate(next.getDate()+1); next.setHours(8,0,0,0); }
            return new Date(next.getTime() - (now.getTimezoneOffset() + 60) * 60000);
        }

        function updateNextUpdateDisplay() {
            const next = getNextUpdateTime();
            const diffMs = next - Date.now();
            const h = Math.floor(diffMs / 3600000);
            const m = Math.floor((diffMs % 3600000) / 60000);
            const timeStr = next.toLocaleTimeString('da-DK', {hour:'2-digit', minute:'2-digit'});
            let text = h < 1 ? `in ${m} min` : h < 24 ? `in ${h}h ${m}m` : `tomorrow`;
            document.getElementById('nextUpdate').textContent = `Next auto-update ${text} at ${timeStr}`;
        }

        function checkAutoUpdate() {
            const now = new Date();
            const cet = new Date(now.getTime() + (now.getTimezoneOffset() + 60) * 60000);
            const hour = cet.getHours();
            const minute = cet.getMinutes();
            
            if ((hour === 8 || hour === 22) && minute < 5) {
                const lastUpdate = data.lastScheduledUpdate;
                const todayKey = cet.toISOString().split('T')[0] + '-' + hour;
                
                if (lastUpdate !== todayKey) {
                    console.log('‚è∞ Scheduled update at', hour + ':00 CET');
                    data.lastScheduledUpdate = todayKey;
                    localStorage.setItem('portfolio', JSON.stringify(data));
                    refreshPrices();
                }
            }
        }

        // THEME
        const themeToggle = document.getElementById('theme-toggle');
        let currentTheme = localStorage.getItem('theme') || 'dark';
        document.body.className = currentTheme;
        themeToggle.textContent = currentTheme === 'dark' ? '‚òÄÔ∏è Light' : 'üåô Dark';
        themeToggle.onclick = () => {
            document.body.classList.toggle('dark');
            document.body.classList.toggle('light');
            currentTheme = document.body.classList.contains('dark') ? 'dark' : 'light';
            localStorage.setItem('theme', currentTheme);
            themeToggle.textContent = currentTheme === 'dark' ? '‚òÄÔ∏è Light' : 'üåô Dark';
        };

        // PRICE FETCHING - CORRECTED FOR GLOBAL STOCKS USING INTRADAY ENDPOINT
        async function fetchPriceForHolding(h) {
            if (h.type === 'fund' || !h.ticker) return;

            const symbol = h.ticker.toUpperCase();
            let fetched = false;

            // Try EODHD INTRADAY endpoint (supports .CO, .MC, and other global exchanges)
            if (EODHD_API_KEY) {
                try {
                    const url = `https://eodhd.com/api/intraday/${symbol}?api_token=${EODHD_API_KEY}&fmt=json&interval=1m`;
                    const response = await fetch(url);
                    
                    if (response.ok) {
                        const json = await response.json();
                        
                        let price = 0;
                        
                        // Intraday endpoint returns an array of OHLCV data
                        if (Array.isArray(json) && json.length > 0) {
                            const latestData = json[json.length - 1];
                            price = latestData.close || latestData.open || 0;
                        }
                        
                        if (price > 0) {
                            h.currentPrice = price;
                            
                            // Determine currency based on exchange
                            if (symbol.endsWith('.CO')) {
                                h.priceCurrency = 'DKK';
                            } else if (symbol.endsWith('.MC')) {
                                h.priceCurrency = 'EUR';
                            } else if (symbol.endsWith('.L')) {
                                h.priceCurrency = 'GBP';
                            } else if (symbol.endsWith('.PA')) {
                                h.priceCurrency = 'EUR';
                            } else if (symbol.endsWith('.DE')) {
                                h.priceCurrency = 'EUR';
                            } else {
                                h.priceCurrency = 'USD';
                            }
                            
                            h.fetchError = false;
                            fetched = true;
                            console.log(`‚úÖ ${symbol}: ${price} ${h.priceCurrency} (EODHD Intraday)`);
                        }
                    }
                } catch (e) {
                    console.warn(`‚ö†Ô∏è EODHD Intraday failed for ${symbol}:`, e.message);
                }
            }

            // Fallback to Twelve Data
            if (!fetched && TWELVEDATA_API_KEY) {
                try {
                    let tdSymbol = symbol;
                    
                    if (symbol.endsWith('.CO')) tdSymbol = symbol.replace('.CO', ':XCSE');
                    else if (symbol.endsWith('.MC')) tdSymbol = symbol.replace('.MC', ':BME');
                    else if (symbol.endsWith('.L')) tdSymbol = symbol.replace('.L', ':LSE');
                    else if (symbol.endsWith('.PA')) tdSymbol = symbol.replace('.PA', ':EPA');
                    else if (symbol.endsWith('.DE')) tdSymbol = symbol.replace('.DE', ':XETRA');
                    
                    const url = `https://api.twelvedata.com/quote?symbol=${tdSymbol}&apikey=${TWELVEDATA_API_KEY}`;
                    const response = await fetch(url);
                    
                    if (response.ok) {
                        const json = await response.json();
                        if (json.status !== 'error' && json.close) {
                            let price = parseFloat(json.close) || parseFloat(json.previous_close) || 0;
                            if (price > 0) {
                                h.currentPrice = price;
                                h.priceCurrency = json.currency || 'USD';
                                h.fetchError = false;
                                fetched = true;
                                console.log(`‚úÖ ${symbol}: ${price} ${h.priceCurrency} (TwelveData)`);
                            }
                        }
                    }
                } catch (e) {
                    console.warn(`‚ö†Ô∏è TwelveData failed for ${symbol}:`, e.message);
                }
            }

            if (!fetched) {
                h.fetchError = true;
                fetchErrors.push(`${h.name} (${symbol}): Auto-fetch failed - using ${h.manualPrice ? 'manual' : 'cost basis'} price`);
                console.error(`‚ùå ${symbol}: All APIs failed`);
            }
        }

        async function refreshPrices() {
            if (isRefreshing) return;
            isRefreshing = true;
            fetchErrors = [];
            
            document.getElementById('loadingIndicator').classList.add('show');
            document.getElementById('refreshBtn').textContent = 'Updating...';
            document.getElementById('refreshBtn').disabled = true;

            await updateExchangeRates();

            const stocksToFetch = data.holdings.filter(h => h.type !== 'fund' && h.ticker);
            await Promise.all(stocksToFetch.map(h => fetchPriceForHolding(h)));

            data.lastUpdate = new Date().toISOString();
            localStorage.setItem('portfolio', JSON.stringify(data));

            showFetchErrors();
            render();
            
            document.getElementById('loadingIndicator').classList.remove('show');
            document.getElementById('refreshBtn').textContent = '‚Üª Refresh';
            document.getElementById('refreshBtn').disabled = false;
            isRefreshing = false;
        }

        function showFetchErrors() {
            const container = document.getElementById('errorContainer');
            if (fetchErrors.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            let html = '<div class="error-list"><strong>‚ö†Ô∏è Some prices failed to update:</strong>';
            fetchErrors.forEach(err => {
                html += `<div class="error-item">‚Ä¢ ${err}</div>`;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        // VALUE CALCULATION
        function getHoldingValue(h) {
            let price = 0;
            if (h.type === 'fund') {
                price = h.manualPrice || 0;
            } else {
                price = h.currentPrice || h.manualPrice || h.cost;
            }
            return h.shares * convertToDKK(price, h.priceCurrency || h.costCurrency || 'DKK');
        }

        // CHAT FUNCTIONALITY
        function toggleChat() {
            const apiKey = getOpenRouterApiKey();
            if (!apiKey) {
                if (confirm('Chat requires an OpenRouter API key. Would you like to add one now?')) {
                    showSettingsModal();
                }
                return;
            }
            
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.classList.toggle('show');
            if (chatContainer.classList.contains('show')) {
                document.getElementById('chatInput').focus();
            }
        }

        function getPortfolioContext() {
            const filtered = data.holdings;
            let totalValue = 0, totalCost = 0, annualIncome = 0;
            
            const holdings = filtered.map(h => {
                const value = getHoldingValue(h);
                const cost = convertToDKK(h.cost * h.shares, h.costCurrency);
                const income = convertToDKK((h.dividend||0) * h.shares, h.dividendCurrency || 'DKK');
                totalValue += value;
                totalCost += cost;
                annualIncome += income;
                
                const yld = value > 0 ? (income / value * 100) : 0;
                
                return {
                    name: h.name,
                    type: h.type,
                    shares: h.shares,
                    value: Math.round(value),
                    cost: Math.round(cost),
                    annualIncome: Math.round(income),
                    yield: yld.toFixed(2) + '%'
                };
            });
            
            const yieldPct = totalValue > 0 ? (annualIncome / totalValue * 100) : 0;
            
            return {
                totalValue: Math.round(totalValue),
                totalCost: Math.round(totalCost),
                totalGain: Math.round(totalValue - totalCost),
                gainPercent: totalCost > 0 ? ((totalValue - totalCost) / totalCost * 100).toFixed(1) : 0,
                annualIncome: Math.round(annualIncome),
                portfolioYield: yieldPct.toFixed(2) + '%',
                holdings: holdings,
                holdingsCount: holdings.length
            };
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;
            
            const apiKey = getOpenRouterApiKey();
            if (!apiKey) {
                addChatMessage('assistant', '‚ö†Ô∏è Please configure your OpenRouter API key in Settings to use the chat feature.');
                return;
            }
            
            addChatMessage('user', message);
            input.value = '';
            
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.innerHTML = '<span></span><span></span><span></span>';
            document.getElementById('chatMessages').appendChild(typingDiv);
            typingDiv.scrollIntoView({ behavior: 'smooth' });
            
            const sendBtn = document.getElementById('chatSendBtn');
            sendBtn.disabled = true;
            
            try {
                const portfolio = getPortfolioContext();
                
                const systemPrompt = `You are a passive income investment advisor focused on long-term wealth building through dividend-paying stocks, index funds, and income-generating assets.

Portfolio Context:
- Total Value: ${portfolio.totalValue.toLocaleString()} DKK
- Annual Income: ${portfolio.annualIncome.toLocaleString()} DKK
- Portfolio Yield: ${portfolio.portfolioYield}
- Total Gain: ${portfolio.totalGain.toLocaleString()} DKK (${portfolio.gainPercent}%)
- Holdings: ${portfolio.holdingsCount} positions

Holdings:
${portfolio.holdings.map(h => `- ${h.name} (${h.type}): ${h.value.toLocaleString()} DKK, ${h.annualIncome.toLocaleString()} DKK/yr (${h.yield} yield)`).join('\n')}

Guidelines:
- Focus on long-term passive income generation
- Emphasize dividend growth and stability
- Encourage diversification across sectors and geographies
- Warn against chasing high yields without fundamentals
- Promote the power of compounding dividends
- Discourage frequent trading and market timing
- Be supportive and educational, not prescriptive
- Keep responses concise (2-3 short paragraphs max)
- Use bullet points when listing recommendations`;

                const messages = [
                    { role: 'system', content: systemPrompt },
                    ...chatHistory,
                    { role: 'user', content: message }
                ];
                
                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.href,
                        'X-Title': 'Passive Income Portfolio'
                    },
                    body: JSON.stringify({
                        model: 'anthropic/claude-3.5-sonnet',
                        messages: messages,
                        max_tokens: 1024
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'API request failed');
                }
                
                const result = await response.json();
                const assistantMessage = result.choices[0].message.content;
                
                chatHistory.push({ role: 'user', content: message });
                chatHistory.push({ role: 'assistant', content: assistantMessage });
                
                if (chatHistory.length > 20) {
                    chatHistory = chatHistory.slice(-20);
                }
                
                typingDiv.remove();
                addChatMessage('assistant', assistantMessage);
                
            } catch (error) {
                typingDiv.remove();
                addChatMessage('assistant', `‚ùå Error: ${error.message}. Please check your API key in Settings.`);
                console.error('Chat error:', error);
            }
            
            sendBtn.disabled = false;
        }

        function addChatMessage(role, content) {
            const messagesDiv = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}`;
            
            let formattedContent = content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n- /g, '<br>‚Ä¢ ')
                .replace(/\n\n/g, '<br><br>');
            
            messageDiv.innerHTML = formattedContent;
            messagesDiv.appendChild(messageDiv);
            messageDiv.scrollIntoView({ behavior: 'smooth' });
        }

        // FILTERING & SORTING
        function getFilteredAndSortedHoldings() {
            let holdings = data.holdings.filter(h => {
                if (activeFilter === 'all') return true;
                return activeFilter.split(',').includes(h.type);
            });

            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                holdings = holdings.filter(h => 
                    h.name.toLowerCase().includes(term) || 
                    (h.ticker && h.ticker.toLowerCase().includes(term))
                );
            }

            if (sortBy === 'value-desc') {
                holdings.sort((a,b) => getHoldingValue(b) - getHoldingValue(a));
            } else if (sortBy === 'value-asc') {
                holdings.sort((a,b) => getHoldingValue(a) - getHoldingValue(b));
            } else if (sortBy === 'yield-desc') {
                holdings.sort((a,b) => {
                    const va = getHoldingValue(a), vb = getHoldingValue(b);
                    const ya = va > 0 ? convertToDKK((a.dividend||0)*a.shares, a.dividendCurrency||'DKK') / va : 0;
                    const yb = vb > 0 ? convertToDKK((b.dividend||0)*b.shares, b.dividendCurrency||'DKK') / vb : 0;
                    return yb - ya;
                });
            } else {
                holdings.sort((a,b) => a.name.localeCompare(b.name));
            }

            return holdings;
        }

        // ALLOCATION CHART
        function renderAllocationChart(filtered) {
            const ctx = document.getElementById('allocationChart')?.getContext('2d');
            if (!ctx) return;

            const types = {};
            let total = 0;
            filtered.forEach(h => { 
                const v = getHoldingValue(h); 
                types[h.type] = (types[h.type] || 0) + v; 
                total += v; 
            });

            const labels = Object.keys(types).map((type, i) => {
                const value = types[type];
                const pct = total > 0 ? (value / total * 100).toFixed(1) : 0;
                return `${type.charAt(0).toUpperCase() + type.slice(1)} (${pct}%)`;
            });
            const dataPoints = Object.values(types);

            if (allocationChart) {
                allocationChart.data.labels = labels;
                allocationChart.data.datasets[0].data = dataPoints;
                allocationChart.update('none');
            } else {
                allocationChart = new Chart(ctx, {
                    type: 'pie',
                    data: { 
                        labels: labels, 
                        datasets: [{ 
                            data: dataPoints, 
                            backgroundColor: ['#36A2EB','#FF6384','#FFCE56','#4BC0C0','#9966FF','#FF9F40'] 
                        }] 
                    },
                    options: { 
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: { 
                            legend: { position: 'bottom' }, 
                            tooltip: { 
                                callbacks: { 
                                    label: ctx => `${Math.round(ctx.raw).toLocaleString('da-DK')} DKK`
                                } 
                            } 
                        } 
                    }
                });
            }
        }

        // RENDER
        function render() {
            const filtered = getFilteredAndSortedHoldings();

            let totalValue = 0, totalCost = 0, annualIncome = 0;

            filtered.forEach(h => {
                const value = getHoldingValue(h);
                const cost = convertToDKK(h.cost * h.shares, h.costCurrency);
                const income = convertToDKK((h.dividend||0) * h.shares, h.dividendCurrency || 'DKK');
                totalValue += value;
                totalCost += cost;
                annualIncome += income;
            });

            const change = totalValue - totalCost;
            const changePct = totalCost ? (change / totalCost * 100) : 0;
            const yieldPct = totalValue ? (annualIncome / totalValue * 100) : 0;

            document.getElementById('totalValue').textContent = Math.round(totalValue).toLocaleString('da-DK') + ' DKK';
            
            const changeEl = document.getElementById('totalChange');
            changeEl.textContent = (change >= 0 ? '+' : '') + Math.round(change).toLocaleString('da-DK') + ' DKK (' + changePct.toFixed(1) + '%)';
            changeEl.className = 'change ' + (change >= 0 ? 'positive' : change < 0 ? 'negative' : '');

            document.getElementById('annualIncome').textContent = Math.round(annualIncome).toLocaleString('da-DK') + ' DKK';
            document.getElementById('yieldPercent').textContent = yieldPct.toFixed(2) + '%';

            const lbl = activeFilter === 'all' ? 'All' : activeFilter.split(',').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' + ');
            document.getElementById('filterLabel').textContent = `(${lbl})`;
            document.getElementById('incomeFilterLabel').textContent = `(${lbl})`;

            const container = document.getElementById('holdings');
            container.innerHTML = '';

            if (filtered.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:40px;color:#9ba5b8;">No holdings found</div>';
            } else {
                filtered.forEach(h => {
                    const div = document.createElement('div');
                    div.className = 'holding';
                    div.onclick = () => editHolding(data.holdings.indexOf(h));

                    const value = getHoldingValue(h);
                    const cost = convertToDKK(h.cost * h.shares, h.costCurrency);
                    const chg = value - cost;
                    const chgPct = cost ? chg / cost * 100 : 0;
                    const inc = convertToDKK((h.dividend||0) * h.shares, h.dividendCurrency || 'DKK');
                    const yld = value ? inc / value * 100 : 0;

                    let status = '';
                    if (h.type === 'fund') {
                        status = '<span class="status manual-price">üíº Fund - manual price</span>';
                    } else if (h.fetchError) {
                        status = '<span class="status failed">‚ö†Ô∏è Fetch failed - using ' + (h.manualPrice ? 'manual' : 'cost basis') + '</span>';
                    } else if (h.currentPrice) {
                        status = '<span class="status live">‚úì Live price</span>';
                    }

                    const badge = h.type === 'fund' ? ' <span class="fund-badge">FUND</span>' : h.type === 'rsu' ? ' <span class="fund-badge">RSU</span>' : '';

                    div.innerHTML = `
                        <div class="holding-header">
                            <span class="ticker">${h.name}${badge}</span>
                            <span class="value">${Math.round(value).toLocaleString('da-DK')} DKK</span>
                        </div>
                        <div class="meta">${h.shares} shares @ ${h.cost.toFixed(2)} ${h.costCurrency} = ${Math.round(cost).toLocaleString('da-DK')} DKK cost</div>
                        <div class="meta">Income: ${Math.round(inc).toLocaleString('da-DK')} DKK/yr (${yld.toFixed(1)}% yield)</div>
                        <div class="meta ${chg>0?'positive':chg<0?'negative':''}">
                            ${(chg>=0?'+':'') + Math.round(chg).toLocaleString('da-DK')} DKK (${chgPct.toFixed(1)}%)
                        </div>
                        ${status}
                    `;
                    container.appendChild(div);
                });
            }

            renderAllocationChart(filtered);

            if (data.lastUpdate) {
                const d = new Date(data.lastUpdate);
                document.getElementById('lastUpdate').textContent = 'Last update: ' + d.toLocaleString('da-DK');
            }

            updateNextUpdateDisplay();
        }

        // MODAL FUNCTIONS
        function showModal() { document.getElementById('modal').classList.add('show'); }
        function hideModal() { document.getElementById('modal').classList.remove('show'); }

        function clearForm() {
            document.getElementById('type').value = 'stock';
            document.getElementById('ticker').value = '';
            document.getElementById('name').value = '';
            document.getElementById('shares').value = '';
            document.getElementById('cost').value = '';
            document.getElementById('costCurrency').value = 'DKK';
            document.getElementById('currentPrice').value = '';
            document.getElementById('priceCurrency').value = 'DKK';
            document.getElementById('dividend').value = '0';
            document.getElementById('dividendCurrency').value = 'DKK';
            document.getElementById('deleteBtn').style.display = 'none';
            togglePriceInfo();
        }

        function editHolding(idx) {
            editing = idx;
            const h = data.holdings[idx];
            document.getElementById('modalTitle').textContent = 'Edit Holding';
            document.getElementById('type').value = h.type;
            document.getElementById('ticker').value = h.ticker || '';
            document.getElementById('name').value = h.name;
            document.getElementById('shares').value = h.shares;
            document.getElementById('cost').value = h.cost;
            document.getElementById('costCurrency').value = h.costCurrency || 'DKK';
            document.getElementById('currentPrice').value = h.manualPrice || '';
            document.getElementById('priceCurrency').value = h.priceCurrency || 'DKK';
            document.getElementById('dividend').value = h.dividend || 0;
            document.getElementById('dividendCurrency').value = h.dividendCurrency || 'DKK';
            document.getElementById('deleteBtn').style.display = 'block';
            togglePriceInfo();
            showModal();
        }

        function saveHolding() {
            const type = document.getElementById('type').value;
            const ticker = document.getElementById('ticker').value.trim().toUpperCase();
            const name = document.getElementById('name').value.trim();
            const shares = parseFloat(document.getElementById('shares').value) || 0;
            const cost = parseFloat(document.getElementById('cost').value) || 0;
            const costCur = document.getElementById('costCurrency').value;
            const manPrice = parseFloat(document.getElementById('currentPrice').value) || 0;
            const priceCur = document.getElementById('priceCurrency').value;
            const div = parseFloat(document.getElementById('dividend').value) || 0;
            const divCur = document.getElementById('dividendCurrency').value;

            if (!name || shares <= 0 || cost <= 0) {
                alert('Name, Shares >0 and Cost >0 required.');
                return;
            }
            if (type !== 'fund' && !ticker) {
                alert('Ticker required for stocks/RSU.');
                return;
            }
            if (type === 'fund' && manPrice <= 0) {
                alert('Current price required for funds and must be > 0.');
                return;
            }

            const holding = {
                type,
                ticker: type !== 'fund' ? ticker : undefined,
                name,
                shares,
                cost,
                costCurrency: costCur,
                manualPrice: manPrice > 0 ? manPrice : undefined,
                priceCurrency: priceCur,
                dividend: div,
                dividendCurrency: divCur,
                currentPrice: undefined,
                fetchError: false
            };

            if (editing !== null) {
                const old = data.holdings[editing];
                if (old.currentPrice && type !== 'fund') {
                    holding.currentPrice = old.currentPrice;
                }
                data.holdings[editing] = holding;
                editing = null;
            } else {
                data.holdings.push(holding);
            }

            localStorage.setItem('portfolio', JSON.stringify(data));
            hideModal();
            clearForm();
            render();
            
            if (type !== 'fund' && ticker) {
                const h = data.holdings[data.holdings.length - 1];
                fetchPriceForHolding(h).then(() => {
                    localStorage.setItem('portfolio', JSON.stringify(data));
                    render();
                });
            }
        }

        function deleteHolding() {
            if (!confirm('Delete this holding?')) return;
            data.holdings.splice(editing, 1);
            localStorage.setItem('portfolio', JSON.stringify(data));
            hideModal();
            clearForm();
            render();
        }

        function togglePriceInfo() {
            const isFund = document.getElementById('type').value === 'fund';
            document.getElementById('tickerField').style.display = isFund ? 'none' : 'block';
            document.getElementById('priceInfoStock').style.display = isFund ? 'none' : 'block';
            document.getElementById('priceInfoFund').style.display = isFund ? 'block' : 'none';
            document.getElementById('currentPrice').placeholder = isFund ? 'Required for funds (>0)' : 'Optional (auto-fetch preferred)';
        }

        // EXPORT / IMPORT
        function exportData() {
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'portfolio-' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            document.getElementById('importFile').click();
        }

        // EVENT LISTENERS - ALL FIXED
        document.getElementById('addBtn').onclick = () => { editing = null; clearForm(); showModal(); };
        document.getElementById('closeBtn').onclick = hideModal;
        document.getElementById('saveBtn').onclick = saveHolding;
        document.getElementById('deleteBtn').onclick = deleteHolding;
        document.getElementById('refreshBtn').onclick = refreshPrices;
        document.getElementById('exportBtn').onclick = exportData;
        document.getElementById('importBtn').onclick = importData;
        document.getElementById('chatBtn').onclick = toggleChat;
        document.getElementById('closeChatBtn').onclick = toggleChat;
        document.getElementById('type').onchange = togglePriceInfo;
        
        document.getElementById('chatSendBtn').onclick = sendChatMessage;
        document.getElementById('chatInput').onkeypress = (e) => {
            if (e.key === 'Enter') sendChatMessage();
        };

        document.getElementById('importFile').onchange = function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const imported = JSON.parse(event.target.result);
                    if (!imported.holdings || !Array.isArray(imported.holdings)) {
                        alert('Invalid portfolio file format');
                        return;
                    }
                    
                    if (confirm(`Import ${imported.holdings.length} holdings? This will replace your current portfolio.`)) {
                        data = imported;
                        migrateData();
                        localStorage.setItem('portfolio', JSON.stringify(data));
                        render();
                        alert('‚úÖ Portfolio imported successfully!');
                    }
                } catch (err) {
                    alert('Error reading file: ' + err.message);
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        };

        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.onclick = () => {
                document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                activeFilter = tab.dataset.filter;
                render();
            };
        });

        document.getElementById('searchInput').oninput = e => { searchTerm = e.target.value; render(); };
        document.getElementById('sortSelect').onchange = e => { sortBy = e.target.value; render(); };

        // INITIALIZATION
        migrateData();
        updateExchangeRates();
        checkAutoUpdate();
        render();
        setInterval(checkAutoUpdate, 60000);
        setInterval(updateNextUpdateDisplay, 60000);
    </script>
</body>
</html>
