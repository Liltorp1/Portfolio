<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passive Income Portfolio</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #0a0e1a; color: #e8edf4; padding: 20px 20px 100px; min-height: 100vh; }
        h1 { font-size: 28px; margin-bottom: 10px; }
        .card { background: #1a2237; border: 1px solid #2a3550; border-radius: 12px; padding: 20px; margin-bottom: 15px; }
        .label { font-size: 12px; color: #9ba5b8; text-transform: uppercase; margin-bottom: 8px; }
        .value { font-size: 32px; font-weight: 300; margin-bottom: 5px; }
        .change { font-size: 14px; color: #9ba5b8; }
        .positive { color: #00ff88; }
        .negative { color: #ff4466; }
        .btn { background: #4d94ff; color: white; border: none; border-radius: 10px; padding: 14px 24px; font-size: 16px; width: 100%; cursor: pointer; }
        .btn:active { opacity: 0.8; }
        .btn-small { width: auto; padding: 10px 20px; font-size: 14px; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); padding: 20px; overflow-y: auto; z-index: 1000; }
        .modal.show { display: block; }
        .modal-content { background: #1a2237; border-radius: 16px; padding: 24px; max-width: 500px; margin: 40px auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close { font-size: 30px; color: #9ba5b8; cursor: pointer; background: none; border: none; }
        input, select, textarea { width: 100%; background: #0a0e1a; border: 1px solid #2a3550; border-radius: 8px; padding: 12px; color: #e8edf4; font-size: 16px; margin-bottom: 15px; font-family: inherit; }
        textarea { min-height: 60px; resize: vertical; }
        label { display: block; font-size: 14px; color: #9ba5b8; margin-bottom: 5px; }
        .holding { background: #1a2237; border: 1px solid #2a3550; border-radius: 10px; padding: 15px; margin-bottom: 10px; cursor: pointer; }
        .holding:active { background: #202840; }
        .holding-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .holding-name { font-size: 18px; font-weight: 600; }
        .meta { font-size: 12px; color: #9ba5b8; margin-top: 4px; }
        .section-title { font-size: 12px; text-transform: uppercase; color: #9ba5b8; margin: 20px 0 15px; display: flex; justify-content: space-between; align-items: center; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: #151b2e; padding: 12px; display: flex; gap: 8px; }
        .nav-btn { flex: 1; padding: 12px; background: #1a2237; border-radius: 8px; color: #9ba5b8; font-size: 14px; cursor: pointer; border: none; }
        .status { font-size: 10px; margin-top: 3px; }
        .currency-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .currency-row input { flex: 2; margin-bottom: 0; }
        .currency-row select { flex: 1; margin-bottom: 0; }
        .live { color: #00ff88; }
        .manual-badge { color: #ffc044; }
        .failed { color: #ff4466; }
        .badge { padding: 2px 8px; border-radius: 4px; font-size: 10px; margin-left: 6px; font-weight: 600; }
        .badge-fund { background: #2a3550; color: #9ba5b8; }
        .badge-rsu { background: #2a3550; color: #9ba5b8; }
        .badge-property { background: #4d94ff; color: white; }
        .badge-savings { background: #00ff88; color: #0a0e1a; }
        .info-text { font-size: 12px; color: #9ba5b8; margin-top: -10px; margin-bottom: 15px; font-style: italic; }
        .next-update { font-size: 11px; color: #9ba5b8; margin-top: 5px; }
        .loading-indicator { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background: #1a2237; padding: 20px 40px; border-radius: 12px; border: 2px solid #4d94ff; z-index: 2000; display: none; }
        .loading-indicator.show { display: block; }
        .error-list { background: #ff446620; border: 1px solid #ff4466; border-radius: 8px; padding: 12px; margin: 15px 0; font-size: 12px; }
        .chart-container { position: relative; max-height: 250px; }
        .cost-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .cost-item label { font-size: 12px; margin-bottom: 5px; }
        .cost-item input { margin-bottom: 0; }
        .currency-selector { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; padding: 12px; background: #1a2237; border: 1px solid #2a3550; border-radius: 10px; }
        .currency-selector label { font-size: 12px; color: #9ba5b8; text-transform: uppercase; margin: 0; }
        .currency-selector select { width: auto; padding: 8px 12px; margin: 0; font-size: 14px; }
        .chat-container { position: fixed; bottom: 80px; right: 20px; width: 380px; max-width: calc(100vw - 40px); height: 500px; background: #1a2237; border: 1px solid #2a3550; border-radius: 16px; display: none; flex-direction: column; z-index: 999; box-shadow: 0 8px 32px rgba(0,0,0,0.4); }
        .chat-container.show { display: flex; }
        .chat-header { padding: 16px; border-bottom: 1px solid #2a3550; display: flex; justify-content: space-between; align-items: center; }
        .chat-header h3 { font-size: 16px; margin: 0; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
        .chat-message { padding: 12px; border-radius: 8px; max-width: 85%; word-wrap: break-word; line-height: 1.5; }
        .chat-message.user { background: #4d94ff; color: white; align-self: flex-end; }
        .chat-message.assistant { background: #2a3550; color: #e8edf4; align-self: flex-start; }
        .chat-input-container { padding: 12px; border-top: 1px solid #2a3550; display: flex; gap: 8px; }
        .chat-input { flex: 1; background: #0a0e1a; border: 1px solid #2a3550; border-radius: 8px; padding: 10px; color: #e8edf4; font-size: 14px; margin: 0; }
        .chat-send-btn { background: #4d94ff; color: white; border: none; border-radius: 8px; padding: 10px 20px; cursor: pointer; font-size: 14px; }
        .chat-send-btn:disabled { opacity: 0.5; }
        .typing-indicator { padding: 12px; background: #2a3550; border-radius: 8px; align-self: flex-start; }
        .typing-indicator span { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #9ba5b8; margin: 0 2px; animation: typing 1.4s infinite; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%,60%,100% { opacity:0.3; } 30% { opacity:1; } }
        .settings-section { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #2a3550; }
        .settings-section:last-child { border-bottom: none; }
        .settings-section h4 { margin-bottom: 10px; font-size: 14px; }
        .btn-secondary { background: #2a3550; margin-top: 10px; }
        .warning-text { color: #ffc044; font-size: 12px; margin-top: 5px; }
        .btn-group { display: flex; gap: 10px; }
        .btn-group .btn { flex: 1; }
        #theme-toggle { position: fixed; top: 1rem; right: 1rem; z-index: 1000; padding: 0.5rem 1rem; background: #4d94ff; color: white; border: none; border-radius: 6px; cursor: pointer; }
        input[type="file"] { display: none; }

```
    /* Multi-select filter styles */
    .filter-section { margin-bottom: 20px; }
    .filter-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .filter-title { font-size: 12px; color: #9ba5b8; text-transform: uppercase; font-weight: 600; }
    .clear-filters-btn { padding: 6px 12px; background: transparent; color: #9ba5b8; border: 1px solid #2a3550; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s; text-transform: uppercase; letter-spacing: 0.5px; }
    .clear-filters-btn:hover { background: #2a3550; color: #e8edf4; border-color: #4d94ff; }
    .clear-filters-btn:active { transform: scale(0.95); }
    .filter-presets { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
    .preset-btn { padding: 8px 14px; background: linear-gradient(135deg, #4d94ff 0%, #3d7fe6 100%); color: white; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
    .preset-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(77, 148, 255, 0.3); }
    .preset-btn:active { transform: translateY(0); }
    .filter-checkboxes { display: flex; gap: 12px; flex-wrap: wrap; }
    .filter-checkbox { display: flex; align-items: center; gap: 8px; padding: 8px 14px; background: #1a2237; border: 1px solid #2a3550; border-radius: 8px; cursor: pointer; transition: all 0.2s; user-select: none; }
    .filter-checkbox:hover { background: #202840; }
    .filter-checkbox input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; accent-color: #4d94ff; }
    .filter-checkbox span { font-size: 13px; color: #e8edf4; font-weight: 500; }
    .filter-checkbox input[type="checkbox"]:checked + span { color: #4d94ff; font-weight: 600; }
    .filter-checkbox:has(input:checked) { background: #1a2850; border-color: #4d94ff; }
    
    .holdings-container { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    /* Light mode */
    body.light { background: #f8f9fa; color: #212529; }
    body.light .card, body.light .holding, body.light .modal-content, body.light .chat-container, body.light .loading-indicator { background: #ffffff; border-color: #dee2e6; }
    body.light input, body.light select, body.light textarea { background: #f8f9fa; color: #212529; border-color: #ced4da; }
    body.light .bottom-nav { background: #ffffff; border-top: 1px solid #dee2e6; }
    body.light .nav-btn { background: #ffffff; color: #495057; }
    body.light .currency-selector { background: #ffffff; border-color: #dee2e6; }
    body.light .chat-message.assistant { background: #f0f0f0; color: #212529; }
    body.light .chat-input { background: #ffffff; color: #212529; }
    body.light .settings-section { border-color: #dee2e6; }
    body.light #theme-toggle { background: #007bff; }
    body.light .clear-filters-btn { color: #6c757d; border-color: #dee2e6; }
    body.light .clear-filters-btn:hover { background: #f8f9fa; color: #212529; border-color: #007bff; }
    body.light .preset-btn { background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); }
    body.light .preset-btn:hover { box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3); }
    body.light .filter-checkbox { background: #ffffff; border-color: #dee2e6; }
    body.light .filter-checkbox:hover { background: #f8f9fa; }
    body.light .filter-checkbox span { color: #212529; }
    body.light .filter-checkbox input[type="checkbox"]:checked + span { color: #007bff; }
    body.light .filter-checkbox:has(input:checked) { background: #e7f3ff; border-color: #007bff; }
</style>
```

</head>
<body class="dark">

<button id="theme-toggle">‚òÄÔ∏è Light</button>

<div class="loading-indicator" id="loadingIndicator"><div>‚è≥ Updating prices...</div></div>

<h1>Passive Income</h1>
<div class="meta" id="lastUpdate" style="margin-bottom:5px;">Never updated</div>
<div class="next-update" id="nextUpdate">Next auto-update: calculating...</div>
<div id="errorContainer"></div>

<div class="currency-selector">
    <label for="displayCurrency">Display Currency:</label>
    <select id="displayCurrency">
        <option value="DKK">DKK</option>
        <option value="EUR">EUR</option>
        <option value="USD">USD</option>
    </select>
</div>

<div class="card">
    <div class="label">Portfolio Value <span id="filterLabel">(All)</span></div>
    <div class="value" id="totalValue">0 DKK</div>
    <div class="change" id="totalChange">‚Äî</div>
</div>

<div class="card">
    <div class="label">Annual Income <span id="incomeFilterLabel">(All)</span></div>
    <div class="value" id="annualIncome">0 DKK</div>
    <div class="change"><span id="yieldPercent">0.0%</span> yield</div>
</div>

<div class="card">
    <h3 style="margin-bottom:15px;">Portfolio Allocation</h3>
    <div class="chart-container"><canvas id="allocationChart"></canvas></div>
</div>

<div class="filter-section">
    <div class="filter-header">
        <span class="filter-title">FILTER BY TYPE</span>
        <button class="clear-filters-btn" id="clearFiltersBtn" title="Remove all filters and show all holdings">
            ‚úï Clear All
        </button>
    </div>

```
<div class="filter-presets">
    <button class="preset-btn" data-preset="liquid" title="Stocks + Savings">üíß Liquid Assets</button>
    <button class="preset-btn" data-preset="longterm" title="Property + Funds">üìà Long-term</button>
    <button class="preset-btn" data-preset="income" title="Stocks + Funds + Property">üí∞ Income Producers</button>
</div>

<div class="filter-checkboxes">
    <label class="filter-checkbox">
        <input type="checkbox" data-type="stock">
        <span>Stocks</span>
    </label>
    <label class="filter-checkbox">
        <input type="checkbox" data-type="fund">
        <span>Funds</span>
    </label>
    <label class="filter-checkbox">
        <input type="checkbox" data-type="rsu">
        <span>RSU</span>
    </label>
    <label class="filter-checkbox">
        <input type="checkbox" data-type="property">
        <span>Property</span>
    </label>
    <label class="filter-checkbox">
        <input type="checkbox" data-type="savings">
        <span>Savings</span>
    </label>
</div>
```

</div>

<div class="section-title">
    <span>HOLDINGS</span>
    <button class="btn btn-small" id="addBtn">+ Add</button>
</div>

<div style="margin:1rem 0;display:flex;gap:1rem;flex-wrap:wrap;">
    <input type="text" id="searchInput" placeholder="Search..." style="flex:1;min-width:150px;padding:0.5rem;">
    <select id="sortSelect" style="width:auto;min-width:150px;">
        <option value="value-desc">Value (High to Low)</option>
        <option value="value-asc">Value (Low to High)</option>
        <option value="yield-desc">Yield (High to Low)</option>
        <option value="name">Name (A-Z)</option>
    </select>
</div>

<div id="holdings" class="holdings-container"></div>

<div class="chat-container" id="chatContainer">
    <div class="chat-header">
        <h3>üí∞ Passive Income Advisor</h3>
        <button class="close" id="closeChatBtn">√ó</button>
    </div>
    <div class="chat-messages" id="chatMessages">
        <div class="chat-message assistant">
            üëã Hi! I am your passive income advisor. Ask me about your portfolio, dividends, property valuations, or savings rates!
        </div>
    </div>
    <div class="chat-input-container">
        <input type="text" class="chat-input" id="chatInput" placeholder="Ask about your portfolio...">
        <button class="chat-send-btn" id="chatSendBtn">Send</button>
    </div>
</div>

<div class="modal" id="settingsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Settings</h2>
            <button class="close" id="closeSettingsBtn">√ó</button>
        </div>
        <div class="settings-section">
            <h4>Import / Export</h4>
            <div class="btn-group">
                <button class="btn btn-secondary" id="exportBtn">Export</button>
                <button class="btn btn-secondary" id="importBtn">Import</button>
            </div>
        </div>
        <div class="settings-section">
            <h4>Data Management</h4>
            <button class="btn" id="clearAllData" style="background:#ff4466;">Clear All Data</button>
            <div class="warning-text">This deletes everything. Export first!</div>
        </div>
    </div>
</div>

<div class="modal" id="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Add Holding</h2>
            <button class="close" id="closeBtn">√ó</button>
        </div>

```
    <label>Type</label>
    <select id="type">
        <option value="stock">Stock (auto-updates)</option>
        <option value="fund">Fund (manual price)</option>
        <option value="rsu">RSU (auto-updates)</option>
        <option value="property">Property</option>
        <option value="savings">Savings / Cash</option>
    </select>

    <label>Name</label>
    <input type="text" id="name" placeholder="e.g. Apple, Copenhagen Apt, Savings Account">

    <div id="stockFields">
        <div id="tickerWrap">
            <label>Ticker Symbol</label>
            <input type="text" id="ticker" placeholder="e.g. AAPL, FLYW, IBE.MC">
        </div>
        <label>Shares</label>
        <input type="number" step="0.01" id="shares" placeholder="Number of shares">
        <label>Average Cost per Share</label>
        <div class="currency-row">
            <input type="number" step="0.01" id="cost" placeholder="Cost per share">
            <select id="costCurrency"><option>DKK</option><option>EUR</option><option>USD</option></select>
        </div>
        <label>Current Price (required for funds, optional for stocks)</label>
        <div id="priceHint" class="info-text">Stocks and RSU auto-update. Enter only as backup.</div>
        <div id="fundHint" class="info-text" style="display:none;">Funds: Required, will not auto-update.</div>
        <div class="currency-row">
            <input type="number" step="0.01" id="currentPrice" placeholder="Current price">
            <select id="priceCurrency"><option>DKK</option><option>EUR</option><option>USD</option></select>
        </div>
        <label>Annual Dividend per Share (0 if none)</label>
        <div class="currency-row">
            <input type="number" step="0.01" id="dividend" placeholder="0">
            <select id="dividendCurrency"><option>DKK</option><option>EUR</option><option>USD</option></select>
        </div>
    </div>

    <div id="propertyFields" style="display:none;">
        <label>Address</label>
        <textarea id="address" placeholder="e.g. Vestergade 12, 1456 Kobenhavn K"></textarea>
        <label>Property Value</label>
        <div class="currency-row">
            <input type="number" step="0.01" id="propertyValue" placeholder="Market value">
            <select id="propertyCurrency"><option>DKK</option><option>EUR</option><option>USD</option></select>
        </div>
        <label>Annual Rental Income (0 if not rented)</label>
        <div class="currency-row">
            <input type="number" step="0.01" id="rentalIncome" placeholder="0">
            <select id="rentalCurrency"><option>DKK</option><option>EUR</option><option>USD</option></select>
        </div>
        <label>Annual Property Costs</label>
        <div class="cost-grid">
            <div class="cost-item"><label>Tax</label><input type="number" step="0.01" id="costTax" placeholder="0"></div>
            <div class="cost-item"><label>Power</label><input type="number" step="0.01" id="costPower" placeholder="0"></div>
            <div class="cost-item"><label>Water</label><input type="number" step="0.01" id="costWater" placeholder="0"></div>
            <div class="cost-item"><label>Gas</label><input type="number" step="0.01" id="costGas" placeholder="0"></div>
            <div class="cost-item"><label>Internet</label><input type="number" step="0.01" id="costInternet" placeholder="0"></div>
            <div class="cost-item"><label>Other</label><input type="number" step="0.01" id="costOther" placeholder="0"></div>
        </div>
        <label>Costs Currency</label>
        <select id="costsCurrency"><option>DKK</option><option>EUR</option><option>USD</option></select>
    </div>

    <div id="savingsFields" style="display:none;">
        <label>Amount Saved</label>
        <div class="currency-row">
            <input type="number" step="0.01" id="savingsAmount" placeholder="e.g. 100000">
            <select id="savingsCurrency"><option>DKK</option><option>EUR</option><option>USD</option></select>
        </div>
        <label>Annual Interest Rate % (0 if none)</label>
        <input type="number" step="0.01" id="interestRate" placeholder="e.g. 3.5">
        <div class="info-text">Enter 3.5 for 3.5 percent interest per year</div>
    </div>

    <button class="btn" id="saveBtn" style="margin-top:10px;">Save</button>
    <button class="btn" id="deleteBtn" style="display:none;background:#ff4466;margin-top:10px;">Delete</button>
</div>
```

</div>

<div class="bottom-nav">
    <button class="nav-btn" id="dashBtn">Dashboard</button>
    <button class="nav-btn" id="refreshBtn">Refresh</button>
    <button class="nav-btn" id="chatBtn">Chat</button>
    <button class="nav-btn" id="settingsBtn">Settings</button>
</div>

<input type="file" id="importFile" accept=".json">

<script>
var API_KEY = 'f4faaf5fc1f149eeb9364b8065b8298b';
var portfolio = JSON.parse(localStorage.getItem('portfolio') || '{"holdings":[],"lastUpdate":null,"lastScheduledUpdate":null}');
var editingIdx = null;
var isRefreshing = false;
var activeFilters = [];
var searchTerm = '';
var sortBy = 'value-desc';
var fetchErrors = [];
var chatHistory = [];
var allocationChart = null;
var rates = { DKK: 1, EUR: 7.46, USD: 6.88 };
var displayCurrency = localStorage.getItem('displayCurrency') || 'DKK';
document.getElementById('displayCurrency').value = displayCurrency;

var filterPresets = {
    liquid: ['stock', 'savings'],
    longterm: ['property', 'fund'],
    income: ['stock', 'fund', 'property']
};

function toDKK(amount, currency) {
    return (amount || 0) * (rates[currency] || 1);
}

function fromDKK(dkk, currency) {
    if (currency === 'DKK') return dkk;
    return dkk / (rates[currency] || 1);
}

function fmt(amount, currency) {
    var syms = { DKK: 'DKK', EUR: 'EUR', USD: 'USD' };
    return Math.round(amount).toLocaleString('da-DK') + ' ' + (syms[currency] || currency);
}

function save() {
    localStorage.setItem('portfolio', JSON.stringify(portfolio));
}

function holdingValue(h) {
    if (h.type === 'property') {
        return toDKK(h.propertyValue || 0, h.propertyCurrency || 'DKK');
    }
    if (h.type === 'savings') {
        return toDKK(h.savingsAmount || 0, h.savingsCurrency || 'DKK');
    }
    var price = h.type === 'fund'
        ? (h.manualPrice || 0)
        : (h.currentPrice || h.manualPrice || h.cost || 0);
    return (h.shares || 0) * toDKK(price, h.priceCurrency || h.costCurrency || 'DKK');
}

function holdingIncome(h) {
    if (h.type === 'property') {
        var rental = toDKK(h.rentalIncome || 0, h.rentalCurrency || 'DKK');
        var c = h.costs || {};
        var tc = toDKK((c.tax||0)+(c.power||0)+(c.water||0)+(c.gas||0)+(c.internet||0)+(c.other||0), h.costsCurrency || 'DKK');
        return rental - tc;
    }
    if (h.type === 'savings') {
        return toDKK(h.savingsAmount || 0, h.savingsCurrency || 'DKK') * ((h.interestRate || 0) / 100);
    }
    return toDKK((h.dividend || 0) * (h.shares || 0), h.dividendCurrency || h.costCurrency || 'DKK');
}

document.getElementById('displayCurrency').onchange = function(e) {
    displayCurrency = e.target.value;
    localStorage.setItem('displayCurrency', displayCurrency);
    render();
};

var theme = localStorage.getItem('theme') || 'dark';
document.body.className = theme;
var themeBtn = document.getElementById('theme-toggle');
themeBtn.textContent = theme === 'dark' ? '‚òÄÔ∏è Light' : 'üåô Dark';
themeBtn.onclick = function() {
    theme = theme === 'dark' ? 'light' : 'dark';
    document.body.className = theme;
    localStorage.setItem('theme', theme);
    themeBtn.textContent = theme === 'dark' ? '‚òÄÔ∏è Light' : 'üåô Dark';
};

function updateRates() {
    return fetch('https://api.frankfurter.app/latest?from=DKK&to=EUR,USD')
        .then(function(r) { return r.json(); })
        .then(function(j) { rates.EUR = 1/j.rates.EUR; rates.USD = 1/j.rates.USD; })
        .catch(function() {});
}

function getNextUpdate() {
    var now = new Date();
    var cet = new Date(now.getTime() + (now.getTimezoneOffset() + 60) * 60000);
    var h = cet.getHours();
    var next = new Date(cet);
    if (h < 8) next.setHours(8,0,0,0);
    else if (h < 22) next.setHours(22,0,0,0);
    else { next.setDate(next.getDate()+1); next.setHours(8,0,0,0); }
    return new Date(next.getTime() - (now.getTimezoneOffset() + 60) * 60000);
}

function updateNextDisplay() {
    var next = getNextUpdate();
    var diff = next - Date.now();
    var h = Math.floor(diff / 3600000);
    var m = Math.floor((diff % 3600000) / 60000);
    var t = next.toLocaleTimeString('da-DK', {hour:'2-digit',minute:'2-digit'});
    document.getElementById('nextUpdate').textContent = 'Next auto-update ' + (h < 1 ? 'in '+m+' min' : 'in '+h+'h '+m+'m') + ' at ' + t;
}

function checkAutoUpdate() {
    var now = new Date();
    var cet = new Date(now.getTime() + (now.getTimezoneOffset() + 60) * 60000);
    var hour = cet.getHours();
    var min = cet.getMinutes();
    if ((hour === 8 || hour === 22) && min < 5) {
        var key = cet.toISOString().split('T')[0] + '-' + hour;
        if (portfolio.lastScheduledUpdate !== key) {
            portfolio.lastScheduledUpdate = key;
            save();
            refreshPrices();
        }
    }
}

function fetchPrice(h) {
    if (!h.ticker || h.type === 'fund' || h.type === 'property' || h.type === 'savings') {
        return Promise.resolve();
    }
    var sym = h.ticker.toUpperCase();
    if (sym.indexOf('.') !== -1) { h.fetchError = true; return Promise.resolve(); }
    return fetch('https://api.twelvedata.com/quote?symbol=' + sym + '&apikey=' + API_KEY)
        .then(function(r) { return r.json(); })
        .then(function(j) {
            if (j.close || j.previous_close) {
                h.currentPrice = parseFloat(j.close || j.previous_close);
                h.priceCurrency = j.currency || 'USD';
                h.fetchError = false;
            } else {
                h.fetchError = true;
                fetchErrors.push(h.name + ': fetch failed');
            }
        })
        .catch(function() { h.fetchError = true; fetchErrors.push(h.name + ': fetch failed'); });
}

function refreshPrices() {
    if (isRefreshing) return;
    isRefreshing = true;
    fetchErrors = [];
    document.getElementById('loadingIndicator').classList.add('show');
    document.getElementById('refreshBtn').textContent = 'Updating...';
    document.getElementById('refreshBtn').disabled = true;
    updateRates().then(function() {
        return Promise.all(portfolio.holdings.map(fetchPrice));
    }).then(function() {
        portfolio.lastUpdate = new Date().toISOString();
        save();
        var ec = document.getElementById('errorContainer');
        ec.innerHTML = fetchErrors.length ? '<div class="error-list"><strong>Some prices failed:</strong>' + fetchErrors.map(function(e){ return '<div>' + e + '</div>'; }).join('') + '</div>' : '';
        render();
        document.getElementById('loadingIndicator').classList.remove('show');
        document.getElementById('refreshBtn').textContent = 'Refresh';
        document.getElementById('refreshBtn').disabled = false;
        isRefreshing = false;
    });
}

function toggleFields() {
    var type = document.getElementById('type').value;
    document.getElementById('stockFields').style.display = (type==='stock'||type==='fund'||type==='rsu') ? 'block' : 'none';
    document.getElementById('propertyFields').style.display = type==='property' ? 'block' : 'none';
    document.getElementById('savingsFields').style.display = type==='savings' ? 'block' : 'none';
    document.getElementById('tickerWrap').style.display = type==='fund' ? 'none' : 'block';
    document.getElementById('priceHint').style.display = type==='fund' ? 'none' : 'block';
    document.getElementById('fundHint').style.display = type==='fund' ? 'block' : 'none';
}

function clearForm() {
    ['ticker','name','shares','cost','currentPrice','dividend','address','propertyValue','rentalIncome','costTax','costPower','costWater','costGas','costInternet','costOther','savingsAmount','interestRate'].forEach(function(id) {
        document.getElementById(id).value = '';
    });
    document.getElementById('type').value = 'stock';
    document.getElementById('costCurrency').value = 'DKK';
    document.getElementById('priceCurrency').value = 'DKK';
    document.getElementById('dividendCurrency').value = 'DKK';
    document.getElementById('propertyCurrency').value = 'DKK';
    document.getElementById('rentalCurrency').value = 'DKK';
    document.getElementById('costsCurrency').value = 'DKK';
    document.getElementById('savingsCurrency').value = 'DKK';
    document.getElementById('deleteBtn').style.display = 'none';
    toggleFields();
}

function editHolding(idx) {
    editingIdx = idx;
    var h = portfolio.holdings[idx];
    document.getElementById('modalTitle').textContent = 'Edit Holding';
    document.getElementById('type').value = h.type;
    document.getElementById('name').value = h.name || '';
    toggleFields();
    if (h.type === 'savings') {
        document.getElementById('savingsAmount').value = h.savingsAmount || '';
        document.getElementById('savingsCurrency').value = h.savingsCurrency || 'DKK';
        document.getElementById('interestRate').value = h.interestRate || '';
    } else if (h.type === 'property') {
        document.getElementById('address').value = h.address || '';
        document.getElementById('propertyValue').value = h.propertyValue || '';
        document.getElementById('propertyCurrency').value = h.propertyCurrency || 'DKK';
        document.getElementById('rentalIncome').value = h.rentalIncome || '';
        document.getElementById('rentalCurrency').value = h.rentalCurrency || 'DKK';
        var c = h.costs || {};
        document.getElementById('costTax').value = c.tax || '';
        document.getElementById('costPower').value = c.power || '';
        document.getElementById('costWater').value = c.water || '';
        document.getElementById('costGas').value = c.gas || '';
        document.getElementById('costInternet').value = c.internet || '';
        document.getElementById('costOther').value = c.other || '';
        document.getElementById('costsCurrency').value = h.costsCurrency || 'DKK';
    } else {
        document.getElementById('ticker').value = h.ticker || '';
        document.getElementById('shares').value = h.shares || '';
        document.getElementById('cost').value = h.cost || '';
        document.getElementById('costCurrency').value = h.costCurrency || 'DKK';
        document.getElementById('currentPrice').value = h.manualPrice || '';
        document.getElementById('priceCurrency').value = h.priceCurrency || 'DKK';
        document.getElementById('dividend').value = h.dividend || '';
        document.getElementById('dividendCurrency').value = h.dividendCurrency || 'DKK';
    }
    document.getElementById('deleteBtn').style.display = 'block';
    document.getElementById('modal').classList.add('show');
}

function saveHolding() {
    var type = document.getElementById('type').value;
    var name = document.getElementById('name').value.trim();
    if (!name) { alert('Name is required.'); return; }
    var h = { type: type, name: name };
    if (type === 'savings') {
        var amt = parseFloat(document.getElementById('savingsAmount').value) || 0;
        if (amt <= 0) { alert('Savings amount must be greater than 0.'); return; }
        h.savingsAmount = amt;
        h.savingsCurrency = document.getElementById('savingsCurrency').value;
        h.interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
    } else if (type === 'property') {
        var val = parseFloat(document.getElementById('propertyValue').value) || 0;
        if (val <= 0) { alert('Property value must be greater than 0.'); return; }
        h.address = document.getElementById('address').value.trim();
        h.propertyValue = val;
        h.propertyCurrency = document.getElementById('propertyCurrency').value;
        h.rentalIncome = parseFloat(document.getElementById('rentalIncome').value) || 0;
        h.rentalCurrency = document.getElementById('rentalCurrency').value;
        h.costs = {
            tax: parseFloat(document.getElementById('costTax').value) || 0,
            power: parseFloat(document.getElementById('costPower').value) || 0,
            water: parseFloat(document.getElementById('costWater').value) || 0,
            gas: parseFloat(document.getElementById('costGas').value) || 0,
            internet: parseFloat(document.getElementById('costInternet').value) || 0,
            other: parseFloat(document.getElementById('costOther').value) || 0
        };
        h.costsCurrency = document.getElementById('costsCurrency').value;
    } else {
        var shares = parseFloat(document.getElementById('shares').value) || 0;
        var cost = parseFloat(document.getElementById('cost').value) || 0;
        if (shares <= 0 || cost <= 0) { alert('Shares and cost must be greater than 0.'); return; }
        var ticker = document.getElementById('ticker').value.trim().toUpperCase();
        if (type !== 'fund' && !ticker) { alert('Ticker is required for stocks and RSU.'); return; }
        var manualPrice = parseFloat(document.getElementById('currentPrice').value) || 0;
        if (type === 'fund' && manualPrice <= 0) { alert('Current price is required for funds.'); return; }
        h.ticker = type !== 'fund' ? ticker : undefined;
        h.shares = shares;
        h.cost = cost;
        h.costCurrency = document.getElementById('costCurrency').value;
        h.manualPrice = manualPrice > 0 ? manualPrice : undefined;
        h.priceCurrency = document.getElementById('priceCurrency').value;
        h.dividend = parseFloat(document.getElementById('dividend').value) || 0;
        h.dividendCurrency = document.getElementById('dividendCurrency').value;
        if (editingIdx !== null && portfolio.holdings[editingIdx] && portfolio.holdings[editingIdx].currentPrice) {
            h.currentPrice = portfolio.holdings[editingIdx].currentPrice;
        }
    }
    if (editingIdx !== null) {
        portfolio.holdings[editingIdx] = h;
        editingIdx = null;
    } else {
        portfolio.holdings.push(h);
    }
    save();
    document.getElementById('modal').classList.remove('show');
    clearForm();
    render();
    if ((type === 'stock' || type === 'rsu') && h.ticker) {
        var newIdx = portfolio.holdings.length - 1;
        fetchPrice(portfolio.holdings[newIdx]).then(function() { save(); render(); });
    }
}

function deleteHolding() {
    if (!confirm('Delete this holding?')) return;
    portfolio.holdings.splice(editingIdx, 1);
    editingIdx = null;
    save();
    document.getElementById('modal').classList.remove('show');
    clearForm();
    render();
}

function exportData() {
    var blob = new Blob([JSON.stringify(portfolio, null, 2)], {type:'application/json'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'portfolio-' + new Date().toISOString().split('T')[0] + '.json';
    a.click();
    URL.revokeObjectURL(url);
}

document.getElementById('importFile').onchange = function(e) {
    var file = e.target.files[0];
    if (!file) return;
    var reader = new FileReader();
    reader.onload = function(ev) {
        try {
            var imp = JSON.parse(ev.target.result);
            if (!Array.isArray(imp.holdings)) { alert('Invalid file.'); return; }
            if (confirm('Import ' + imp.holdings.length + ' holdings? This replaces current data.')) {
                portfolio = imp;
                save();
                render();
                alert('Imported successfully!');
            }
        } catch(err) { alert('Error: ' + err.message); }
    };
    reader.readAsText(file);
    e.target.value = '';
};

function toggleChat() {
    var c = document.getElementById('chatContainer');
    c.classList.toggle('show');
    if (c.classList.contains('show')) document.getElementById('chatInput').focus();
}

function addMsg(role, text) {
    var msgs = document.getElementById('chatMessages');
    var d = document.createElement('div');
    d.className = 'chat-message ' + role;
    d.textContent = text;
    msgs.appendChild(d);
    d.scrollIntoView({behavior:'smooth'});
}

function sendChatMessage() {
    var input = document.getElementById('chatInput');
    var msg = input.value.trim();
    if (!msg) return;
    addMsg('user', msg);
    input.value = '';
    var btn = document.getElementById('chatSendBtn');
    btn.disabled = true;

    var typing = document.createElement('div');
    typing.className = 'typing-indicator';
    typing.innerHTML = '<span></span><span></span><span></span>';
    document.getElementById('chatMessages').appendChild(typing);
    typing.scrollIntoView({behavior:'smooth'});

    var totalVal = 0;
    var totalInc = 0;
    portfolio.holdings.forEach(function(h) { totalVal += holdingValue(h); totalInc += holdingIncome(h); });
    var yld = totalVal > 0 ? (totalInc/totalVal*100).toFixed(2) : '0.00';
    var names = portfolio.holdings.map(function(h){ return h.name + ' (' + h.type + ')'; }).join(', ') || 'none yet';

    var systemMsg = 'You are a helpful passive income investment advisor. ' +
        'Portfolio value: ' + Math.round(totalVal).toLocaleString() + ' DKK. ' +
        'Annual income: ' + Math.round(totalInc).toLocaleString() + ' DKK (' + yld + '% yield). ' +
        'Holdings: ' + names + '. ' +
        'Give concise practical advice. For Danish property valuations recommend Boligsiden.dk.';

    var messages = [{ role: 'system', content: systemMsg }];
    for (var i = Math.max(0, chatHistory.length-6); i < chatHistory.length; i++) {
        messages.push(chatHistory[i]);
    }
    messages.push({ role: 'user', content: msg });

    fetch('https://text.pollinations.ai/openai', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ model: 'openai', messages: messages, max_tokens: 400, temperature: 0.7 })
    })
    .then(function(res) {
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return res.json();
    })
    .then(function(data) {
        var reply = 'Sorry, I could not get a response. Please try again.';
        if (data && data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) {
            reply = data.choices[0].message.content.trim();
        }
        chatHistory.push({role:'user',content:msg});
        chatHistory.push({role:'assistant',content:reply});
        if (chatHistory.length > 12) chatHistory.splice(0, chatHistory.length - 12);
        typing.remove();
        addMsg('assistant', reply);
        btn.disabled = false;
    })
    .catch(function() {
        typing.remove();
        addMsg('assistant', 'Chat is unavailable right now. Please try again in a moment.');
        btn.disabled = false;
    });
}

function getFiltered() {
    var list = portfolio.holdings.filter(function(h) {
        if (activeFilters.length === 0) return true;
        return activeFilters.indexOf(h.type) !== -1;
    });
    if (searchTerm) {
        var t = searchTerm.toLowerCase();
        list = list.filter(function(h) {
            return h.name.toLowerCase().indexOf(t) !== -1 ||
                (h.ticker && h.ticker.toLowerCase().indexOf(t) !== -1) ||
                (h.address && h.address.toLowerCase().indexOf(t) !== -1);
        });
    }
    list.sort(function(a,b) {
        if (sortBy === 'value-asc') return holdingValue(a)-holdingValue(b);
        if (sortBy === 'yield-desc') {
            var va=holdingValue(a), vb=holdingValue(b);
            return (vb>0?holdingIncome(b)/vb:0)-(va>0?holdingIncome(a)/va:0);
        }
        if (sortBy === 'name') return a.name.localeCompare(b.name);
        return holdingValue(b)-holdingValue(a);
    });
    return list;
}

function updateFilters() {
    activeFilters = [];
    document.querySelectorAll('.filter-checkbox input[type="checkbox"]:checked').forEach(function(checkbox) {
        activeFilters.push(checkbox.dataset.type);
    });
    updateClearButton();
    render();
}

function syncCheckboxes() {
    document.querySelectorAll('.filter-checkbox input[type="checkbox"]').forEach(function(checkbox) {
        var type = checkbox.dataset.type;
        checkbox.checked = activeFilters.indexOf(type) !== -1;
    });
}

function applyPreset(presetName) {
    var types = filterPresets[presetName];
    if (!types) return;
    activeFilters = types.slice();
    syncCheckboxes();
    updateClearButton();
    render();
}

function clearFilters() {
    activeFilters = [];
    document.querySelectorAll('.filter-checkbox input[type="checkbox"]').forEach(function(checkbox) {
        checkbox.checked = false;
    });
    updateClearButton();
    render();
}

function updateClearButton() {
    var clearBtn = document.getElementById('clearFiltersBtn');
    if (clearBtn) {
        clearBtn.style.display = activeFilters.length > 0 ? 'block' : 'none';
    }
}

function renderChart(filtered) {
    var ctx = document.getElementById('allocationChart').getContext('2d');
    var types = {};
    var total = 0;
    filtered.forEach(function(h) { var v=holdingValue(h); types[h.type]=(types[h.type]||0)+v; total+=v; });
    var keys = Object.keys(types);
    var labels = keys.map(function(t) { var pct=total>0?(types[t]/total*100).toFixed(1):0; return t.charAt(0).toUpperCase()+t.slice(1)+' ('+pct+'%)'; });
    var vals = keys.map(function(t) { return types[t]; });
    if (allocationChart) {
        allocationChart.data.labels = labels;
        allocationChart.data.datasets[0].data = vals;
        allocationChart.update('none');
    } else {
        allocationChart = new Chart(ctx, {
            type: 'pie',
            data: { labels: labels, datasets:[{data:vals, backgroundColor:['#36A2EB','#FF6384','#FFCE56','#4BC0C0','#9966FF','#FF9F40']}] },
            options: { responsive:true, maintainAspectRatio:true, plugins:{ legend:{position:'bottom'}, tooltip:{callbacks:{label:function(c){ return fmt(fromDKK(c.raw,displayCurrency),displayCurrency); }}} } }
        });
    }
}

function render() {
    var filtered = getFiltered();
    var totVal=0, totCost=0, totInc=0;
    filtered.forEach(function(h) {
        totVal += holdingValue(h);
        totCost += (h.type==='property'||h.type==='savings') ? holdingValue(h) : toDKK((h.cost||0)*(h.shares||0), h.costCurrency||'DKK');
        totInc += holdingIncome(h);
    });

    var dVal  = fromDKK(totVal, displayCurrency);
    var dInc  = fromDKK(totInc, displayCurrency);
    var dChg  = fromDKK(totVal-totCost, displayCurrency);
    var chgPct = totCost ? ((totVal-totCost)/totCost*100) : 0;
    var yldPct = totVal  ? (totInc/totVal*100) : 0;

    document.getElementById('totalValue').textContent = fmt(dVal, displayCurrency);
    document.getElementById('annualIncome').textContent = fmt(dInc, displayCurrency);
    document.getElementById('yieldPercent').textContent = yldPct.toFixed(2)+'%';

    var chgEl = document.getElementById('totalChange');
    chgEl.textContent = (dChg>=0?'+':'') + fmt(dChg,displayCurrency) + ' (' + chgPct.toFixed(1) + '%)';
    chgEl.className = 'change ' + (dChg>=0?'positive':'negative');

    var lbl = activeFilters.length === 0 
        ? 'All' 
        : activeFilters.map(function(t){ return t.charAt(0).toUpperCase() + t.slice(1); }).join(' + ');
    document.getElementById('filterLabel').textContent = '('+lbl+')';
    document.getElementById('incomeFilterLabel').textContent = '('+lbl+')';

    var container = document.getElementById('holdings');
    container.innerHTML = '';

    if (filtered.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:40px;color:#9ba5b8;">No holdings found</div>';
    } else {
        filtered.forEach(function(h) {
            var val=holdingValue(h), inc=holdingIncome(h);
            var yld=val?(inc/val*100):0;
            var dv=fromDKK(val,displayCurrency), di=fromDKK(Math.abs(inc),displayCurrency);
            var badge='', lines='', status='';

            if (h.type==='savings') {
                badge='<span class="badge badge-savings">SAVINGS</span>';
                lines='<div class="meta">Interest: '+(h.interestRate||0).toFixed(2)+'% per year</div>';
            } else if (h.type==='property') {
                badge='<span class="badge badge-property">PROPERTY</span>';
                lines=h.address?'<div class="meta">'+h.address+'</div>':'';
                var c=h.costs||{}, tc=(c.tax||0)+(c.power||0)+(c.water||0)+(c.gas||0)+(c.internet||0)+(c.other||0);
                if (tc>0) lines+='<div class="meta">Annual costs: '+fmt(fromDKK(toDKK(tc,h.costsCurrency||'DKK'),displayCurrency),displayCurrency)+'</div>';
            } else {
                var cv=toDKK((h.cost||0)*(h.shares||0),h.costCurrency||'DKK');
                var chg=val-cv, dCv=fromDKK(cv,displayCurrency), dChg2=fromDKK(chg,displayCurrency);
                var chgP=cv?(chg/cv*100):0;
                if (h.type==='fund') { badge='<span class="badge badge-fund">FUND</span>'; status='<span class="status manual-badge">Manual price</span>'; }
                else if (h.type==='rsu') { badge='<span class="badge badge-rsu">RSU</span>'; }
                if (h.type!=='fund') {
                    if (h.fetchError) status='<span class="status failed">Fetch failed</span>';
                    else if (h.currentPrice) status='<span class="status live">Live price</span>';
                }
                lines='<div class="meta">'+(h.shares||0)+' shares @ '+(h.cost||0).toFixed(2)+' '+(h.costCurrency||'DKK')+' = '+fmt(dCv,displayCurrency)+' cost</div>';
                lines+='<div class="meta '+(chg>=0?'positive':'negative')+'">'+(chg>=0?'+':'')+fmt(dChg2,displayCurrency)+' ('+chgP.toFixed(1)+'%)</div>';
            }

            var incLabel=inc>=0?'Income':'Cost';
            var d=document.createElement('div');
            d.className='holding';
            var hIdx=portfolio.holdings.indexOf(h);
            d.onclick=(function(i){ return function(){ editHolding(i); }; })(hIdx);
            d.innerHTML='<div class="holding-header"><span class="holding-name">'+h.name+badge+'</span><span>'+fmt(dv,displayCurrency)+'</span></div>'+lines+'<div class="meta">'+incLabel+': '+fmt(di,displayCurrency)+'/yr ('+yld.toFixed(1)+'%)</div>'+status;
            container.appendChild(d);
        });
    }

    renderChart(filtered);
    if (portfolio.lastUpdate) {
        document.getElementById('lastUpdate').textContent = 'Last update: ' + new Date(portfolio.lastUpdate).toLocaleString('da-DK');
    }
    updateNextDisplay();
}

document.getElementById('addBtn').onclick = function() { editingIdx=null; clearForm(); document.getElementById('modalTitle').textContent='Add Holding'; document.getElementById('modal').classList.add('show'); };
document.getElementById('closeBtn').onclick = function() { document.getElementById('modal').classList.remove('show'); };
document.getElementById('saveBtn').onclick = saveHolding;
document.getElementById('deleteBtn').onclick = deleteHolding;
document.getElementById('refreshBtn').onclick = refreshPrices;
document.getElementById('chatBtn').onclick = toggleChat;
document.getElementById('closeChatBtn').onclick = toggleChat;
document.getElementById('type').onchange = toggleFields;
document.getElementById('chatSendBtn').onclick = sendChatMessage;
document.getElementById('chatInput').onkeypress = function(e) { if (e.key==='Enter') sendChatMessage(); };
document.getElementById('settingsBtn').onclick = function() { document.getElementById('settingsModal').classList.add('show'); };
document.getElementById('closeSettingsBtn').onclick = function() { document.getElementById('settingsModal').classList.remove('show'); };
document.getElementById('exportBtn').onclick = exportData;
document.getElementById('importBtn').onclick = function() { document.getElementById('importFile').click(); };
document.getElementById('clearAllData').onclick = function() { if (confirm('Delete ALL data? Cannot be undone!')) { localStorage.clear(); location.reload(); } };
document.getElementById('searchInput').oninput = function(e) { searchTerm=e.target.value; render(); };
document.getElementById('sortSelect').onchange = function(e) { sortBy=e.target.value; render(); };

document.querySelectorAll('.filter-checkbox input[type="checkbox"]').forEach(function(checkbox) {
    checkbox.onchange = updateFilters;
});

document.querySelectorAll('.preset-btn').forEach(function(btn) {
    btn.onclick = function() {
        applyPreset(btn.dataset.preset);
    };
});

document.getElementById('clearFiltersBtn').onclick = clearFilters;

updateRates();
checkAutoUpdate();
updateClearButton();
render();
setInterval(checkAutoUpdate, 60000);
setInterval(updateNextDisplay, 60000);
</script>

</body>
</html>
