<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passive Income Portfolio</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: #0a0e1a; color: #e8edf4; padding: 20px 20px 100px; }
        h1 { font-size: 28px; margin-bottom: 10px; }
        .card { background: #1a2237; border: 1px solid #2a3550; border-radius: 12px; padding: 20px; margin-bottom: 15px; }
        .label { font-size: 12px; color: #9ba5b8; text-transform: uppercase; margin-bottom: 8px; }
        .value { font-size: 32px; font-weight: 300; margin-bottom: 5px; }
        .change { font-size: 14px; color: #9ba5b8; }
        .positive { color: #00ff88; }
        .negative { color: #ff4466; }
        .btn { background: #4d94ff; color: white; border: none; border-radius: 10px; padding: 14px 24px; font-size: 16px; width: 100%; cursor: pointer; }
        .btn:active { opacity: 0.8; }
        .btn-small { width: auto; padding: 10px 20px; font-size: 14px; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); padding: 20px; overflow-y: auto; z-index: 1000; }
        .modal.show { display: block; }
        .modal-content { background: #1a2237; border-radius: 16px; padding: 24px; max-width: 500px; margin: 40px auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close { font-size: 30px; color: #9ba5b8; cursor: pointer; background: none; border: none; }
        input, select { width: 100%; background: #0a0e1a; border: 1px solid #2a3550; border-radius: 8px; padding: 12px; color: #e8edf4; font-size: 16px; margin-bottom: 15px; }
        label { display: block; font-size: 14px; color: #9ba5b8; margin-bottom: 5px; }
        .holding { background: #1a2237; border: 1px solid #2a3550; border-radius: 10px; padding: 15px; margin-bottom: 10px; cursor: pointer; }
        .holding:active { background: #202840; }
        .holding-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .ticker { font-size: 18px; font-weight: 600; }
        .meta { font-size: 12px; color: #9ba5b8; margin-top: 4px; }
        .section-title { font-size: 12px; text-transform: uppercase; color: #9ba5b8; margin: 20px 0 15px; display: flex; justify-content: space-between; align-items: center; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: #151b2e; padding: 12px; display: flex; gap: 8px; }
        .nav-btn { flex: 1; padding: 12px; background: #1a2237; border: 1px solid #2a3550; border-radius: 8px; color: #9ba5b8; font-size: 14px; cursor: pointer; border: none; }
        .status { font-size: 10px; margin-top: 3px; }
        .currency-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .currency-row input { flex: 2; margin-bottom: 0; }
        .currency-row select { flex: 1; margin-bottom: 0; }
        .live { color: #00ff88; }
        .manual-price { color: #ffc044; }
        .failed { color: #ff4466; }
    </style>
</head>
<body>
    <h1>Passive Income</h1>
    <div class="meta" id="lastUpdate" style="margin-bottom:30px;">Never updated</div>
    
    <div class="card">
        <div class="label">Portfolio Value</div>
        <div class="value" id="totalValue">0 DKK</div>
        <div class="change" id="totalChange">â€”</div>
    </div>
    
    <div class="card">
        <div class="label">Annual Income</div>
        <div class="value" id="annualIncome">0 DKK</div>
        <div class="change"><span id="yieldPercent">0.0%</span> yield</div>
    </div>
    
    <div class="section-title">
        <span>HOLDINGS</span>
        <button class="btn btn-small" id="addBtn">+ Add</button>
    </div>
    
    <div id="holdings"></div>
    
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add Holding</h2>
                <button class="close" id="closeBtn">&times;</button>
            </div>
            <label>Ticker</label>
            <input type="text" id="ticker">
            <label>Name</label>
            <input type="text" id="name">
            <label>Shares</label>
            <input type="number" step="0.01" id="shares">
            <label>Average Cost per Share</label>
            <div class="currency-row">
                <input type="number" step="0.01" id="cost">
                <select id="costCurrency">
                    <option value="DKK">DKK</option>
                    <option value="EUR">EUR</option>
                    <option value="USD">USD</option>
                </select>
            </div>
            <label>Current Price (optional - auto-fetch if blank)</label>
            <div class="currency-row">
                <input type="number" step="0.01" id="currentPrice" placeholder="Leave blank for auto-update">
                <select id="priceCurrency">
                    <option value="DKK">DKK</option>
                    <option value="EUR">EUR</option>
                    <option value="USD">USD</option>
                </select>
            </div>
            <label>Annual Dividend per Share</label>
            <div class="currency-row">
                <input type="number" step="0.01" id="dividend">
                <select id="dividendCurrency">
                    <option value="DKK">DKK</option>
                    <option value="EUR">EUR</option>
                    <option value="USD">USD</option>
                </select>
            </div>
            <button class="btn" id="saveBtn">Save</button>
            <button class="btn" id="deleteBtn" style="display:none;background:#ff4466;margin-top:10px;">Delete</button>
        </div>
    </div>
    
    <div class="bottom-nav">
        <button class="nav-btn">Dashboard</button>
        <button class="nav-btn" id="refreshBtn">â†» Refresh</button>
        <button class="nav-btn" id="exportBtn">Export</button>
    </div>
    
    <script>
        var data = JSON.parse(localStorage.getItem('portfolio') || '{"holdings":[],"lastUpdate":null}');
        var editing = null;
        var isRefreshing = false;
        
        // Exchange rates (update these periodically)
        var rates = {
            'DKK': 1,
            'EUR': 7.46,  // 1 EUR = 7.46 DKK
            'USD': 6.88   // 1 USD = 6.88 DKK
        };
        
        function convertToDKK(amount, currency) {
            return amount * rates[currency];
        }
        
        function convertFromDKK(amountDKK, currency) {
            return amountDKK / rates[currency];
        }
        
        // Add button
        document.getElementById('addBtn').onclick = function() {
            editing = null;
            document.getElementById('modalTitle').textContent = 'Add Holding';
            document.getElementById('deleteBtn').style.display = 'none';
            clearForm();
            document.getElementById('modal').classList.add('show');
        };
        
        // Close button
        document.getElementById('closeBtn').onclick = function() {
            document.getElementById('modal').classList.remove('show');
        };
        
        // Save button
        document.getElementById('saveBtn').onclick = function() {
            var costAmount = parseFloat(document.getElementById('cost').value);
            var costCurrency = document.getElementById('costCurrency').value;
            var costInDKK = convertToDKK(costAmount, costCurrency);
            
            var priceAmount = parseFloat(document.getElementById('currentPrice').value);
            var priceCurrency = document.getElementById('priceCurrency').value;
            var priceInDKK = priceAmount ? convertToDKK(priceAmount, priceCurrency) : null;
            
            var divAmount = parseFloat(document.getElementById('dividend').value) || 0;
            var divCurrency = document.getElementById('dividendCurrency').value;
            var divInDKK = convertToDKK(divAmount, divCurrency);
            
            var h = {
                id: editing || Date.now(),
                ticker: document.getElementById('ticker').value.toUpperCase(),
                name: document.getElementById('name').value,
                shares: parseFloat(document.getElementById('shares').value),
                cost: costInDKK,
                costOriginal: costAmount,
                costCurrency: costCurrency,
                dividend: divInDKK,
                dividendOriginal: divAmount,
                dividendCurrency: divCurrency,
                price: priceInDKK,
                priceOriginal: priceAmount || null,
                priceCurrency: priceCurrency,
                manualPrice: priceAmount ? true : false,
                autoFetch: !priceAmount,
                lastFetched: null,
                fetchError: false
            };
            
            if (editing) {
                for (var i = 0; i < data.holdings.length; i++) {
                    if (data.holdings[i].id === editing) {
                        data.holdings[i] = h;
                        break;
                    }
                }
            } else {
                data.holdings.push(h);
            }
            
            localStorage.setItem('portfolio', JSON.stringify(data));
            document.getElementById('modal').classList.remove('show');
            render();
            
            // Auto-fetch price if not manual
            if (!priceAmount) {
                fetchPriceForHolding(h);
            }
        };
        
        // Delete button
        document.getElementById('deleteBtn').onclick = function() {
            if (confirm('Delete this holding?')) {
                var newHoldings = [];
                for (var i = 0; i < data.holdings.length; i++) {
                    if (data.holdings[i].id !== editing) {
                        newHoldings.push(data.holdings[i]);
                    }
                }
                data.holdings = newHoldings;
                localStorage.setItem('portfolio', JSON.stringify(data));
                document.getElementById('modal').classList.remove('show');
                render();
            }
        };
        
        // Refresh button - WORKING VERSION
        document.getElementById('refreshBtn').onclick = function() {
            if (isRefreshing) return;
            
            var btn = this;
            btn.textContent = 'Updating...';
            btn.disabled = true;
            isRefreshing = true;
            
            var index = 0;
            
            function fetchNext() {
                if (index >= data.holdings.length) {
                    data.lastUpdate = new Date().toISOString();
                    localStorage.setItem('portfolio', JSON.stringify(data));
                    btn.textContent = 'â†» Refresh';
                    btn.disabled = false;
                    isRefreshing = false;
                    render();
                    return;
                }
                
                var h = data.holdings[index];
                index++;
                
                if (h.autoFetch && !h.manualPrice) {
                    fetchPriceForHolding(h, fetchNext);
                } else {
                    setTimeout(fetchNext, 100);
                }
            }
            
            fetchNext();
        };
        
        // Export button
        document.getElementById('exportBtn').onclick = function() {
            var json = JSON.stringify(data, null, 2);
            var blob = new Blob([json], {type: 'application/json'});
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'portfolio.json';
            a.click();
        };
        
        // Fetch price for a holding
        function fetchPriceForHolding(holding, callback) {
            fetch('https://query1.finance.yahoo.com/v8/finance/chart/' + holding.ticker + '?interval=1d&range=1d')
                .then(function(r) { return r.json(); })
                .then(function(d) {
                    if (d.chart && d.chart.result && d.chart.result[0]) {
                        var meta = d.chart.result[0].meta;
                        var fetchedPrice = meta.regularMarketPrice || meta.previousClose;
                        
                        if (fetchedPrice && fetchedPrice > 0) {
                            // Determine currency from ticker
                            var fetchCurrency = 'DKK';
                            if (holding.ticker.indexOf('.CO') > -1) {
                                fetchCurrency = 'DKK';
                            } else if (holding.priceCurrency) {
                                fetchCurrency = holding.priceCurrency;
                            } else {
                                fetchCurrency = 'USD'; // Default to USD for US stocks
                            }
                            
                            holding.price = convertToDKK(fetchedPrice, fetchCurrency);
                            holding.priceOriginal = fetchedPrice;
                            holding.priceCurrency = fetchCurrency;
                            holding.fetchError = false;
                            holding.lastFetched = new Date().toISOString();
                        } else {
                            holding.fetchError = true;
                        }
                    } else {
                        holding.fetchError = true;
                    }
                    
                    localStorage.setItem('portfolio', JSON.stringify(data));
                    render();
                    if (callback) setTimeout(callback, 300);
                })
                .catch(function(e) {
                    console.error('Failed to fetch ' + holding.ticker, e);
                    holding.fetchError = true;
                    localStorage.setItem('portfolio', JSON.stringify(data));
                    render();
                    if (callback) setTimeout(callback, 300);
                });
        }
        
        function clearForm() {
            document.getElementById('ticker').value = '';
            document.getElementById('name').value = '';
            document.getElementById('shares').value = '';
            document.getElementById('cost').value = '';
            document.getElementById('currentPrice').value = '';
            document.getElementById('dividend').value = '';
            document.getElementById('costCurrency').value = 'DKK';
            document.getElementById('priceCurrency').value = 'DKK';
            document.getElementById('dividendCurrency').value = 'DKK';
        }
        
        function editHolding(id) {
            editing = id;
            var h = null;
            for (var i = 0; i < data.holdings.length; i++) {
                if (data.holdings[i].id === id) {
                    h = data.holdings[i];
                    break;
                }
            }
            if (!h) return;
            
            document.getElementById('modalTitle').textContent = 'Edit Holding';
            document.getElementById('deleteBtn').style.display = 'block';
            document.getElementById('ticker').value = h.ticker;
            document.getElementById('name').value = h.name;
            document.getElementById('shares').value = h.shares;
            document.getElementById('cost').value = h.costOriginal || h.cost;
            document.getElementById('costCurrency').value = h.costCurrency || 'DKK';
            document.getElementById('currentPrice').value = h.manualPrice ? (h.priceOriginal || '') : '';
            document.getElementById('priceCurrency').value = h.priceCurrency || 'DKK';
            document.getElementById('dividend').value = h.dividendOriginal || h.dividend;
            document.getElementById('dividendCurrency').value = h.dividendCurrency || 'DKK';
            document.getElementById('modal').classList.add('show');
        }
        
        function fmt(n) {
            return Math.round(n).toLocaleString('da-DK') + ' DKK';
        }
        
        function render() {
            var html = '';
            var totalVal = 0, totalCost = 0, totalDiv = 0;
            
            if (data.holdings.length === 0) {
                html = '<div style="text-align:center;padding:60px 20px;color:#9ba5b8;">No holdings yet<br><br><button class="btn" onclick="document.getElementById(\'addBtn\').click()">Add First Holding</button></div>';
            } else {
                for (var i = 0; i < data.holdings.length; i++) {
                    var h = data.holdings[i];
                    var price = h.price || h.cost;
                    var val = price * h.shares;
                    var costVal = h.cost * h.shares;
                    var chg = val - costVal;
                    var pct = (chg / costVal * 100).toFixed(1);
                    var annualYield = h.dividend * h.shares;
                    
                    totalVal += val;
                    totalCost += costVal;
                    totalDiv += h.dividend * h.shares;
                    
                    var statusText = '';
                    var statusClass = '';
                    if (h.manualPrice) {
                        statusText = 'ðŸ“ Manual price';
                        statusClass = 'manual-price';
                    } else if (h.fetchError) {
                        statusText = 'âš ï¸ Auto-fetch failed - tap to set manually';
                        statusClass = 'failed';
                    } else if (h.lastFetched) {
                        statusText = 'âœ“ Live price';
                        statusClass = 'live';
                    } else if (h.autoFetch) {
                        statusText = 'â³ Will auto-update';
                        statusClass = '';
                    } else {
                        statusText = 'ðŸ’¤ Using cost basis';
                        statusClass = '';
                    }
                    
                    var color = chg >= 0 ? 'positive' : 'negative';
                    
                    var costDisplay = h.costCurrency && h.costCurrency !== 'DKK' ? 
                        Math.round(h.costOriginal).toLocaleString('da-DK') + ' ' + h.costCurrency + ' â†’ ' + fmt(costVal) :
                        fmt(costVal);
                    
                    html += '<div class="holding" onclick="editHolding(' + h.id + ')">';
                    html += '<div class="holding-header">';
                    html += '<div class="ticker">' + h.ticker + '</div>';
                    html += '<div>' + fmt(val) + '</div>';
                    html += '</div>';
                    html += '<div class="meta">' + h.shares + ' shares Â· Cost: ' + costDisplay + '</div>';
                    html += '<div class="meta ' + color + '">' + (chg >= 0 ? '+' : '') + fmt(chg) + ' (' + (chg >= 0 ? '+' : '') + pct + '%)</div>';
                    html += '<div class="meta">Annual income: ' + fmt(annualYield) + '</div>';
                    html += '<div class="status meta ' + statusClass + '">' + statusText + '</div>';
                    html += '</div>';
                }
            }
            
            document.getElementById('holdings').innerHTML = html;
            
            var totChg = totalVal - totalCost;
            var totPct = totalCost > 0 ? (totChg / totalCost * 100).toFixed(1) : 0;
            var yld = totalVal > 0 ? (totalDiv / totalVal * 100).toFixed(2) : 0;
            
            document.getElementById('totalValue').textContent = fmt(totalVal);
            var color2 = totChg >= 0 ? 'positive' : 'negative';
            document.getElementById('totalChange').innerHTML = '<span class="' + color2 + '">' + (totChg >= 0 ? '+' : '') + fmt(totChg) + ' (' + (totChg >= 0 ? '+' : '') + totPct + '%)</span>';
            document.getElementById('annualIncome').textContent = fmt(totalDiv);
            document.getElementById('yieldPercent').textContent = yld + '%';
            
            if (data.lastUpdate) {
                var now = new Date();
                var then = new Date(data.lastUpdate);
                var diff = now - then;
                var min = Math.floor(diff / 60000);
                document.getElementById('lastUpdate').textContent = min < 1 ? 'Just now' : min < 60 ? min + 'm ago' : Math.floor(min/60) + 'h ago';
            }
        }
        
        // Initial render
        render();
        
        // Auto-fetch on load if needed
        setTimeout(function() {
            for (var i = 0; i < data.holdings.length; i++) {
                if (data.holdings[i].autoFetch && !data.holdings[i].lastFetched) {
                    fetchPriceForHolding(data.holdings[i]);
                }
            }
        }, 1000);
        
        // Auto-refresh every 5 minutes
        setInterval(function() {
            if (!isRefreshing && data.holdings.length > 0) {
                document.getElementById('refreshBtn').click();
            }
        }, 300000);
    </script>
</body>
</html>
