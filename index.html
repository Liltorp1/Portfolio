<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passive Income Portfolio</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #0a0e1a; color: #e8edf4; padding: 20px 20px 100px; min-height: 100vh; }
        h1 { font-size: 28px; margin-bottom: 10px; }
        .card { background: #1a2237; border: 1px solid #2a3550; border-radius: 12px; padding: 20px; margin-bottom: 15px; }
        .income-split { display: flex; gap: 20px; align-items: center; margin: 10px 0; }
        .income-item { flex: 1; text-align: center; }
        .income-label { font-size: 11px; color: #9ba5b8; text-transform: uppercase; margin-bottom: 6px; font-weight: 600; letter-spacing: 0.5px; }
        .income-value { font-size: 24px; font-weight: 300; color: #e8edf4; }
        .income-divider { width: 1px; height: 50px; background: #2a3550; }
        .yield-metrics { display: flex; gap: 20px; justify-content: center; margin-top: 10px; padding-top: 10px; border-top: 1px solid #2a3550; }
        .yield-metric { display: flex; align-items: center; gap: 6px; }
        .yield-label { font-size: 12px; color: #9ba5b8; }
        .yield-value { font-size: 14px; font-weight: 600; color: #00ff88; }
        .monthly-calendar { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-top: 10px; }
        .calendar-month { background: #0a0e1a; border: 1px solid #2a3550; border-radius: 8px; padding: 12px; text-align: center; transition: all 0.2s; }
        .calendar-month:hover { background: #151b2e; border-color: #4d94ff; }
        .calendar-month-name { font-size: 11px; color: #9ba5b8; text-transform: uppercase; font-weight: 600; margin-bottom: 6px; letter-spacing: 0.5px; }
        .calendar-month-amount { font-size: 18px; font-weight: 600; color: #e8edf4; }
        .calendar-month-amount.has-income { color: #00ff88; }
        .calendar-month-amount.zero { color: #9ba5b8; opacity: 0.5; }
        .income-growth-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .income-growth-header h3 { margin: 0; font-size: 18px; }
        .time-range-toggles { display: flex; gap: 6px; }
        .time-toggle { padding: 6px 12px; background: #0a0e1a; border: 1px solid #2a3550; border-radius: 6px; color: #9ba5b8; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .time-toggle:hover { background: #151b2e; border-color: #4d94ff; }
        .time-toggle.active { background: #4d94ff; color: white; border-color: #4d94ff; }
        .growth-stats { display: flex; gap: 20px; margin-bottom: 15px; padding: 12px; background: #0a0e1a; border-radius: 8px; }
        .growth-stat { flex: 1; text-align: center; }
        .growth-stat-label { font-size: 11px; color: #9ba5b8; text-transform: uppercase; margin-bottom: 4px; }
        .growth-stat-value { font-size: 18px; font-weight: 600; }
        .growth-stat-value.positive { color: #00ff88; }
        .growth-stat-value.negative { color: #ff4466; }
        .income-growth-chart { position: relative; height: 200px; margin-top: 10px; }
        .chart-svg { width: 100%; height: 100%; }
        .chart-line { fill: none; stroke: #4d94ff; stroke-width: 2; }
        .chart-area { fill: url(#gradient); opacity: 0.3; }
        .chart-dot { fill: #4d94ff; cursor: pointer; }
        .chart-dot:hover { fill: #00ff88; }
        .chart-grid { stroke: #2a3550; stroke-width: 1; }
        .chart-label { fill: #9ba5b8; font-size: 11px; }
        .chart-tooltip { position: absolute; background: #1a2237; border: 1px solid #4d94ff; border-radius: 6px; padding: 8px 12px; pointer-events: none; display: none; z-index: 100; }
        .chart-tooltip.show { display: block; }
        .label { font-size: 12px; color: #9ba5b8; text-transform: uppercase; margin-bottom: 8px; }
        .value { font-size: 32px; font-weight: 300; margin-bottom: 5px; }
        .change { font-size: 14px; color: #9ba5b8; }
        .positive { color: #00ff88; }
        .negative { color: #ff4466; }
        .btn { background: #4d94ff; color: white; border: none; border-radius: 10px; padding: 14px 24px; font-size: 16px; width: 100%; cursor: pointer; }
        .btn:active { opacity: 0.8; }
        .btn-small { width: auto; padding: 10px 20px; font-size: 14px; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); padding: 20px; overflow-y: auto; z-index: 1000; }
        .modal.show { display: block; }
        .modal-content { background: #1a2237; border-radius: 16px; padding: 24px; max-width: 500px; margin: 40px auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close { font-size: 30px; color: #9ba5b8; cursor: pointer; background: none; border: none; }
        input, select, textarea { width: 100%; background: #0a0e1a; border: 1px solid #2a3550; border-radius: 8px; padding: 12px; color: #e8edf4; font-size: 16px; margin-bottom: 15px; font-family: inherit; }
        textarea { min-height: 60px; resize: vertical; }
        label { display: block; font-size: 14px; color: #9ba5b8; margin-bottom: 5px; }
        .holding { background: #1a2237; border: 1px solid #2a3550; border-radius: 10px; padding: 15px; margin-bottom: 10px; cursor: pointer; }
        .holding:active { background: #202840; }
        .holding-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .holding-name { font-size: 18px; font-weight: 600; }
        .meta { font-size: 12px; color: #9ba5b8; margin-top: 4px; }
        .section-title { font-size: 12px; text-transform: uppercase; color: #9ba5b8; margin: 20px 0 15px; display: flex; justify-content: space-between; align-items: center; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: #151b2e; padding: 12px; display: flex; gap: 8px; }
        .nav-btn { flex: 1; padding: 12px; background: #1a2237; border-radius: 8px; color: #9ba5b8; font-size: 14px; cursor: pointer; border: none; }
        .status { font-size: 10px; margin-top: 3px; }
        .edit-price-btn { background: #4d94ff; color: white; border: none; border-radius: 6px; padding: 6px 12px; font-size: 11px; cursor: pointer; margin-left: 8px; font-weight: 600; }
        .edit-price-btn:hover { background: #3d7fe6; }
        .edit-price-btn:active { transform: scale(0.95); }
        .inline-price-editor { display: flex; gap: 8px; align-items: center; margin-top: 8px; padding: 10px; background: #0a0e1a; border-radius: 6px; }
        .inline-price-input { width: 120px; padding: 6px 10px; background: #1a2237; border: 1px solid #4d94ff; border-radius: 4px; color: #e8edf4; font-size: 14px; }
        .inline-price-currency { width: 70px; padding: 6px 10px; background: #1a2237; border: 1px solid #2a3550; border-radius: 4px; color: #e8edf4; font-size: 14px; }
        .inline-price-save { background: #00ff88; color: #0a0e1a; border: none; border-radius: 4px; padding: 6px 12px; font-size: 12px; cursor: pointer; font-weight: 600; }
        .inline-price-cancel { background: #2a3550; color: #e8edf4; border: none; border-radius: 4px; padding: 6px 12px; font-size: 12px; cursor: pointer; }
        body.light .edit-price-btn { background: #007bff; }
        body.light .edit-price-btn:hover { background: #0056b3; }
        body.light .inline-price-editor { background: #f8f9fa; }
        body.light .inline-price-input { background: #ffffff; border-color: #007bff; color: #212529; }
        body.light .inline-price-currency { background: #ffffff; border-color: #dee2e6; color: #212529; }
        body.light .inline-price-save { background: #28a745; color: white; }
        body.light .inline-price-cancel { background: #6c757d; color: white; }
        .currency-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .currency-row input { flex: 2; margin-bottom: 0; }
        .currency-row select { flex: 1; margin-bottom: 0; }
        .live { color: #00ff88; }
        .manual-badge { color: #ffc044; }
        .failed { color: #ff4466; }
        .badge { padding: 2px 8px; border-radius: 4px; font-size: 10px; margin-left: 6px; font-weight: 600; }
        .badge-fund { background: #2a3550; color: #9ba5b8; }
        .badge-rsu { background: #2a3550; color: #9ba5b8; }
        .badge-property { background: #4d94ff; color: white; }
        .badge-savings { background: #00ff88; color: #0a0e1a; }
        .badge-manual { background: #ffc044; color: #0a0e1a; font-weight: 600; cursor: help; }
        .badge-manual:hover { background: #ffb020; }
        .info-text { font-size: 12px; color: #9ba5b8; margin-top: -10px; margin-bottom: 15px; font-style: italic; }
        .next-update { font-size: 11px; color: #9ba5b8; margin-top: 5px; }
        .loading-indicator { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background: #1a2237; padding: 20px 40px; border-radius: 12px; border: 2px solid #4d94ff; z-index: 2000; display: none; }
        .loading-indicator.show { display: block; }
        .error-list { background: #ff446620; border: 1px solid #ff4466; border-radius: 8px; padding: 12px; margin: 15px 0; font-size: 12px; }
        .chart-container { position: relative; max-height: 250px; }
        #historyChart { width: 100%; height: 300px; display: block; }
        .cost-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .cost-item label { font-size: 12px; margin-bottom: 5px; }
        .cost-item input { margin-bottom: 0; }
        .currency-selector { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; padding: 12px; background: #1a2237; border: 1px solid #2a3550; border-radius: 10px; }
        .currency-selector label { font-size: 12px; color: #9ba5b8; text-transform: uppercase; margin: 0; }
        .currency-selector select { width: auto; padding: 8px 12px; margin: 0; font-size: 14px; }
        .chat-container { position: fixed; bottom: 80px; right: 20px; width: 380px; max-width: calc(100vw - 40px); height: 500px; background: #1a2237; border: 1px solid #2a3550; border-radius: 16px; display: none; flex-direction: column; z-index: 999; box-shadow: 0 8px 32px rgba(0,0,0,0.4); }
        .chat-container.show { display: flex; }
        .chat-header { padding: 16px; border-bottom: 1px solid #2a3550; display: flex; justify-content: space-between; align-items: center; }
        .chat-header h3 { font-size: 16px; margin: 0; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
        .chat-message { padding: 12px; border-radius: 8px; max-width: 85%; word-wrap: break-word; line-height: 1.5; }
        .chat-message.user { background: #4d94ff; color: white; align-self: flex-end; }
        .chat-message.assistant { background: #2a3550; color: #e8edf4; align-self: flex-start; }
        .chat-input-container { padding: 12px; border-top: 1px solid #2a3550; display: flex; gap: 8px; }
        .chat-input { flex: 1; background: #0a0e1a; border: 1px solid #2a3550; border-radius: 8px; padding: 10px; color: #e8edf4; font-size: 14px; margin: 0; }
        .chat-send-btn { background: #4d94ff; color: white; border: none; border-radius: 8px; padding: 10px 20px; cursor: pointer; font-size: 14px; }
        .chat-send-btn:disabled { opacity: 0.5; }
        .typing-indicator { padding: 12px; background: #2a3550; border-radius: 8px; align-self: flex-start; }
        .typing-indicator span { display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #9ba5b8; margin: 0 2px; animation: typing 1.4s infinite; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%,60%,100% { opacity:0.3; } 30% { opacity:1; } }
        .settings-section { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #2a3550; }
        .settings-section:last-child { border-bottom: none; }
        .settings-section h4 { margin-bottom: 10px; font-size: 14px; }
        .btn-secondary { background: #2a3550; margin-top: 10px; }
        .warning-text { color: #ffc044; font-size: 12px; margin-top: 5px; }
        .btn-group { display: flex; gap: 10px; }
        .btn-group .btn { flex: 1; }
        #theme-toggle { position: fixed; top: 1rem; right: 1rem; z-index: 1000; padding: 0.5rem 1rem; background: #4d94ff; color: white; border: none; border-radius: 6px; cursor: pointer; }
        input[type="file"] { display: none; }

```
    /* Multi-select filter styles */
    .filter-section { margin-bottom: 20px; }
    .filter-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .filter-title { font-size: 12px; color: #9ba5b8; text-transform: uppercase; font-weight: 600; }
    .clear-filters-btn { padding: 6px 12px; background: transparent; color: #9ba5b8; border: 1px solid #2a3550; border-radius: 6px; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s; text-transform: uppercase; letter-spacing: 0.5px; }
    .clear-filters-btn:hover { background: #2a3550; color: #e8edf4; border-color: #4d94ff; }
    .clear-filters-btn:active { transform: scale(0.95); }
    .filter-presets { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
    .preset-btn { padding: 8px 14px; background: linear-gradient(135deg, #4d94ff 0%, #3d7fe6 100%); color: white; border: none; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
    .preset-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(77, 148, 255, 0.3); }
    .preset-btn:active { transform: translateY(0); }
    .filter-checkboxes { display: flex; gap: 12px; flex-wrap: wrap; }
    .filter-checkbox { display: flex; align-items: center; gap: 8px; padding: 8px 14px; background: #1a2237; border: 1px solid #2a3550; border-radius: 8px; cursor: pointer; transition: all 0.2s; user-select: none; }
    .filter-checkbox:hover { background: #202840; }
    .filter-checkbox input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; accent-color: #4d94ff; }
    .filter-checkbox span { font-size: 13px; color: #e8edf4; font-weight: 500; }
    .filter-checkbox input[type="checkbox"]:checked + span { color: #4d94ff; font-weight: 600; }
    .filter-checkbox:has(input:checked) { background: #1a2850; border-color: #4d94ff; }
    
    .holdings-container { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    /* Light mode */
    body.light { background: #f8f9fa; color: #212529; }
    body.light .card, body.light .holding, body.light .modal-content, body.light .chat-container, body.light .loading-indicator { background: #ffffff; border-color: #dee2e6; }
    body.light input, body.light select, body.light textarea { background: #f8f9fa; color: #212529; border-color: #ced4da; }
    body.light .bottom-nav { background: #ffffff; border-top: 1px solid #dee2e6; }
    body.light .nav-btn { background: #ffffff; color: #495057; }
    body.light .currency-selector { background: #ffffff; border-color: #dee2e6; }
    body.light .income-value { color: #212529; }
    body.light .income-divider { background: #dee2e6; }
    body.light .yield-metrics { border-top-color: #dee2e6; }
    body.light .yield-value { color: #28a745; }
    body.light #goalType, body.light #goalCurrency, body.light #goalTarget, body.light #goalLabel { background: #ffffff; border-color: #dee2e6; color: #212529; }
    .goal-progress-bar { width: 100%; height: 8px; background: #2a3550; border-radius: 4px; overflow: hidden; margin-top: 10px; }
    .goal-progress-fill { height: 100%; background: #4d94ff; border-radius: 4px; transition: width 0.3s ease; }
    body.light .goal-progress-bar { background: #e9ecef; }
    body.light .goal-progress-fill { background: #007bff; }
    .goal-actions { display: flex; gap: 6px; }
    .goal-edit-btn, .goal-delete-btn { padding: 4px 10px; font-size: 11px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; }
    .goal-edit-btn { background: #4d94ff; color: white; }
    .goal-edit-btn:hover { background: #3d84ef; }
    .goal-delete-btn { background: #dc3545; color: white; }
    .goal-delete-btn:hover { background: #c82333; }
    .goal-completed { border: 2px solid #00ff88 !important; background: #0d1a14 !important; }
    .goal-completed-badge { display: inline-block; padding: 3px 8px; background: #00ff88; color: #0a0e1a; border-radius: 4px; font-size: 11px; font-weight: 600; margin-left: 8px; }
    .goal-checkmark { font-size: 18px; color: #00ff88; margin-right: 6px; }
    body.light .goal-completed { border-color: #28a745 !important; background: #d4edda !important; }
    body.light .goal-completed-badge { background: #28a745; color: white; }
    body.light .goal-checkmark { color: #28a745; }
    .goal-toast { position: fixed; top: 80px; right: 20px; background: #00ff88; color: #0a0e1a; padding: 16px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,255,136,0.3); font-weight: 600; z-index: 10000; animation: slideIn 0.3s ease; }
    .goal-toast-icon { font-size: 20px; margin-right: 10px; }
    @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    body.light .goal-toast { background: #28a745; color: white; box-shadow: 0 4px 12px rgba(40,167,69,0.3); }
    .simulator-panel { background: #1a2237; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
    .simulator-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; margin-bottom: 15px; }
    .simulator-header h3 { margin: 0; }
    .simulator-toggle { font-size: 20px; color: #9ba5b8; transition: transform 0.3s ease; }
    .simulator-toggle.open { transform: rotate(180deg); }
    .simulator-content { display: none; }
    .simulator-content.show { display: block; }
    .simulator-section { margin-bottom: 20px; padding: 15px; background: #0a0e1a; border-radius: 6px; }
    .simulator-section h4 { margin: 0 0 12px 0; font-size: 14px; color: #9ba5b8; text-transform: uppercase; }
    .simulator-input-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
    .simulator-input { width: 100%; padding: 8px 12px; background: #1a2237; border: 1px solid #2a3550; border-radius: 4px; color: #e8edf4; font-size: 14px; }
    .simulator-btn { width: 100%; padding: 12px; background: #4d94ff; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 14px; }
    .simulator-btn:hover { background: #3d84ef; }
    body.light .simulator-panel { background: #f8f9fa; }
    body.light .simulator-section { background: #ffffff; border: 1px solid #dee2e6; }
    body.light .simulator-input { background: #ffffff; border-color: #ced4da; color: #212529; }
    body.light .simulator-btn { background: #007bff; }
    body.light .simulator-btn:hover { background: #0056b3; }
    .simulator-results { margin-top: 20px; padding: 20px; background: #0a0e1a; border-radius: 8px; display: none; }
    .simulator-results.show { display: block; }
    .simulator-results h4 { margin: 0 0 15px 0; color: #4d94ff; font-size: 16px; }
    .result-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }
    .result-item { background: #1a2237; padding: 12px; border-radius: 6px; }
    .result-label { font-size: 11px; color: #9ba5b8; text-transform: uppercase; margin-bottom: 4px; }
    .result-value { font-size: 18px; font-weight: 600; color: #e8edf4; margin-bottom: 4px; }
    .result-diff { font-size: 13px; font-weight: 600; }
    .result-diff.positive { color: #00ff88; }
    .result-diff.negative { color: #ff4466; }
    body.light .simulator-results { background: #ffffff; border: 1px solid #dee2e6; }
    body.light .result-item { background: #f8f9fa; border: 1px solid #dee2e6; }
    body.light .result-diff.positive { color: #28a745; }
    body.light .result-diff.negative { color: #dc3545; }
    .simulator-presets { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; }
    .preset-btn { padding: 8px 14px; background: #2a3550; color: #e8edf4; border: 1px solid #3a4560; border-radius: 6px; font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
    .preset-btn:hover { background: #3a4560; border-color: #4d94ff; }
    body.light .preset-btn { background: #e9ecef; color: #495057; border-color: #ced4da; }
    body.light .preset-btn:hover { background: #dee2e6; border-color: #007bff; }
    body.light .calendar-month { background: #f8f9fa; border-color: #dee2e6; }
    body.light .calendar-month:hover { background: #e9ecef; border-color: #007bff; }
    body.light .calendar-month-amount { color: #212529; }
    body.light .calendar-month-amount.has-income { color: #28a745; }
    body.light .calendar-month-amount.zero { color: #6c757d; }
    body.light .time-toggle { background: #f8f9fa; border-color: #dee2e6; color: #6c757d; }
    body.light .time-toggle:hover { background: #e9ecef; border-color: #007bff; }
    body.light .time-toggle.active { background: #007bff; color: white; border-color: #007bff; }
    body.light .growth-stats { background: #f8f9fa; }
    body.light .growth-stat-value.positive { color: #28a745; }
    body.light .chart-grid { stroke: #dee2e6; }
    body.light .chart-label { fill: #6c757d; }
    body.light .chart-tooltip { background: #ffffff; border-color: #007bff; }
    body.light .chat-message.assistant { background: #f0f0f0; color: #212529; }
    body.light .chat-input { background: #ffffff; color: #212529; }
    body.light .settings-section { border-color: #dee2e6; }
    body.light #theme-toggle { background: #007bff; }
    body.light .clear-filters-btn { color: #6c757d; border-color: #dee2e6; }
    body.light .clear-filters-btn:hover { background: #f8f9fa; color: #212529; border-color: #007bff; }
    body.light .preset-btn { background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); }
    body.light .preset-btn:hover { box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3); }
    body.light .filter-checkbox { background: #ffffff; border-color: #dee2e6; }
    body.light .filter-checkbox:hover { background: #f8f9fa; }
    body.light .filter-checkbox span { color: #212529; }
    body.light .filter-checkbox input[type="checkbox"]:checked + span { color: #007bff; }
    body.light .filter-checkbox:has(input:checked) { background: #e7f3ff; border-color: #007bff; }
</style>
```

</head>
<body class="dark">

<button id="theme-toggle">‚òÄÔ∏è Light</button>

<div class="loading-indicator" id="loadingIndicator"><div>‚è≥ Updating prices...</div></div>

<h1>Passive Income</h1>
<div class="meta" id="lastUpdate" style="margin-bottom:5px;">Never updated</div>
<div class="next-update" id="nextUpdate">Next auto-update: calculating...</div>
<div id="errorContainer"></div>

<div class="currency-selector">
    <label for="displayCurrency">Display Currency:</label>
    <select id="displayCurrency">
        <option value="DKK">DKK</option>
        <option value="EUR">EUR</option>
        <option value="USD">USD</option>
    </select>
</div>

<div class="card">
    <div class="label">Portfolio Value <span id="filterLabel">(All)</span></div>
    <div class="value" id="totalValue">0 DKK</div>
    <div class="change" id="totalChange">‚Äî</div>
</div>

<div class="card">
    <div class="label">Income Projection <span id="incomeFilterLabel">(All)</span></div>
    <div class="income-split">
        <div class="income-item">
            <div class="income-label">Monthly</div>
            <div class="income-value" id="monthlyIncome">0 DKK</div>
        </div>
        <div class="income-divider"></div>
        <div class="income-item">
            <div class="income-label">Annual</div>
            <div class="income-value" id="annualIncome">0 DKK</div>
        </div>
    </div>
    <div class="yield-metrics">
        <div class="yield-metric">
            <span class="yield-label">Current Yield:</span>
            <span id="yieldPercent" class="yield-value">0.0%</span>
        </div>
        <div class="yield-metric">
            <span class="yield-label">Yield-on-Cost:</span>
            <span id="yieldOnCostPercent" class="yield-value">0.0%</span>
        </div>
    </div>
</div>

<div class="card">
    <h3 style="margin-bottom:15px;">Monthly Income Calendar</h3>
    <div id="monthlyCalendar" class="monthly-calendar"></div>
</div>

<div class="card">
    <div class="income-growth-header">
        <h3>Income Growth</h3>
        <div class="time-range-toggles">
            <button class="time-toggle active" data-range="30">30D</button>
            <button class="time-toggle" data-range="365">1Y</button>
            <button class="time-toggle" data-range="all">All</button>
        </div>
    </div>
    <div id="incomeGrowthStats" class="growth-stats"></div>
    <div id="incomeGrowthChart" class="income-growth-chart"></div>
</div>

<div class="card">
    <div class="income-growth-header">
        <h3>Portfolio History</h3>
        <div class="time-range-toggles">
            <button class="history-range-toggle active" data-range="30d">30D</button>
            <button class="history-range-toggle" data-range="12m">12M</button>
            <button class="history-range-toggle" data-range="all">All</button>
        </div>
    </div>
    <div style="margin-bottom:15px;">
        <label for="historyMetric" style="font-size:12px;color:#9ba5b8;margin-right:10px;">Show:</label>
        <select id="historyMetric" style="padding:6px 10px;background:#1a2237;border:1px solid #2a3550;border-radius:4px;color:#e8edf4;font-size:14px;">
            <option value="value">Total Value</option>
            <option value="income">Annual Income</option>
            <option value="yield">Yield %</option>
        </select>
    </div>
    <canvas id="historyChart" width="800" height="300"></canvas>
</div>

<div class="card">
    <h3 style="margin-bottom:15px;">Portfolio Allocation</h3>
    <div class="chart-container"><canvas id="allocationChart"></canvas></div>
</div>

<div class="card">
    <div class="simulator-panel">
        <div class="simulator-header" onclick="toggleSimulator()">
            <h3>Scenario Simulator</h3>
            <span class="simulator-toggle" id="simulatorToggle">‚ñº</span>
        </div>

```
    <div class="simulator-content" id="simulatorContent">
        <!-- Quick Presets -->
        <div class="simulator-presets">
            <button class="preset-btn" onclick="applyPreset('monthly2000')">üí∞ Invest 2,000 DKK/month</button>
            <button class="preset-btn" onclick="applyPreset('monthly5000')">üí∞ Invest 5,000 DKK/month</button>
            <button class="preset-btn" onclick="applyPreset('yield1')">üìà Increase yield by 1%</button>
            <button class="preset-btn" onclick="applyPreset('yield2')">üìà Increase yield by 2%</button>
            <button class="preset-btn" onclick="applyPreset('buyShares')">üõí Buy 10 shares</button>
        </div>
        
        <div class="simulator-section">
            <h4>Monthly Investment</h4>
            <div style="margin-bottom:10px;">
                <label style="font-size:12px;color:#9ba5b8;display:block;margin-bottom:4px;">Monthly Amount (DKK)</label>
                <input type="number" id="simMonthlyAmount" class="simulator-input" placeholder="e.g., 2000">
            </div>
            <div style="font-size:12px;color:#9ba5b8;">Simulate investing a fixed amount every month</div>
        </div>
        
        <!-- Yield Change Scenario -->
        <div class="simulator-section">
            <h4>Yield Change</h4>
            <div style="margin-bottom:10px;">
                <label style="font-size:12px;color:#9ba5b8;display:block;margin-bottom:4px;">Yield Increase (%)</label>
                <input type="number" id="simYieldIncrease" class="simulator-input" placeholder="e.g., 1" step="0.1">
            </div>
            <div style="font-size:12px;color:#9ba5b8;">Simulate a percentage increase in dividend yield</div>
        </div>
        
        <!-- Buy More Shares Scenario -->
        <div class="simulator-section">
            <h4>Buy More Shares</h4>
            <div class="simulator-input-group">
                <div>
                    <label style="font-size:12px;color:#9ba5b8;display:block;margin-bottom:4px;">Ticker</label>
                    <select id="simTicker" class="simulator-input">
                        <option value="">Select stock...</option>
                    </select>
                </div>
                <div>
                    <label style="font-size:12px;color:#9ba5b8;display:block;margin-bottom:4px;">Shares</label>
                    <input type="number" id="simShares" class="simulator-input" placeholder="e.g., 10">
                </div>
            </div>
            <div style="font-size:12px;color:#9ba5b8;">Simulate buying additional shares of a specific stock</div>
        </div>
        
        <button class="simulator-btn" onclick="runSimulation()">Run Simulation</button>
        
        <div class="simulator-results" id="simulatorResults">
            <h4>Simulation Results</h4>
            <div class="result-grid">
                <div class="result-item">
                    <div class="result-label">Total Value</div>
                    <div class="result-value" id="simResultValue">-</div>
                    <div class="result-diff" id="simResultValueDiff">-</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Annual Income</div>
                    <div class="result-value" id="simResultIncome">-</div>
                    <div class="result-diff" id="simResultIncomeDiff">-</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Yield</div>
                    <div class="result-value" id="simResultYield">-</div>
                    <div class="result-diff" id="simResultYieldDiff">-</div>
                </div>
            </div>
        </div>
    </div>
</div>
```

</div>

<div class="card">
    <h3 style="margin-bottom:15px;">Financial Goals</h3>

```
<div class="goal-form">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
        <div>
            <label style="font-size:12px;color:#9ba5b8;">Goal Type</label>
            <select id="goalType" style="width:100%;padding:8px;background:#1a2237;border:1px solid #2a3550;border-radius:4px;color:#e8edf4;">
                <option value="netWorth">Net Worth</option>
                <option value="savings">Savings</option>
                <option value="income">Annual Income</option>
            </select>
        </div>
        <div>
            <label style="font-size:12px;color:#9ba5b8;">Currency</label>
            <select id="goalCurrency" style="width:100%;padding:8px;background:#1a2237;border:1px solid #2a3550;border-radius:4px;color:#e8edf4;">
                <option value="DKK">DKK</option>
                <option value="EUR">EUR</option>
                <option value="USD">USD</option>
            </select>
        </div>
    </div>
    <div style="margin-bottom:10px;">
        <label style="font-size:12px;color:#9ba5b8;">Target Amount</label>
        <input type="number" id="goalTarget" placeholder="e.g., 1000000" style="width:100%;padding:8px;background:#1a2237;border:1px solid #2a3550;border-radius:4px;color:#e8edf4;">
    </div>
    <div style="margin-bottom:10px;">
        <label style="font-size:12px;color:#9ba5b8;">Label</label>
        <input type="text" id="goalLabel" placeholder="e.g., Reach 1M net worth" style="width:100%;padding:8px;background:#1a2237;border:1px solid #2a3550;border-radius:4px;color:#e8edf4;">
    </div>
    <button id="saveGoalBtn" class="btn" style="width:100%;background:#4d94ff;">Create Goal</button>
</div>

<div id="goalsList" style="margin-top:20px;"></div>
```

</div>

<div class="filter-section">
    <div class="filter-header">
        <span class="filter-title">FILTER BY TYPE</span>
        <button class="clear-filters-btn" id="clearFiltersBtn" title="Remove all filters and show all holdings">
            ‚úï Clear All
        </button>
    </div>

```
<div class="filter-presets">
    <button class="preset-btn" data-preset="liquid" title="Stocks + Savings">üíß Liquid Assets</button>
    <button class="preset-btn" data-preset="longterm" title="Property + Funds">üìà Long-term</button>
    <button class="preset-btn" data-preset="income" title="Stocks + Funds + Property">üí∞ Income Producers</button>
</div>

<div class="filter-checkboxes">
    <label class="filter-checkbox">
        <input type="checkbox" data-type="stock">
        <span>Stocks</span>
    </label>
    <label class="filter-checkbox">
        <input type="checkbox" data-type="fund">
        <span>Funds</span>
    </label>
    <label class="filter-checkbox">
        <input type="checkbox" data-type="rsu">
        <span>RSU</span>
    </label>
    <label class="filter-checkbox">
        <input type="checkbox" data-type="property">
        <span>Property</span>
    </label>
    <label class="filter-checkbox">
        <input type="checkbox" data-type="savings">
        <span>Savings</span>
    </label>
</div>
```

</div>

<div class="section-title">
    <span>HOLDINGS</span>
    <button class="btn btn-small" id="addBtn">+ Add</button>
</div>

<div style="margin:1rem 0;display:flex;gap:1rem;flex-wrap:wrap;">
    <input type="text" id="searchInput" placeholder="Search..." style="flex:1;min-width:150px;padding:0.5rem;">
    <select id="sortSelect" style="width:auto;min-width:150px;">
        <option value="value-desc">Value (High to Low)</option>
        <option value="value-asc">Value (Low to High)</option>
        <option value="yield-desc">Yield (High to Low)</option>
        <option value="name">Name (A-Z)</option>
    </select>
</div>

<div id="holdings" class="holdings-container"></div>

<div class="chat-container" id="chatContainer">
    <div class="chat-header">
        <h3>üí∞ Passive Income Advisor</h3>
        <button class="close" id="closeChatBtn">√ó</button>
    </div>
    <div class="chat-messages" id="chatMessages">
        <div class="chat-message assistant">
            üëã Hi! I am your passive income advisor. Ask me about your portfolio, dividends, property valuations, or savings rates!
        </div>
    </div>
    <div class="chat-input-container">
        <input type="text" class="chat-input" id="chatInput" placeholder="Ask about your portfolio...">
        <button class="chat-send-btn" id="chatSendBtn">Send</button>
    </div>
</div>

<div class="modal" id="settingsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Settings</h2>
            <button class="close" id="closeSettingsBtn">√ó</button>
        </div>
        <div class="settings-section">
            <h4>Import / Export</h4>
            <div class="btn-group">
                <button class="btn btn-secondary" id="exportBtn">Export</button>
                <button class="btn btn-secondary" id="importBtn">Import</button>
            </div>
        </div>
        <div class="settings-section">
            <h4>Manual Price Mode</h4>
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                <input type="checkbox" id="manualPriceToggle" style="width:auto;margin:0;">
                <label for="manualPriceToggle" style="margin:0;cursor:pointer;">Enable Manual Price Mode</label>
            </div>
            <div class="info-text">For stocks from unsupported exchanges (.CO, .MC, etc.), manually enter prices instead of API fetching.</div>
        </div>
        <div class="settings-section">
            <h4>Goal Notifications</h4>
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
                <input type="checkbox" id="goalNotificationsToggle" style="width:auto;margin:0;">
                <label for="goalNotificationsToggle" style="margin:0;cursor:pointer;">Notify me when a goal is reached</label>
            </div>
            <div class="info-text">Shows a toast notification when you reach 100% on any goal.</div>
        </div>
        <div class="settings-section">
            <h4>Data Management</h4>
            <button class="btn" id="clearAllData" style="background:#ff4466;">Clear All Data</button>
            <div class="warning-text">This deletes everything. Export first!</div>
        </div>
    </div>
</div>

<div class="modal" id="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Add Holding</h2>
            <button class="close" id="closeBtn">√ó</button>
        </div>

```
    <label>Type</label>
    <select id="type">
        <option value="stock">Stock (auto-updates)</option>
        <option value="fund">Fund (manual price)</option>
        <option value="rsu">RSU (auto-updates)</option>
        <option value="property">Property</option>
        <option value="savings">Savings / Cash</option>
    </select>

    <label>Name</label>
    <input type="text" id="name" placeholder="e.g. Apple, Copenhagen Apt, Savings Account">

    <div id="stockFields">
        <div id="tickerWrap">
            <label>Ticker Symbol</label>
            <input type="text" id="ticker" placeholder="e.g. AAPL, FLYW, IBE.MC">
        </div>
        <label>Shares</label>
        <input type="number" step="0.01" id="shares" placeholder="Number of shares">
        <label>Average Cost per Share</label>
        <div class="currency-row">
            <input type="number" step="0.01" id="cost" placeholder="Cost per share">
            <select id="costCurrency"><option>DKK</option><option>EUR</option><option>USD</option></select>
        </div>
        <label>Current Price (required for funds, optional for stocks)</label>
        <div id="priceHint" class="info-text">Stocks and RSU auto-update. Enter only as backup.</div>
        <div id="fundHint" class="info-text" style="display:none;">Funds: Required, will not auto-update.</div>
        <div class="currency-row">
            <input type="number" step="0.01" id="currentPrice" placeholder="Current price">
            <select id="priceCurrency"><option>DKK</option><option>EUR</option><option>USD</option></select>
        </div>
        <div id="manualPriceWrap" style="display:none;">
            <label>Manual Price (for unsupported exchanges)</label>
            <div class="info-text">Enter current price manually. This will be used instead of API fetching.</div>
            <div class="currency-row">
                <input type="number" step="0.01" id="manualPrice" placeholder="Manual price">
                <select id="manualPriceCurrency"><option>DKK</option><option>EUR</option><option>USD</option></select>
            </div>
        </div>
        <label>Annual Dividend per Share (0 if none)</label>
        <div class="currency-row">
            <input type="number" step="0.01" id="dividend" placeholder="0">
            <select id="dividendCurrency"><option>DKK</option><option>EUR</option><option>USD</option></select>
        </div>
        <label>Dividend/Income Frequency</label>
        <select id="dividendFrequency">
            <option value="none">None</option>
            <option value="monthly">Monthly</option>
            <option value="quarterly">Quarterly</option>
            <option value="semiannual">Semi-annual</option>
            <option value="annual" selected>Annual</option>
        </select>
        <div class="info-text">How often this holding pays dividends or income</div>
    </div>

    <div id="propertyFields" style="display:none;">
        <label>Address</label>
        <textarea id="address" placeholder="e.g. Vestergade 12, 1456 Kobenhavn K"></textarea>
        <label>Property Value</label>
        <div class="currency-row">
            <input type="number" step="0.01" id="propertyValue" placeholder="Market value">
            <select id="propertyCurrency"><option>DKK</option><option>EUR</option><option>USD</option></select>
        </div>
        <label>Annual Rental Income (0 if not rented)</label>
        <div class="currency-row">
            <input type="number" step="0.01" id="rentalIncome" placeholder="0">
            <select id="rentalCurrency"><option>DKK</option><option>EUR</option><option>USD</option></select>
        </div>
        <label>Annual Property Costs</label>
        <div class="cost-grid">
            <div class="cost-item"><label>Tax</label><input type="number" step="0.01" id="costTax" placeholder="0"></div>
            <div class="cost-item"><label>Power</label><input type="number" step="0.01" id="costPower" placeholder="0"></div>
            <div class="cost-item"><label>Water</label><input type="number" step="0.01" id="costWater" placeholder="0"></div>
            <div class="cost-item"><label>Gas</label><input type="number" step="0.01" id="costGas" placeholder="0"></div>
            <div class="cost-item"><label>Internet</label><input type="number" step="0.01" id="costInternet" placeholder="0"></div>
            <div class="cost-item"><label>Other</label><input type="number" step="0.01" id="costOther" placeholder="0"></div>
        </div>
        <label>Costs Currency</label>
        <select id="costsCurrency"><option>DKK</option><option>EUR</option><option>USD</option></select>
    </div>

    <div id="savingsFields" style="display:none;">
        <label>Amount Saved</label>
        <div class="currency-row">
            <input type="number" step="0.01" id="savingsAmount" placeholder="e.g. 100000">
            <select id="savingsCurrency"><option>DKK</option><option>EUR</option><option>USD</option></select>
        </div>
        <label>Annual Interest Rate % (0 if none)</label>
        <input type="number" step="0.01" id="interestRate" placeholder="e.g. 3.5">
        <div class="info-text">Enter 3.5 for 3.5 percent interest per year</div>
    </div>

    <button class="btn" id="saveBtn" style="margin-top:10px;">Save</button>
    <button class="btn" id="deleteBtn" style="display:none;background:#ff4466;margin-top:10px;">Delete</button>
</div>
```

</div>

<div class="bottom-nav">
    <button class="nav-btn" id="dashBtn">Dashboard</button>
    <button class="nav-btn" id="refreshBtn">Refresh</button>
    <button class="nav-btn" id="chatBtn">Chat</button>
    <button class="nav-btn" id="settingsBtn">Settings</button>
</div>

<input type="file" id="importFile" accept=".json">

<script>
// ============================================================================
// PASSIVE INCOME PORTFOLIO TRACKER
// ============================================================================
// Features:
// - Multi-asset tracking: Stocks, Funds, RSU, Property, Savings
// - Multi-currency support: DKK, EUR, USD
// - Income forecasting: Monthly projections, dividend calendar, growth tracking
// - Yield metrics: Current yield, yield-on-cost
// - Historical tracking: Daily income snapshots with growth visualization
// - Portfolio History: Daily tracking of value, income, yield with charts
// - Goal Tracking: Set and track financial goals with progress bars
// - Scenario Simulator: What-if analysis for investments and yield changes
// - Portfolio-Aware AI Chat: Personalized passive income advice with full context
// - Auto price updates: TwelveData API integration
// - Manual Price Mode: For unsupported exchanges (.CO, .MC, etc.)
// - Multi-select filtering: Combine any asset types
// - Import/Export: JSON backup/restore
// ============================================================================

var API_KEY = 'f4faaf5fc1f149eeb9364b8065b8298b';
var portfolio = JSON.parse(localStorage.getItem('portfolio') || '{"holdings":[],"lastUpdate":null,"lastScheduledUpdate":null}');
var editingIdx = null;
var isRefreshing = false;
var activeFilters = [];
var searchTerm = '';
var sortBy = 'value-desc';
var fetchErrors = [];
var chatHistory = [];
var allocationChart = null;
var rates = { DKK: 1, EUR: 7.46, USD: 6.88 };
var displayCurrency = localStorage.getItem('displayCurrency') || 'DKK';
var incomeHistory = JSON.parse(localStorage.getItem('incomeHistory') || '[]');
var portfolioHistory = JSON.parse(localStorage.getItem('portfolioHistory') || '[]');
var goals = JSON.parse(localStorage.getItem('goals') || '[]');
var manualPriceMode = localStorage.getItem('manualPriceMode') === 'true';
var goalNotificationsEnabled = localStorage.getItem('goalNotifications') === 'true';
var notifiedGoals = JSON.parse(localStorage.getItem('notifiedGoals') || '[]');
document.getElementById('displayCurrency').value = displayCurrency;

var filterPresets = {
    liquid: ['stock', 'savings'],
    longterm: ['property', 'fund'],
    income: ['stock', 'fund', 'property']
};

function toDKK(amount, currency) {
    return (amount || 0) * (rates[currency] || 1);
}

function fromDKK(dkk, currency) {
    if (currency === 'DKK') return dkk;
    return dkk / (rates[currency] || 1);
}

function fmt(amount, currency) {
    var syms = { DKK: 'DKK', EUR: 'EUR', USD: 'USD' };
    return Math.round(amount).toLocaleString('da-DK') + ' ' + (syms[currency] || currency);
}

function save() {
    localStorage.setItem('portfolio', JSON.stringify(portfolio));
}

// ============================================================================
// HOLDING VALUE & INCOME CALCULATIONS
// ============================================================================

function holdingValue(h) {
    if (h.type === 'property') {
        return toDKK(h.propertyValue || 0, h.propertyCurrency || 'DKK');
    }
    if (h.type === 'savings') {
        return toDKK(h.savingsAmount || 0, h.savingsCurrency || 'DKK');
    }
    
    // Price selection logic for stocks/funds/RSU:
    // 1. For funds: Always use manualPrice (funds require manual entry)
    // 2. For stocks/RSU:
    //    - currentPrice: Set by API fetch OR manual price override
    //    - manualPrice: Legacy field (backup)
    //    - cost: Fallback to cost basis if no price available
    var price = h.type === 'fund'
        ? (h.manualPrice || 0)
        : (h.currentPrice || h.manualPrice || h.cost || 0);
    
    // Value = shares √ó price (converted to DKK)
    return (h.shares || 0) * toDKK(price, h.priceCurrency || h.costCurrency || 'DKK');
}

// Calculate annual income for a single holding
function holdingIncome(h) {
    if (h.type === 'property') {
        var rental = toDKK(h.rentalIncome || 0, h.rentalCurrency || 'DKK');
        var c = h.costs || {};
        var tc = toDKK((c.tax||0)+(c.power||0)+(c.water||0)+(c.gas||0)+(c.internet||0)+(c.other||0), h.costsCurrency || 'DKK');
        return rental - tc;
    }
    if (h.type === 'savings') {
        return toDKK(h.savingsAmount || 0, h.savingsCurrency || 'DKK') * ((h.interestRate || 0) / 100);
    }
    return toDKK((h.dividend || 0) * (h.shares || 0), h.dividendCurrency || h.costCurrency || 'DKK');
}

// Calculate yield-on-cost (dividend income / original cost basis)
function holdingYieldOnCost(h) {
    if (h.type === 'property' || h.type === 'savings') {
        return 0;
    }
    
    var annualIncome = holdingIncome(h);
    var costBasis = toDKK((h.cost || 0) * (h.shares || 0), h.costCurrency || 'DKK');
    
    if (costBasis === 0) return 0;
    
    return (annualIncome / costBasis) * 100;
}

// Simple monthly projection (annual / 12)
function calculateMonthlyIncome(annualIncome) {
    return annualIncome / 12;
}

// Calculate portfolio totals (works with mixed manual/API prices)
// This function ensures correct calculation regardless of price source:
// - Stocks with API prices: Uses currentPrice from API
// - Stocks with manual prices: Uses currentPrice (set by fetchPrice from manualPriceOverride)
// - Funds: Uses manualPrice field
// - Property: Uses propertyValue
// - Savings: Uses savingsAmount
// All calculations aggregate correctly because holdingValue() handles each type
function calculatePortfolioTotals(holdings) {
    var totVal = 0;
    var totCost = 0;
    var totInc = 0;
    
    holdings.forEach(function(h) {
        totVal += holdingValue(h);
        totCost += (h.type === 'property' || h.type === 'savings') 
            ? holdingValue(h) 
            : toDKK((h.cost || 0) * (h.shares || 0), h.costCurrency || 'DKK');
        totInc += holdingIncome(h);
    });
    
    return { value: totVal, cost: totCost, income: totInc };
}

// ============================================================================
// GOAL TRACKING SYSTEM
// ============================================================================
// Track financial goals with progress visualization
// Supports: Net Worth, Savings, Annual Income goals
// Features: Progress bars, completion indicators, optional notifications
// Data stored locally in browser (no backend required)

function loadGoals() {
    // Load goals from localStorage
    return JSON.parse(localStorage.getItem('goals') || '[]');
}

function saveGoals(goalsArray) {
    // Save goals to localStorage and update global variable
    localStorage.setItem('goals', JSON.stringify(goalsArray));
    goals = goalsArray;
}

function createGoal() {
    // Create a new goal from form inputs
    // Validates inputs, generates unique ID, saves to localStorage
    var type = document.getElementById('goalType').value;
    var target = parseFloat(document.getElementById('goalTarget').value);
    var currency = document.getElementById('goalCurrency').value;
    var label = document.getElementById('goalLabel').value.trim();
    
    // Validate inputs
    if (!target || target <= 0) {
        alert('Please enter a valid target amount');
        return;
    }
    
    if (!label) {
        alert('Please enter a label for your goal');
        return;
    }
    
    // Create new goal object
    var newGoal = {
        id: 'goal_' + Date.now(),
        type: type,
        target: target,
        currency: currency,
        label: label
    };
    
    // Add to goals array
    var currentGoals = loadGoals();
    currentGoals.push(newGoal);
    saveGoals(currentGoals);
    
    // Clear form
    document.getElementById('goalTarget').value = '';
    document.getElementById('goalLabel').value = '';
    
    // Re-render goals list
    renderGoals();
}

function calculateGoalProgress(goal) {
    // Calculate current progress toward a goal
    // Returns: { currentValue, percentage, isCompleted, progressBarWidth }
    // 
    // Goal Types:
    // - netWorth: Sum of all holdings (stocks, property, savings, etc.)
    // - savings: Sum of only savings-type holdings
    // - income: Sum of all annual income (dividends, rental, interest)
    //
    // Currency conversion: Values converted to goal currency for display
    
    var currentValue = 0;
    
    if (goal.type === 'netWorth') {
        // Net worth = total portfolio value
        portfolio.holdings.forEach(function(h) {
            currentValue += holdingValue(h);
        });
    } else if (goal.type === 'savings') {
        // Savings = sum of holdings with type 'savings'
        portfolio.holdings.forEach(function(h) {
            if (h.type === 'savings') {
                currentValue += holdingValue(h);
            }
        });
    } else if (goal.type === 'income') {
        // Income = total annual income
        portfolio.holdings.forEach(function(h) {
            currentValue += holdingIncome(h);
        });
    }
    
    // Convert current value to goal currency if different
    var targetInDKK = toDKK(goal.target, goal.currency);
    
    // Current value is already in DKK from holdingValue/holdingIncome
    // Convert to goal currency for display
    var currentInGoalCurrency = fromDKK(currentValue, goal.currency);
    
    // Calculate percentage
    var percentage = targetInDKK > 0 ? (currentValue / targetInDKK * 100) : 0;
    
    // Check if goal is completed
    var isCompleted = percentage >= 100;
    
    // Cap progress bar at 100%, but keep actual percentage for display
    var progressBarWidth = Math.min(percentage, 100);
    
    return {
        currentValue: currentInGoalCurrency,
        percentage: percentage,
        isCompleted: isCompleted,
        progressBarWidth: progressBarWidth
    };
}

function editGoal(goalId) {
    // Edit an existing goal
    var currentGoals = loadGoals();
    var goal = currentGoals.find(function(g) { return g.id === goalId; });
    
    if (!goal) return;
    
    // Prompt for new values (inline editing)
    var newTarget = prompt('New target amount:', goal.target);
    if (newTarget === null) return; // Cancelled
    
    newTarget = parseFloat(newTarget);
    if (!newTarget || newTarget <= 0) {
        alert('Please enter a valid target amount');
        return;
    }
    
    var newLabel = prompt('New label:', goal.label);
    if (newLabel === null) return; // Cancelled
    
    newLabel = newLabel.trim();
    if (!newLabel) {
        alert('Please enter a label');
        return;
    }
    
    // Update goal
    goal.target = newTarget;
    goal.label = newLabel;
    
    // Save and re-render
    saveGoals(currentGoals);
    renderGoals();
}

function deleteGoal(goalId) {
    // Delete a goal after confirmation
    if (!confirm('Are you sure you want to delete this goal?')) {
        return;
    }
    
    var currentGoals = loadGoals();
    var filtered = currentGoals.filter(function(g) { return g.id !== goalId; });
    
    saveGoals(filtered);
    renderGoals();
}

// ============================================================================
// GOAL NOTIFICATIONS
// ============================================================================
// Optional toast notifications when goals are completed
// Tracks which goals have been notified to prevent duplicates

function showGoalToast(goalLabel) {
    // Display animated toast notification for completed goal
    // Auto-dismisses after 4 seconds with slide-out animation
    var toast = document.createElement('div');
    toast.className = 'goal-toast';
    toast.innerHTML = '<span class="goal-toast-icon">üéâ</span> Goal Reached: ' + goalLabel;
    
    document.body.appendChild(toast);
    
    // Remove after 4 seconds
    setTimeout(function() {
        toast.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(function() {
            document.body.removeChild(toast);
        }, 300);
    }, 4000);
}

function checkGoalNotifications() {
    // Check if any goals just reached 100% and show notifications
    // Only notifies once per goal (tracked in notifiedGoals array)
    // If goal falls below 100%, removes from notified list (can notify again)
    // Respects goalNotificationsEnabled setting
    if (!goalNotificationsEnabled) return;
    
    var currentGoals = loadGoals();
    
    currentGoals.forEach(function(goal) {
        var progress = calculateGoalProgress(goal);
        
        // Goal just completed and not yet notified
        if (progress.isCompleted && !notifiedGoals.includes(goal.id)) {
            showGoalToast(goal.label);
            notifiedGoals.push(goal.id);
            localStorage.setItem('notifiedGoals', JSON.stringify(notifiedGoals));
        }
        
        // Goal fell below 100%, remove from notified list
        if (!progress.isCompleted && notifiedGoals.includes(goal.id)) {
            notifiedGoals = notifiedGoals.filter(function(id) { return id !== goal.id; });
            localStorage.setItem('notifiedGoals', JSON.stringify(notifiedGoals));
        }
    });
}

// ============================================================================
// SCENARIO SIMULATOR
// ============================================================================
// Simulate hypothetical portfolio changes without modifying real data
// Three scenarios: Monthly investment, Yield increase, Buy more shares
// Results show projected value, income, and yield with color-coded differences

function toggleSimulator() {
    // Expand/collapse simulator panel
    // Also populates ticker dropdown when opening
    var content = document.getElementById('simulatorContent');
    var toggle = document.getElementById('simulatorToggle');
    
    if (content.classList.contains('show')) {
        content.classList.remove('show');
        toggle.classList.remove('open');
    } else {
        content.classList.add('show');
        toggle.classList.add('open');
        populateTickerDropdown();
    }
}

function populateTickerDropdown() {
    // Populate ticker dropdown with stocks from portfolio
    var dropdown = document.getElementById('simTicker');
    dropdown.innerHTML = '<option value="">Select stock...</option>';
    
    portfolio.holdings.forEach(function(h) {
        if (h.type === 'stock' && h.ticker) {
            var option = document.createElement('option');
            option.value = h.ticker;
            option.textContent = h.name + ' (' + h.ticker + ')';
            dropdown.appendChild(option);
        }
    });
}

function clonePortfolio() {
    // Deep clone portfolio holdings to avoid modifying the real data
    // Uses JSON stringify/parse for complete independence
    // Returns a safe copy that can be manipulated for simulation
    // CRITICAL: This ensures the real portfolio is never touched
    return JSON.parse(JSON.stringify(portfolio.holdings));
}

function applyMonthlyInvestment(simulatedHoldings, monthlyAmount) {
    // Scenario 1: Monthly Investment
    // Distributes investment proportionally across holdings based on portfolio weight
    // Higher-value holdings receive proportionally more investment
    // Only applies to holdings with shares (stocks, funds, RSU)
    
    if (!monthlyAmount || monthlyAmount <= 0) return;
    
    // Calculate total current value to determine weights
    var totalValue = 0;
    simulatedHoldings.forEach(function(h) {
        totalValue += holdingValue(h);
    });
    
    if (totalValue === 0) return; // Can't distribute if portfolio is empty
    
    // Distribute investment proportionally
    simulatedHoldings.forEach(function(h) {
        // Calculate this holding's weight
        var holdingVal = holdingValue(h);
        var weight = holdingVal / totalValue;
        
        // Amount to invest in this holding
        var investmentAmount = monthlyAmount * weight;
        
        // Only apply to holdings with shares (stocks, funds, RSU)
        if (h.shares && h.shares > 0 && (h.type === 'stock' || h.type === 'fund' || h.type === 'rsu')) {
            // Calculate current price per share
            var currentPrice = h.currentPrice || h.manualPrice || h.cost || 0;
            
            if (currentPrice > 0) {
                // Calculate additional shares we can buy
                var additionalShares = investmentAmount / toDKK(currentPrice, h.priceCurrency || h.costCurrency || 'DKK');
                
                // Add to share count
                h.shares += additionalShares;
            }
        }
    });
}

function applyYieldIncrease(simulatedHoldings, yieldIncreasePercent) {
    // Scenario 2: Yield Increase
    // Simulates companies increasing dividends or interest rates improving
    // Applies percentage increase to all income-generating holdings
    // Stocks/Funds: increases dividend per share
    // Savings: increases interest rate
    // Property: increases rental income
    
    if (!yieldIncreasePercent || yieldIncreasePercent === 0) return;
    
    simulatedHoldings.forEach(function(h) {
        // Only apply to holdings that generate income
        if (h.type === 'stock' || h.type === 'fund' || h.type === 'rsu') {
            // Increase dividend per share
            if (h.dividend && h.dividend > 0) {
                // Apply percentage increase
                // Example: 1% increase means multiply by 1.01
                var multiplier = 1 + (yieldIncreasePercent / 100);
                h.dividend = h.dividend * multiplier;
            }
        } else if (h.type === 'savings') {
            // Increase interest rate
            if (h.interestRate && h.interestRate > 0) {
                var multiplier = 1 + (yieldIncreasePercent / 100);
                h.interestRate = h.interestRate * multiplier;
            }
        } else if (h.type === 'property') {
            // Increase rental income
            if (h.rentalIncome && h.rentalIncome > 0) {
                var multiplier = 1 + (yieldIncreasePercent / 100);
                h.rentalIncome = h.rentalIncome * multiplier;
            }
        }
    });
}

function applyExtraShares(simulatedHoldings, extraShares) {
    // Scenario 3: Buy More Shares
    // Simulates purchasing additional shares of a specific stock
    // Finds holding by ticker symbol (case-insensitive)
    // Only applies to holdings with shares (stocks, funds, RSU)
    
    if (!extraShares || !extraShares.ticker || !extraShares.amount || extraShares.amount <= 0) {
        return;
    }
    
    // Find the holding with the specified ticker
    var holding = simulatedHoldings.find(function(h) {
        return h.ticker && h.ticker.toUpperCase() === extraShares.ticker.toUpperCase();
    });
    
    if (!holding) {
        console.warn('Ticker not found in portfolio:', extraShares.ticker);
        return;
    }
    
    // Only apply to holdings with shares (stocks, funds, RSU)
    if (holding.shares && (holding.type === 'stock' || holding.type === 'fund' || holding.type === 'rsu')) {
        // Add the specified number of shares
        holding.shares += extraShares.amount;
    }
}

function calculateSimulatedMetrics(simulatedHoldings) {
    // Calculate portfolio metrics from simulated holdings
    // Returns: { totalValue, annualIncome, currentYield }
    
    var totalValue = 0;
    var annualIncome = 0;
    
    simulatedHoldings.forEach(function(h) {
        // Calculate value for this holding
        var holdingVal = holdingValue(h);
        totalValue += holdingVal;
        
        // Calculate income for this holding
        var holdingInc = holdingIncome(h);
        annualIncome += holdingInc;
    });
    
    // Calculate yield percentage
    var currentYield = totalValue > 0 ? (annualIncome / totalValue * 100) : 0;
    
    return {
        totalValue: totalValue,
        annualIncome: annualIncome,
        currentYield: currentYield
    };
}

function applyPreset(presetName) {
    // Apply a preset scenario and automatically run simulation
    // Presets provide common "what-if" scenarios with one click
    // Clears previous inputs to avoid scenario mixing
    
    // Clear all inputs first
    document.getElementById('simMonthlyAmount').value = '';
    document.getElementById('simYieldIncrease').value = '';
    document.getElementById('simTicker').value = '';
    document.getElementById('simShares').value = '';
    
    // Apply preset values
    switch(presetName) {
        case 'monthly2000':
            document.getElementById('simMonthlyAmount').value = '2000';
            break;
            
        case 'monthly5000':
            document.getElementById('simMonthlyAmount').value = '5000';
            break;
            
        case 'yield1':
            document.getElementById('simYieldIncrease').value = '1';
            break;
            
        case 'yield2':
            document.getElementById('simYieldIncrease').value = '2';
            break;
            
        case 'buyShares':
            // Use the first stock in the portfolio
            var firstStock = portfolio.holdings.find(function(h) {
                return h.type === 'stock' && h.ticker;
            });
            
            if (firstStock) {
                document.getElementById('simTicker').value = firstStock.ticker;
                document.getElementById('simShares').value = '10';
            } else {
                alert('No stocks found in portfolio. Add a stock first.');
                return;
            }
            break;
    }
    
    // Automatically run the simulation
    runSimulation();
}

function runSimulation() {
    // Main simulation engine
    // Reads inputs, clones portfolio, applies changes, calculates results
    
    // Get input values
    var monthlyInvestment = parseFloat(document.getElementById('simMonthlyAmount').value) || 0;
    var yieldIncreasePercent = parseFloat(document.getElementById('simYieldIncrease').value) || 0;
    var extraSharesTicker = document.getElementById('simTicker').value;
    var extraSharesAmount = parseFloat(document.getElementById('simShares').value) || 0;
    
    // Validate: at least one scenario must be selected
    if (monthlyInvestment === 0 && yieldIncreasePercent === 0 && (!extraSharesTicker || extraSharesAmount === 0)) {
        alert('Please enter at least one scenario to simulate');
        return;
    }
    
    // Clone portfolio (never modify the real data!)
    var simulatedHoldings = clonePortfolio();
    
    // Build options object for scenarios
    var options = {
        monthlyInvestment: monthlyInvestment,
        yieldIncreasePercent: yieldIncreasePercent,
        extraShares: extraSharesTicker && extraSharesAmount > 0 ? {
            ticker: extraSharesTicker,
            amount: extraSharesAmount
        } : null
    };
    
    // Apply scenarios to simulated holdings ONLY
    // Real portfolio (portfolio.holdings) is never modified
    applyMonthlyInvestment(simulatedHoldings, options.monthlyInvestment);
    applyYieldIncrease(simulatedHoldings, options.yieldIncreasePercent);
    applyExtraShares(simulatedHoldings, options.extraShares);
    
    // Calculate simulated metrics
    var simulatedMetrics = calculateSimulatedMetrics(simulatedHoldings);
    
    // Calculate current metrics for comparison
    var currentMetrics = calculateSimulatedMetrics(portfolio.holdings);
    
    // Prepare result object
    var simulationResult = {
        current: currentMetrics,
        simulated: simulatedMetrics,
        differences: {
            totalValue: simulatedMetrics.totalValue - currentMetrics.totalValue,
            annualIncome: simulatedMetrics.annualIncome - currentMetrics.annualIncome,
            currentYield: simulatedMetrics.currentYield - currentMetrics.currentYield
        },
        options: options
    };
    
    // Display results in UI
    displaySimulationResults(simulationResult);
    
    return simulationResult;
}

function displaySimulationResults(result) {
    // Update the results panel with simulation outcomes
    
    var resultsPanel = document.getElementById('simulatorResults');
    
    // Show the results panel
    resultsPanel.classList.add('show');
    
    // Format values
    var simValue = Math.round(result.simulated.totalValue);
    var simIncome = Math.round(result.simulated.annualIncome);
    var simYield = result.simulated.currentYield;
    
    var diffValue = result.differences.totalValue;
    var diffIncome = result.differences.annualIncome;
    var diffYield = result.differences.currentYield;
    
    // Update value
    document.getElementById('simResultValue').textContent = simValue.toLocaleString() + ' DKK';
    document.getElementById('simResultValueDiff').textContent = 
        (diffValue >= 0 ? '+' : '') + Math.round(diffValue).toLocaleString() + ' DKK';
    document.getElementById('simResultValueDiff').className = 
        'result-diff ' + (diffValue >= 0 ? 'positive' : 'negative');
    
    // Update income
    document.getElementById('simResultIncome').textContent = simIncome.toLocaleString() + ' DKK';
    document.getElementById('simResultIncomeDiff').textContent = 
        (diffIncome >= 0 ? '+' : '') + Math.round(diffIncome).toLocaleString() + ' DKK';
    document.getElementById('simResultIncomeDiff').className = 
        'result-diff ' + (diffIncome >= 0 ? 'positive' : 'negative');
    
    // Update yield
    document.getElementById('simResultYield').textContent = simYield.toFixed(2) + '%';
    document.getElementById('simResultYieldDiff').textContent = 
        (diffYield >= 0 ? '+' : '') + diffYield.toFixed(2) + '%';
    document.getElementById('simResultYieldDiff').className = 
        'result-diff ' + (diffYield >= 0 ? 'positive' : 'negative');
}

function renderGoals() {
    // Display all goals in the goals list
    var container = document.getElementById('goalsList');
    var currentGoals = loadGoals();
    
    if (currentGoals.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:20px;color:#9ba5b8;font-size:14px;">No goals yet. Create your first goal above!</div>';
        return;
    }
    
    container.innerHTML = '';
    
    currentGoals.forEach(function(goal) {
        // Calculate progress
        var progress = calculateGoalProgress(goal);
        
        var goalDiv = document.createElement('div');
        var baseStyle = 'padding:15px;background:#1a2237;border-radius:8px;margin-bottom:10px;';
        
        // Add completed class if goal reached
        if (progress.isCompleted) {
            goalDiv.className = 'goal-completed';
            goalDiv.style.cssText = baseStyle;
        } else {
            goalDiv.style.cssText = baseStyle;
        }
        
        var typeLabel = goal.type === 'netWorth' ? 'Net Worth' 
                      : goal.type === 'savings' ? 'Savings' 
                      : 'Annual Income';
        
        // Add checkmark and badge for completed goals
        var checkmark = progress.isCompleted ? '<span class="goal-checkmark">‚úì</span>' : '';
        var badge = progress.isCompleted ? '<span class="goal-completed-badge">Goal Reached!</span>' : '';
        
        goalDiv.innerHTML = 
            '<div>' +
                '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">' +
                    '<div style="flex:1;">' +
                        '<div style="font-weight:600;margin-bottom:4px;">' + checkmark + goal.label + badge + '</div>' +
                        '<div style="font-size:12px;color:#9ba5b8;">' + typeLabel + ' ‚Ä¢ Target: ' + goal.target.toLocaleString() + ' ' + goal.currency + '</div>' +
                    '</div>' +
                    '<div style="display:flex;align-items:center;gap:10px;">' +
                        '<div style="text-align:right;font-size:14px;font-weight:600;color:' + (progress.isCompleted ? '#00ff88' : '#4d94ff') + ';">' + progress.percentage.toFixed(1) + '%</div>' +
                        '<div class="goal-actions">' +
                            '<button class="goal-edit-btn" onclick="editGoal(\'' + goal.id + '\')">Edit</button>' +
                            '<button class="goal-delete-btn" onclick="deleteGoal(\'' + goal.id + '\')">Delete</button>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
                '<div style="font-size:12px;color:#9ba5b8;margin-bottom:8px;">Current: ' + Math.round(progress.currentValue).toLocaleString() + ' ' + goal.currency + '</div>' +
                '<div class="goal-progress-bar">' +
                    '<div class="goal-progress-fill" style="width:' + progress.progressBarWidth + '%"></div>' +
                '</div>' +
            '</div>';
        
        container.appendChild(goalDiv);
    });
}

// ============================================================================
// PORTFOLIO HISTORY TRACKING
// ============================================================================
// Tracks daily snapshots of portfolio value, income, and yield for trending
// Data stored locally in browser (no backend required)
// One snapshot per day to track long-term portfolio growth

function loadHistory() {
    // Load history from localStorage
    return JSON.parse(localStorage.getItem('portfolioHistory') || '[]');
}

function saveHistory(history) {
    // Save history to localStorage and update global variable
    localStorage.setItem('portfolioHistory', JSON.stringify(history));
    portfolioHistory = history;
}

function recordDailySnapshot(totalValue, annualIncome) {
    // Records one snapshot per day (prevents duplicates)
    // Called automatically by render() after portfolio totals are calculated
    // Values are in DKK for consistency across currency changes
    
    var today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
    
    // Load current history
    var history = loadHistory();
    
    // Check if snapshot for today already exists
    var alreadyRecorded = history.some(function(entry) {
        return entry.date === today;
    });
    
    if (alreadyRecorded) {
        return; // Don't duplicate - only one snapshot per day
    }
    
    // Calculate yield percentage
    var yieldPercent = totalValue > 0 ? (annualIncome / totalValue * 100) : 0;
    
    // Create new snapshot entry
    var snapshot = {
        date: today,
        totalValue: totalValue,        // Portfolio value in DKK
        annualIncome: annualIncome,    // Annual income in DKK
        yield: yieldPercent            // Yield percentage
    };
    
    // Append to history
    history.push(snapshot);
    
    // Sort by date (oldest first)
    history.sort(function(a, b) {
        return a.date.localeCompare(b.date);
    });
    
    // Limit to last 3 years for performance (1095 days)
    if (history.length > 1095) {
        history = history.slice(-1095);
    }
    
    // Save to localStorage
    saveHistory(history);
}

function getChartData(range) {
    // Filters history by time range and prepares data for charting
    // Range options: '30d' (last 30 days), '12m' (last 12 months), 'all' (entire history)
    // Returns four parallel arrays ready for chart rendering
    
    var history = loadHistory();
    
    // Return empty arrays if no history
    if (history.length === 0) {
        return {
            labels: [],
            values: [],
            income: [],
            yield: []
        };
    }
    
    // Calculate cutoff date based on range
    var cutoffDate = new Date();
    var filtered = history;
    
    if (range === '30d') {
        cutoffDate.setDate(cutoffDate.getDate() - 30);
        filtered = history.filter(function(entry) {
            return new Date(entry.date) >= cutoffDate;
        });
    } else if (range === '12m') {
        cutoffDate.setMonth(cutoffDate.getMonth() - 12);
        filtered = history.filter(function(entry) {
            return new Date(entry.date) >= cutoffDate;
        });
    }
    // 'all' range uses all data (no filtering)
    
    // Extract parallel arrays for charting
    var labels = [];
    var values = [];
    var income = [];
    var yieldData = [];
    
    filtered.forEach(function(entry) {
        labels.push(entry.date);
        values.push(entry.totalValue);
        income.push(entry.annualIncome);
        yieldData.push(entry.yield);
    });
    
    return {
        labels: labels,      // Date strings (YYYY-MM-DD)
        values: values,      // Total portfolio values
        income: income,      // Annual income amounts
        yield: yieldData     // Yield percentages
    };
}

function drawHistoryChart(labels, values, metric) {
    // Draws a line chart on canvas element showing portfolio history
    // Uses pure Canvas API (no external chart libraries)
    // Metric parameter determines Y-axis formatting: 'value', 'income', or 'yield'
    
    metric = metric || 'value'; // Default to value
    
    var canvas = document.getElementById('historyChart');
    if (!canvas || !canvas.getContext) return;
    
    var ctx = canvas.getContext('2d');
    var width = canvas.width;
    var height = canvas.height;
    
    // Clear canvas before redrawing
    ctx.clearRect(0, 0, width, height);
    
    // Show message if no data available
    if (!labels || labels.length === 0) {
        ctx.fillStyle = '#9ba5b8';
        ctx.font = '14px system-ui';
        ctx.textAlign = 'center';
        ctx.fillText('No history data yet. Check back tomorrow!', width / 2, height / 2);
        return;
    }
    
    // Chart padding for axes and labels
    var padding = { top: 30, right: 40, bottom: 40, left: 60 };
    var chartWidth = width - padding.left - padding.right;
    var chartHeight = height - padding.top - padding.bottom;
    
    // Calculate value range for auto-scaling
    var maxValue = Math.max.apply(Math, values);
    var minValue = Math.min.apply(Math, values);
    var valueRange = maxValue - minValue;
    
    // Add 10% padding to range for better visualization
    var rangePadding = valueRange * 0.1;
    maxValue += rangePadding;
    minValue -= rangePadding;
    if (minValue < 0) minValue = 0;
    
    // Scale functions to convert data to pixel coordinates
    var xScale = function(index) {
        return padding.left + (index / Math.max(1, labels.length - 1)) * chartWidth;
    };
    
    var yScale = function(value) {
        var range = maxValue - minValue;
        if (range === 0) return padding.top + chartHeight / 2;
        return padding.top + chartHeight - ((value - minValue) / range) * chartHeight;
    };
    
    // Draw horizontal grid lines
    ctx.strokeStyle = '#2a3550';
    ctx.lineWidth = 1;
    for (var i = 0; i <= 5; i++) {
        var y = padding.top + (chartHeight / 5) * i;
        ctx.beginPath();
        ctx.moveTo(padding.left, y);
        ctx.lineTo(padding.left + chartWidth, y);
        ctx.stroke();
        
        // Y-axis labels with metric-appropriate formatting
        var value = maxValue - ((maxValue - minValue) / 5) * i;
        var labelText;
        if (metric === 'yield') {
            labelText = value.toFixed(1) + '%';  // e.g., "3.5%"
        } else {
            labelText = Math.round(value / 1000) + 'K';  // e.g., "1200K"
        }
        ctx.fillStyle = '#9ba5b8';
        ctx.font = '11px system-ui';
        ctx.textAlign = 'right';
        ctx.fillText(labelText, padding.left - 10, y + 4);
    }
    
    // Draw the line chart connecting all data points
    ctx.strokeStyle = '#4d94ff';
    ctx.lineWidth = 2;
    ctx.beginPath();
    
    for (var i = 0; i < labels.length; i++) {
        var x = xScale(i);
        var y = yScale(values[i]);
        
        if (i === 0) {
            ctx.moveTo(x, y);
        } else {
            ctx.lineTo(x, y);
        }
    }
    ctx.stroke();
    
    // Draw dots at each data point
    ctx.fillStyle = '#4d94ff';
    for (var i = 0; i < labels.length; i++) {
        var x = xScale(i);
        var y = yScale(values[i]);
        
        ctx.beginPath();
        ctx.arc(x, y, 4, 0, Math.PI * 2);
        ctx.fill();
    }
    
    // Draw X-axis date labels (show max 8 labels to avoid crowding)
    ctx.fillStyle = '#9ba5b8';
    ctx.font = '11px system-ui';
    ctx.textAlign = 'center';
    var labelStep = Math.ceil(labels.length / 8);
    for (var i = 0; i < labels.length; i += labelStep) {
        var x = xScale(i);
        var dateStr = labels[i];
        // Format date: MM/DD
        var parts = dateStr.split('-');
        if (parts.length === 3) {
            dateStr = parts[1] + '/' + parts[2];
        }
        ctx.fillText(dateStr, x, height - padding.bottom + 20);
    }
}

// Record daily income snapshot (prevents duplicates)
function recordIncomeSnapshot() {
    var today = new Date().toISOString().split('T')[0];
    
    // Check if already recorded today
    var alreadyRecorded = incomeHistory.some(function(entry) {
        return entry.date === today;
    });
    
    if (alreadyRecorded) {
        return;
    }
    
    // Calculate total income across all holdings
    var totalIncome = 0;
    portfolio.holdings.forEach(function(h) {
        totalIncome += holdingIncome(h);
    });
    
    // Validate income is a number
    if (isNaN(totalIncome) || !isFinite(totalIncome)) {
        totalIncome = 0;
    }
    
    // Store snapshot
    incomeHistory.push({
        date: today,
        income: totalIncome
    });
    
    // Keep sorted by date
    incomeHistory.sort(function(a, b) {
        return a.date.localeCompare(b.date);
    });
    
    // Limit history to last 3 years for performance
    if (incomeHistory.length > 1095) {
        incomeHistory = incomeHistory.slice(-1095);
    }
    
    localStorage.setItem('incomeHistory', JSON.stringify(incomeHistory));
}

// Distribute annual income across months based on dividend frequency
function getMonthlyDividendMap() {
    var monthlyMap = {
        'January': 0, 'February': 0, 'March': 0, 'April': 0,
        'May': 0, 'June': 0, 'July': 0, 'August': 0,
        'September': 0, 'October': 0, 'November': 0, 'December': 0
    };
    
    var filtered = getFiltered();
    
    filtered.forEach(function(h) {
        var annualIncome = holdingIncome(h);
        var freq = h.dividendFrequency || 'annual';
        
        if (freq === 'none' || annualIncome === 0) {
            return;
        }
        
        if (freq === 'monthly') {
            var monthlyAmount = annualIncome / 12;
            Object.keys(monthlyMap).forEach(function(month) {
                monthlyMap[month] += monthlyAmount;
            });
        } else if (freq === 'quarterly') {
            var quarterlyAmount = annualIncome / 4;
            monthlyMap['March'] += quarterlyAmount;
            monthlyMap['June'] += quarterlyAmount;
            monthlyMap['September'] += quarterlyAmount;
            monthlyMap['December'] += quarterlyAmount;
        } else if (freq === 'semiannual') {
            var semiAmount = annualIncome / 2;
            monthlyMap['June'] += semiAmount;
            monthlyMap['December'] += semiAmount;
        } else if (freq === 'annual') {
            monthlyMap['December'] += annualIncome;
        }
    });
    
    return monthlyMap;
}

document.getElementById('displayCurrency').onchange = function(e) {
    displayCurrency = e.target.value;
    localStorage.setItem('displayCurrency', displayCurrency);
    render();
};

var theme = localStorage.getItem('theme') || 'dark';
document.body.className = theme;
var themeBtn = document.getElementById('theme-toggle');
themeBtn.textContent = theme === 'dark' ? '‚òÄÔ∏è Light' : 'üåô Dark';
themeBtn.onclick = function() {
    theme = theme === 'dark' ? 'light' : 'dark';
    document.body.className = theme;
    localStorage.setItem('theme', theme);
    themeBtn.textContent = theme === 'dark' ? '‚òÄÔ∏è Light' : 'üåô Dark';
};

function updateRates() {
    return fetch('https://api.frankfurter.app/latest?from=DKK&to=EUR,USD')
        .then(function(r) { return r.json(); })
        .then(function(j) { rates.EUR = 1/j.rates.EUR; rates.USD = 1/j.rates.USD; })
        .catch(function() {});
}

function getNextUpdate() {
    var now = new Date();
    var cet = new Date(now.getTime() + (now.getTimezoneOffset() + 60) * 60000);
    var h = cet.getHours();
    var next = new Date(cet);
    if (h < 8) next.setHours(8,0,0,0);
    else if (h < 22) next.setHours(22,0,0,0);
    else { next.setDate(next.getDate()+1); next.setHours(8,0,0,0); }
    return new Date(next.getTime() - (now.getTimezoneOffset() + 60) * 60000);
}

function updateNextDisplay() {
    var next = getNextUpdate();
    var diff = next - Date.now();
    var h = Math.floor(diff / 3600000);
    var m = Math.floor((diff % 3600000) / 60000);
    var t = next.toLocaleTimeString('da-DK', {hour:'2-digit',minute:'2-digit'});
    document.getElementById('nextUpdate').textContent = 'Next auto-update ' + (h < 1 ? 'in '+m+' min' : 'in '+h+'h '+m+'m') + ' at ' + t;
}

function checkAutoUpdate() {
    var now = new Date();
    var cet = new Date(now.getTime() + (now.getTimezoneOffset() + 60) * 60000);
    var hour = cet.getHours();
    var min = cet.getMinutes();
    if ((hour === 8 || hour === 22) && min < 5) {
        var key = cet.toISOString().split('T')[0] + '-' + hour;
        if (portfolio.lastScheduledUpdate !== key) {
            portfolio.lastScheduledUpdate = key;
            save();
            refreshPrices();
        }
    }
}

function fetchPrice(h) {
    // ============================================================================
    // MANUAL PRICE MODE LOGIC
    // ============================================================================
    // Priority 1: If manual price mode is ON and holding has a manual price override,
    // use that price instead of making an API call. This allows users to manually
    // enter prices for stocks from unsupported exchanges (.CO, .MC, etc.)
    if (manualPriceMode && h.manualPriceOverride && h.manualPriceOverride > 0) {
        h.currentPrice = h.manualPriceOverride;
        h.priceCurrency = h.manualPriceCurrency || 'DKK';
        h.fetchError = false;
        h.isManualPrice = true; // Flag for UI badge display
        return Promise.resolve(); // Skip API call
    }
    
    // Mark as not using manual price (for UI indicators)
    h.isManualPrice = false;
    
    // ============================================================================
    // SKIP API FETCH FOR NON-STOCK TYPES
    // ============================================================================
    // Funds, property, and savings don't use API prices
    if (!h.ticker || h.type === 'fund' || h.type === 'property' || h.type === 'savings') {
        return Promise.resolve();
    }
    
    // ============================================================================
    // SKIP UNSUPPORTED EXCHANGES
    // ============================================================================
    // TwelveData free tier doesn't support exchanges with dots in ticker (.CO, .MC, etc.)
    // Mark as fetch error so user knows to use manual price mode
    var sym = h.ticker.toUpperCase();
    if (sym.indexOf('.') !== -1) { 
        h.fetchError = true; 
        return Promise.resolve(); 
    }
    
    // ============================================================================
    // FETCH FROM API
    // ============================================================================
    return fetch('https://api.twelvedata.com/quote?symbol=' + sym + '&apikey=' + API_KEY)
        .then(function(r) { return r.json(); })
        .then(function(j) {
            if (j.close || j.previous_close) {
                h.currentPrice = parseFloat(j.close || j.previous_close);
                h.priceCurrency = j.currency || 'USD';
                h.fetchError = false;
            } else {
                h.fetchError = true;
                fetchErrors.push(h.name + ': fetch failed');
            }
        })
        .catch(function() { h.fetchError = true; fetchErrors.push(h.name + ': fetch failed'); });
}

function refreshPrices() {
    if (isRefreshing) return;
    isRefreshing = true;
    fetchErrors = [];
    document.getElementById('loadingIndicator').classList.add('show');
    document.getElementById('refreshBtn').textContent = 'Updating...';
    document.getElementById('refreshBtn').disabled = true;
    updateRates().then(function() {
        return Promise.all(portfolio.holdings.map(fetchPrice));
    }).then(function() {
        portfolio.lastUpdate = new Date().toISOString();
        save();
        var ec = document.getElementById('errorContainer');
        ec.innerHTML = fetchErrors.length ? '<div class="error-list"><strong>Some prices failed:</strong>' + fetchErrors.map(function(e){ return '<div>' + e + '</div>'; }).join('') + '</div>' : '';
        render();
        recordIncomeSnapshot();
        document.getElementById('loadingIndicator').classList.remove('show');
        document.getElementById('refreshBtn').textContent = 'Refresh';
        document.getElementById('refreshBtn').disabled = false;
        isRefreshing = false;
    });
}

function toggleFields() {
    var type = document.getElementById('type').value;
    document.getElementById('stockFields').style.display = (type==='stock'||type==='fund'||type==='rsu') ? 'block' : 'none';
    document.getElementById('propertyFields').style.display = type==='property' ? 'block' : 'none';
    document.getElementById('savingsFields').style.display = type==='savings' ? 'block' : 'none';
    document.getElementById('tickerWrap').style.display = type==='fund' ? 'none' : 'block';
    document.getElementById('priceHint').style.display = type==='fund' ? 'none' : 'block';
    document.getElementById('fundHint').style.display = type==='fund' ? 'block' : 'none';
    
    // Show manual price field only when manual price mode is ON and type is stock/fund/rsu
    var showManualPrice = manualPriceMode && (type==='stock'||type==='fund'||type==='rsu');
    document.getElementById('manualPriceWrap').style.display = showManualPrice ? 'block' : 'none';
    
    var freqField = document.getElementById('dividendFrequency');
    if (type === 'property') {
        freqField.value = 'monthly';
    } else if (type === 'savings') {
        freqField.value = 'monthly';
    } else {
        freqField.value = 'quarterly';
    }
}

function clearForm() {
    ['ticker','name','shares','cost','currentPrice','dividend','address','propertyValue','rentalIncome','costTax','costPower','costWater','costGas','costInternet','costOther','savingsAmount','interestRate','manualPrice'].forEach(function(id) {
        document.getElementById(id).value = '';
    });
    document.getElementById('type').value = 'stock';
    document.getElementById('costCurrency').value = 'DKK';
    document.getElementById('priceCurrency').value = 'DKK';
    document.getElementById('dividendCurrency').value = 'DKK';
    document.getElementById('dividendFrequency').value = 'annual';
    document.getElementById('manualPriceCurrency').value = 'DKK';
    document.getElementById('propertyCurrency').value = 'DKK';
    document.getElementById('rentalCurrency').value = 'DKK';
    document.getElementById('costsCurrency').value = 'DKK';
    document.getElementById('savingsCurrency').value = 'DKK';
    document.getElementById('deleteBtn').style.display = 'none';
    toggleFields();
}

function editHolding(idx) {
    editingIdx = idx;
    var h = portfolio.holdings[idx];
    document.getElementById('modalTitle').textContent = 'Edit Holding';
    document.getElementById('type').value = h.type;
    document.getElementById('name').value = h.name || '';
    toggleFields();
    if (h.type === 'savings') {
        document.getElementById('savingsAmount').value = h.savingsAmount || '';
        document.getElementById('savingsCurrency').value = h.savingsCurrency || 'DKK';
        document.getElementById('interestRate').value = h.interestRate || '';
    } else if (h.type === 'property') {
        document.getElementById('address').value = h.address || '';
        document.getElementById('propertyValue').value = h.propertyValue || '';
        document.getElementById('propertyCurrency').value = h.propertyCurrency || 'DKK';
        document.getElementById('rentalIncome').value = h.rentalIncome || '';
        document.getElementById('rentalCurrency').value = h.rentalCurrency || 'DKK';
        var c = h.costs || {};
        document.getElementById('costTax').value = c.tax || '';
        document.getElementById('costPower').value = c.power || '';
        document.getElementById('costWater').value = c.water || '';
        document.getElementById('costGas').value = c.gas || '';
        document.getElementById('costInternet').value = c.internet || '';
        document.getElementById('costOther').value = c.other || '';
        document.getElementById('costsCurrency').value = h.costsCurrency || 'DKK';
    } else {
        document.getElementById('ticker').value = h.ticker || '';
        document.getElementById('shares').value = h.shares || '';
        document.getElementById('cost').value = h.cost || '';
        document.getElementById('costCurrency').value = h.costCurrency || 'DKK';
        document.getElementById('currentPrice').value = h.manualPrice || '';
        document.getElementById('priceCurrency').value = h.priceCurrency || 'DKK';
        document.getElementById('manualPrice').value = h.manualPriceOverride || '';
        document.getElementById('manualPriceCurrency').value = h.manualPriceCurrency || 'DKK';
        document.getElementById('dividend').value = h.dividend || '';
        document.getElementById('dividendCurrency').value = h.dividendCurrency || 'DKK';
        document.getElementById('dividendFrequency').value = h.dividendFrequency || 'annual';
    }
    document.getElementById('deleteBtn').style.display = 'block';
    document.getElementById('modal').classList.add('show');
}

function saveHolding() {
    var type = document.getElementById('type').value;
    var name = document.getElementById('name').value.trim();
    if (!name) { alert('Name is required.'); return; }
    var h = { type: type, name: name };
    if (type === 'savings') {
        var amt = parseFloat(document.getElementById('savingsAmount').value) || 0;
        if (amt <= 0) { alert('Savings amount must be greater than 0.'); return; }
        h.savingsAmount = amt;
        h.savingsCurrency = document.getElementById('savingsCurrency').value;
        h.interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
    } else if (type === 'property') {
        var val = parseFloat(document.getElementById('propertyValue').value) || 0;
        if (val <= 0) { alert('Property value must be greater than 0.'); return; }
        h.address = document.getElementById('address').value.trim();
        h.propertyValue = val;
        h.propertyCurrency = document.getElementById('propertyCurrency').value;
        h.rentalIncome = parseFloat(document.getElementById('rentalIncome').value) || 0;
        h.rentalCurrency = document.getElementById('rentalCurrency').value;
        h.costs = {
            tax: parseFloat(document.getElementById('costTax').value) || 0,
            power: parseFloat(document.getElementById('costPower').value) || 0,
            water: parseFloat(document.getElementById('costWater').value) || 0,
            gas: parseFloat(document.getElementById('costGas').value) || 0,
            internet: parseFloat(document.getElementById('costInternet').value) || 0,
            other: parseFloat(document.getElementById('costOther').value) || 0
        };
        h.costsCurrency = document.getElementById('costsCurrency').value;
    } else {
        var shares = parseFloat(document.getElementById('shares').value) || 0;
        var cost = parseFloat(document.getElementById('cost').value) || 0;
        if (shares <= 0 || cost <= 0) { alert('Shares and cost must be greater than 0.'); return; }
        var ticker = document.getElementById('ticker').value.trim().toUpperCase();
        if (type !== 'fund' && !ticker) { alert('Ticker is required for stocks and RSU.'); return; }
        var manualPrice = parseFloat(document.getElementById('currentPrice').value) || 0;
        if (type === 'fund' && manualPrice <= 0) { alert('Current price is required for funds.'); return; }
        h.ticker = type !== 'fund' ? ticker : undefined;
        h.shares = shares;
        h.cost = cost;
        h.costCurrency = document.getElementById('costCurrency').value;
        h.manualPrice = manualPrice > 0 ? manualPrice : undefined;
        h.priceCurrency = document.getElementById('priceCurrency').value;
        h.dividend = parseFloat(document.getElementById('dividend').value) || 0;
        h.dividendCurrency = document.getElementById('dividendCurrency').value;
        h.dividendFrequency = document.getElementById('dividendFrequency').value;
        
        // Save manual price if provided
        var manualPriceInput = parseFloat(document.getElementById('manualPrice').value);
        if (manualPriceInput > 0) {
            h.manualPriceOverride = manualPriceInput;
            h.manualPriceCurrency = document.getElementById('manualPriceCurrency').value;
        } else {
            h.manualPriceOverride = null;
            h.manualPriceCurrency = null;
        }
        
        if (editingIdx !== null && portfolio.holdings[editingIdx] && portfolio.holdings[editingIdx].currentPrice) {
            h.currentPrice = portfolio.holdings[editingIdx].currentPrice;
        }
    }
    if (editingIdx !== null) {
        portfolio.holdings[editingIdx] = h;
        editingIdx = null;
    } else {
        portfolio.holdings.push(h);
    }
    save();
    document.getElementById('modal').classList.remove('show');
    clearForm();
    render();
    recordIncomeSnapshot();
    if ((type === 'stock' || type === 'rsu') && h.ticker) {
        var newIdx = portfolio.holdings.length - 1;
        fetchPrice(portfolio.holdings[newIdx]).then(function() { save(); render(); recordIncomeSnapshot(); });
    }
}

function deleteHolding() {
    if (!confirm('Delete this holding?')) return;
    portfolio.holdings.splice(editingIdx, 1);
    editingIdx = null;
    save();
    document.getElementById('modal').classList.remove('show');
    clearForm();
    render();
    recordIncomeSnapshot();
}

// ============================================================================
// MANUAL PRICE INLINE EDITOR
// ============================================================================
// These functions allow quick price updates without opening the full edit modal

function showInlinePriceEditor(idx) {
    var h = portfolio.holdings[idx];
    var holdingEl = document.getElementById('holding-' + idx);
    if (!holdingEl) return;
    
    var currentPrice = h.manualPriceOverride || h.currentPrice || h.cost || 0;
    var currentCurrency = h.manualPriceCurrency || h.priceCurrency || h.costCurrency || 'DKK';
    
    var editorHtml = '<div class="inline-price-editor" id="priceEditor-' + idx + '">' +
        '<input type="number" step="0.01" class="inline-price-input" id="priceInput-' + idx + '" value="' + currentPrice + '" placeholder="Price">' +
        '<select class="inline-price-currency" id="priceCurrencySelect-' + idx + '">' +
            '<option value="DKK"' + (currentCurrency==='DKK'?' selected':'') + '>DKK</option>' +
            '<option value="EUR"' + (currentCurrency==='EUR'?' selected':'') + '>EUR</option>' +
            '<option value="USD"' + (currentCurrency==='USD'?' selected':'') + '>USD</option>' +
        '</select>' +
        '<button class="inline-price-save" onclick="saveInlinePrice(' + idx + ')">Save</button>' +
        '<button class="inline-price-cancel" onclick="cancelInlinePrice(' + idx + ')">Cancel</button>' +
    '</div>';
    
    var existingEditor = document.getElementById('priceEditor-' + idx);
    if (existingEditor) {
        existingEditor.remove();
    } else {
        holdingEl.insertAdjacentHTML('beforeend', editorHtml);
        document.getElementById('priceInput-' + idx).focus();
    }
}

function saveInlinePrice(idx) {
    var priceInput = document.getElementById('priceInput-' + idx);
    var currencySelect = document.getElementById('priceCurrencySelect-' + idx);
    
    var newPrice = parseFloat(priceInput.value);
    if (!newPrice || newPrice <= 0) {
        alert('Please enter a valid price');
        return;
    }
    
    var h = portfolio.holdings[idx];
    h.manualPriceOverride = newPrice;
    h.manualPriceCurrency = currencySelect.value;
    h.currentPrice = newPrice;
    h.priceCurrency = currencySelect.value;
    h.isManualPrice = true;
    h.fetchError = false;
    
    save();
    render();
    recordIncomeSnapshot();
}

function cancelInlinePrice(idx) {
    var editor = document.getElementById('priceEditor-' + idx);
    if (editor) editor.remove();
}

function exportData() {
    var blob = new Blob([JSON.stringify(portfolio, null, 2)], {type:'application/json'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'portfolio-' + new Date().toISOString().split('T')[0] + '.json';
    a.click();
    URL.revokeObjectURL(url);
}

document.getElementById('importFile').onchange = function(e) {
    var file = e.target.files[0];
    if (!file) return;
    var reader = new FileReader();
    reader.onload = function(ev) {
        try {
            var imp = JSON.parse(ev.target.result);
            if (!Array.isArray(imp.holdings)) { alert('Invalid file.'); return; }
            if (confirm('Import ' + imp.holdings.length + ' holdings? This replaces current data.')) {
                portfolio = imp;
                save();
                render();
                alert('Imported successfully!');
            }
        } catch(err) { alert('Error: ' + err.message); }
    };
    reader.readAsText(file);
    e.target.value = '';
};

function toggleChat() {
    var c = document.getElementById('chatContainer');
    c.classList.toggle('show');
    if (c.classList.contains('show')) document.getElementById('chatInput').focus();
}

function addMsg(role, text) {
    var msgs = document.getElementById('chatMessages');
    var d = document.createElement('div');
    d.className = 'chat-message ' + role;
    d.textContent = text;
    msgs.appendChild(d);
    d.scrollIntoView({behavior:'smooth'});
}

// ============================================================================
// PORTFOLIO-AWARE AI CHAT SYSTEM
// ============================================================================
// Provides intelligent, personalized passive income advice based on actual holdings
// 
// IMPORTANT: The chat NEVER modifies the real portfolio
// - All data is read-only for context
// - AI only provides advice and analysis
// - User must manually make changes to their portfolio
//
// System Components:
// 1. systemPrompt - Defines AI personality and rules
// 2. getPortfolioContext() - Extracts all portfolio data
// 3. buildContextPrompt() - Formats data for AI
// 4. buildChatPayload() - Combines everything into API request
// 5. sendChatRequest() - Sends to AI and returns response
// 6. sendChatMessage() - Main orchestrator function
//
// The AI receives with every message:
// - Role definition (passive income advisor)
// - Complete portfolio JSON (holdings, totals, goals)
// - User's question
//
// This enables portfolio-aware, goal-focused, personalized advice.

// ============================================================================
// PORTFOLIO CONTEXT LOADER FOR AI CHAT
// ============================================================================
// Extracts all dashboard data for the AI chatbot to provide portfolio-aware advice

// System Prompt: Defines the chatbot's role and behavior
var systemPrompt = 
    "You are a Passive Income Advisor ‚Äî an expert in long-term investing, passive income generation, " +
    "and financial independence. Your role is to help users build sustainable wealth through dividends, " +
    "rental income, and interest.\n\n" +
    
    "CORE PRINCIPLES:\n" +
    "‚Ä¢ Focus on long-term, sustainable passive income strategies\n" +
    "‚Ä¢ Prioritize dividend growth, quality holdings, and diversification\n" +
    "‚Ä¢ Use the user's actual portfolio data as the source of truth\n" +
    "‚Ä¢ Avoid speculation, day trading, and market timing advice\n" +
    "‚Ä¢ Think in years and decades, not days or months\n\n" +
    
    "COMMUNICATION STYLE:\n" +
    "‚Ä¢ Use clear, simple language without excessive jargon\n" +
    "‚Ä¢ Be encouraging and supportive\n" +
    "‚Ä¢ Reference specific holdings by name when relevant\n" +
    "‚Ä¢ Provide actionable insights based on the user's actual data\n" +
    "‚Ä¢ Stay focused on income generation and financial independence\n\n" +
    
    "PORTFOLIO-AWARE REASONING:\n" +
    "‚Ä¢ Always reference holdings by name (e.g., 'your Apple shares', 'your Copenhagen apartment')\n" +
    "‚Ä¢ Use exact dividend amounts from the portfolio JSON\n" +
    "‚Ä¢ Calculate annual income by summing all holdings' annualIncome fields\n" +
    "‚Ä¢ Calculate yield as: (totalAnnualIncome / totalValue) √ó 100\n" +
    "‚Ä¢ Compare holdings: identify highest/lowest income contributors\n" +
    "‚Ä¢ For stocks: mention ticker, shares, dividend, and frequency\n" +
    "‚Ä¢ For property: reference rental income and property value\n" +
    "‚Ä¢ For savings: reference interest rate and amount\n" +
    "‚Ä¢ When discussing diversification, reference actual asset types in portfolio\n\n" +
    
    "GOAL AWARENESS:\n" +
    "‚Ä¢ Always relate suggestions back to the user's financial goals\n" +
    "‚Ä¢ Reference goals by their label (e.g., 'your First Million goal')\n" +
    "‚Ä¢ Calculate progress: (currentValue / target) √ó 100\n" +
    "‚Ä¢ For Net Worth goals: compare portfolio totalValue to target\n" +
    "‚Ä¢ For Savings goals: sum savings holdings and compare to target\n" +
    "‚Ä¢ For Income goals: compare totalAnnualIncome to target\n" +
    "‚Ä¢ Celebrate when goals are reached (percentage >= 100%)\n" +
    "‚Ä¢ Suggest next steps when goals are exceeded\n" +
    "‚Ä¢ Encourage when progress is being made (e.g., '75% toward your goal')\n" +
    "‚Ä¢ If no goals exist, suggest creating specific, measurable targets\n\n" +
    
    "WHAT TO DO:\n" +
    "‚Ä¢ Analyze the user's current holdings and income streams\n" +
    "‚Ä¢ Suggest ways to increase passive income\n" +
    "‚Ä¢ Identify diversification opportunities\n" +
    "‚Ä¢ Help track progress toward financial goals\n" +
    "‚Ä¢ Explain dividend reinvestment and compounding\n" +
    "‚Ä¢ Discuss yield, dividend growth, and sustainability\n" +
    "‚Ä¢ Compare user's progress to their stated goals\n" +
    "‚Ä¢ Connect every suggestion to goal achievement\n\n" +
    
    "WHAT TO AVOID:\n" +
    "‚Ä¢ Short-term trading strategies\n" +
    "‚Ä¢ Market timing or technical analysis\n" +
    "‚Ä¢ Speculative or high-risk investments\n" +
    "‚Ä¢ Crypto or volatile assets\n" +
    "‚Ä¢ Making specific buy/sell recommendations without context\n" +
    "‚Ä¢ Generic advice that ignores their actual holdings\n" +
    "‚Ä¢ Ignoring their stated goals when making suggestions\n\n" +
    
    "Remember: The user's portfolio data is provided in JSON format. Always use this as the foundation " +
    "for your analysis and advice. Reference their actual holdings, income, and goals. Be specific, not generic.";


function getPortfolioContext() {
    // Collect all portfolio data for the AI chatbot
    // Returns a clean JSON object matching the dashboard's data model
    
    var context = {
        // Holdings array with all details
        holdings: portfolio.holdings.map(function(h) {
            return {
                name: h.name,
                type: h.type,
                ticker: h.ticker || null,
                shares: h.shares || 0,
                currentPrice: h.currentPrice || h.manualPrice || h.cost || 0,
                priceCurrency: h.priceCurrency || h.costCurrency || 'DKK',
                dividend: h.dividend || 0,
                dividendCurrency: h.dividendCurrency || 'DKK',
                frequency: h.frequency || 'annual',
                propertyValue: h.propertyValue || 0,
                rentalIncome: h.rentalIncome || 0,
                savingsAmount: h.savingsAmount || 0,
                interestRate: h.interestRate || 0,
                value: holdingValue(h),
                annualIncome: holdingIncome(h)
            };
        }),
        
        // Portfolio totals
        totals: {
            totalValue: 0,
            totalAnnualIncome: 0,
            currentYield: 0
        },
        
        // Goals if any exist
        goals: loadGoals().map(function(g) {
            var progress = calculateGoalProgress(g);
            return {
                label: g.label,
                type: g.type,
                target: g.target,
                currency: g.currency,
                currentValue: progress.currentValue,
                percentage: progress.percentage,
                isCompleted: progress.isCompleted
            };
        }),
        
        // Display currency
        displayCurrency: displayCurrency,
        
        // Exchange rates
        rates: rates
    };
    
    // Calculate totals
    portfolio.holdings.forEach(function(h) {
        context.totals.totalValue += holdingValue(h);
        context.totals.totalAnnualIncome += holdingIncome(h);
    });
    
    context.totals.currentYield = context.totals.totalValue > 0 
        ? (context.totals.totalAnnualIncome / context.totals.totalValue * 100) 
        : 0;
    
    return context;
}

function buildContextPrompt() {
    // Build the context prompt that includes portfolio data
    // This is sent with every chat request so the AI is always aware of current holdings
    
    var context = getPortfolioContext();
    var contextJSON = JSON.stringify(context, null, 2);
    
    var contextPrompt = 
        "=== USER'S PORTFOLIO DATA (SOURCE OF TRUTH) ===\n\n" +
        "Here is the user's current portfolio. Use this data as the foundation for all analysis and advice.\n\n" +
        "```json\n" +
        contextJSON + "\n" +
        "```\n\n" +
        "KEY INFORMATION:\n" +
        "‚Ä¢ Total Portfolio Value: " + Math.round(context.totals.totalValue).toLocaleString() + " " + context.displayCurrency + "\n" +
        "‚Ä¢ Total Annual Income: " + Math.round(context.totals.totalAnnualIncome).toLocaleString() + " " + context.displayCurrency + "/year\n" +
        "‚Ä¢ Current Yield: " + context.totals.currentYield.toFixed(2) + "%\n" +
        "‚Ä¢ Number of Holdings: " + context.holdings.length + "\n" +
        "‚Ä¢ Number of Goals: " + context.goals.length + "\n\n" +
        "INSTRUCTIONS:\n" +
        "‚Ä¢ Reference holdings by name when relevant (e.g., 'your Apple shares')\n" +
        "‚Ä¢ Use these exact numbers in your calculations\n" +
        "‚Ä¢ Consider the user's goals when providing advice\n" +
        "‚Ä¢ Focus on how to increase passive income with their current holdings\n\n" +
        "Now, please respond to the user's question:";
    
    return contextPrompt;
}

function buildChatPayload(userMessage) {
    // Build the complete payload for the AI API
    // Combines: system prompt + context prompt + user message
    // Returns: properly formatted chat completion request
    
    var contextPrompt = buildContextPrompt();
    
    // Build messages array in chat completion format
    var messages = [
        {
            role: "system",
            content: systemPrompt
        },
        {
            role: "assistant",
            content: contextPrompt
        },
        {
            role: "user",
            content: userMessage
        }
    ];
    
    // Create the payload
    var payload = {
        model: "openai",  // Pollinations.ai uses "openai" as model identifier
        messages: messages,
        temperature: 0.7,
        max_tokens: 1000
    };
    
    return payload;
}

async function sendChatRequest(payload) {
    // Send the payload to the AI API and return the assistant's reply
    // Uses Pollinations.ai endpoint with portfolio-aware payload
    
    try {
        var response = await fetch('https://text.pollinations.ai/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });
        
        if (!response.ok) {
            throw new Error('API request failed: ' + response.status);
        }
        
        // Get response text
        var responseText = await response.text();
        
        // Pollinations.ai returns plain text, not JSON
        return responseText.trim();
        
    } catch (error) {
        console.error('Chat API Error:', error);
        return 'Sorry, I encountered an error. Please try again.';
    }
}

function sendChatMessage() {
function sendChatMessage() {
    var input = document.getElementById('chatInput');
    var msg = input.value.trim();
    if (!msg) return;
    
    // Add user message to chat
    addMsg('user', msg);
    input.value = '';
    
    // Disable send button while processing
    var btn = document.getElementById('chatSendBtn');
    btn.disabled = true;
    
    // Show "Thinking..." indicator
    var typing = document.createElement('div');
    typing.className = 'typing-indicator';
    typing.innerHTML = '<span></span><span></span><span></span>';
    document.getElementById('chatMessages').appendChild(typing);
    typing.scrollIntoView({behavior:'smooth'});
    
    // Build the complete payload with portfolio context
    var payload = buildChatPayload(msg);
    
    // Send request to AI API
    sendChatRequest(payload)
        .then(function(reply) {
            // Remove typing indicator
            typing.remove();
            
            // Add assistant's reply to chat
            addMsg('assistant', reply);
            
            // Store in chat history
            chatHistory.push({role:'user', content:msg});
            chatHistory.push({role:'assistant', content:reply});
            
            // Keep only last 12 messages (6 exchanges)
            if (chatHistory.length > 12) {
                chatHistory.splice(0, chatHistory.length - 12);
            }
            
            // Re-enable send button
            btn.disabled = false;
        })
        .catch(function(error) {
            // Handle errors
            typing.remove();
            addMsg('assistant', 'Sorry, I encountered an error. Please try again.');
            btn.disabled = false;
            console.error('Chat error:', error);
        });
}

function getFiltered() {
    var list = portfolio.holdings.filter(function(h) {
        if (activeFilters.length === 0) return true;
        return activeFilters.indexOf(h.type) !== -1;
    });
    if (searchTerm) {
        var t = searchTerm.toLowerCase();
        list = list.filter(function(h) {
            return h.name.toLowerCase().indexOf(t) !== -1 ||
                (h.ticker && h.ticker.toLowerCase().indexOf(t) !== -1) ||
                (h.address && h.address.toLowerCase().indexOf(t) !== -1);
        });
    }
    list.sort(function(a,b) {
        if (sortBy === 'value-asc') return holdingValue(a)-holdingValue(b);
        if (sortBy === 'yield-desc') {
            var va=holdingValue(a), vb=holdingValue(b);
            return (vb>0?holdingIncome(b)/vb:0)-(va>0?holdingIncome(a)/va:0);
        }
        if (sortBy === 'name') return a.name.localeCompare(b.name);
        return holdingValue(b)-holdingValue(a);
    });
    return list;
}

function updateFilters() {
    activeFilters = [];
    document.querySelectorAll('.filter-checkbox input[type="checkbox"]:checked').forEach(function(checkbox) {
        activeFilters.push(checkbox.dataset.type);
    });
    updateClearButton();
    render();
}

function syncCheckboxes() {
    document.querySelectorAll('.filter-checkbox input[type="checkbox"]').forEach(function(checkbox) {
        var type = checkbox.dataset.type;
        checkbox.checked = activeFilters.indexOf(type) !== -1;
    });
}

function applyPreset(presetName) {
    var types = filterPresets[presetName];
    if (!types) return;
    activeFilters = types.slice();
    syncCheckboxes();
    updateClearButton();
    render();
}

function clearFilters() {
    activeFilters = [];
    document.querySelectorAll('.filter-checkbox input[type="checkbox"]').forEach(function(checkbox) {
        checkbox.checked = false;
    });
    updateClearButton();
    render();
}

function updateClearButton() {
    var clearBtn = document.getElementById('clearFiltersBtn');
    if (clearBtn) {
        clearBtn.style.display = activeFilters.length > 0 ? 'block' : 'none';
    }
}

function renderChart(filtered) {
    var ctx = document.getElementById('allocationChart').getContext('2d');
    var types = {};
    var total = 0;
    filtered.forEach(function(h) { var v=holdingValue(h); types[h.type]=(types[h.type]||0)+v; total+=v; });
    var keys = Object.keys(types);
    var labels = keys.map(function(t) { var pct=total>0?(types[t]/total*100).toFixed(1):0; return t.charAt(0).toUpperCase()+t.slice(1)+' ('+pct+'%)'; });
    var vals = keys.map(function(t) { return types[t]; });
    if (allocationChart) {
        allocationChart.data.labels = labels;
        allocationChart.data.datasets[0].data = vals;
        allocationChart.update('none');
    } else {
        allocationChart = new Chart(ctx, {
            type: 'pie',
            data: { labels: labels, datasets:[{data:vals, backgroundColor:['#36A2EB','#FF6384','#FFCE56','#4BC0C0','#9966FF','#FF9F40']}] },
            options: { responsive:true, maintainAspectRatio:true, plugins:{ legend:{position:'bottom'}, tooltip:{callbacks:{label:function(c){ return fmt(fromDKK(c.raw,displayCurrency),displayCurrency); }}} } }
        });
    }
}

// Render 12-month calendar showing expected income per month
function renderMonthlyCalendar() {
    var monthlyMap = getMonthlyDividendMap();
    var container = document.getElementById('monthlyCalendar');
    container.innerHTML = '';
    
    var monthOrder = ['January', 'February', 'March', 'April', 'May', 'June',
                      'July', 'August', 'September', 'October', 'November', 'December'];
    
    monthOrder.forEach(function(month) {
        var amountDKK = monthlyMap[month];
        var amountDisplay = fromDKK(amountDKK, displayCurrency);
        
        var monthDiv = document.createElement('div');
        monthDiv.className = 'calendar-month';
        
        var nameDiv = document.createElement('div');
        nameDiv.className = 'calendar-month-name';
        nameDiv.textContent = month.substring(0, 3);
        
        var amountDiv = document.createElement('div');
        amountDiv.className = 'calendar-month-amount';
        if (amountDKK > 0) {
            amountDiv.classList.add('has-income');
            amountDiv.textContent = fmt(amountDisplay, displayCurrency);
        } else {
            amountDiv.classList.add('zero');
            amountDiv.textContent = '‚Äî';
        }
        
        monthDiv.appendChild(nameDiv);
        monthDiv.appendChild(amountDiv);
        container.appendChild(monthDiv);
    });
}

// Render income growth chart with time range filter
function renderIncomeGrowthChart(days) {
    var container = document.getElementById('incomeGrowthChart');
    var statsContainer = document.getElementById('incomeGrowthStats');
    
    if (incomeHistory.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:40px;color:#9ba5b8;">No historical data yet. Check back tomorrow!</div>';
        statsContainer.innerHTML = '';
        return;
    }
    
    var cutoffDate = new Date();
    if (days !== 'all') {
        cutoffDate.setDate(cutoffDate.getDate() - days);
    }
    
    var filtered = incomeHistory.filter(function(entry) {
        if (days === 'all') return true;
        return new Date(entry.date) >= cutoffDate;
    });
    
    if (filtered.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:40px;color:#9ba5b8;">Not enough data for this time range</div>';
        statsContainer.innerHTML = '';
        return;
    }
    
    var startIncome = fromDKK(filtered[0].income, displayCurrency);
    var endIncome = fromDKK(filtered[filtered.length - 1].income, displayCurrency);
    var change = endIncome - startIncome;
    var changePct = startIncome > 0 ? (change / startIncome * 100) : 0;
    
    var maxIncome = Math.max.apply(Math, filtered.map(function(e) { return e.income; }));
    var minIncome = Math.min.apply(Math, filtered.map(function(e) { return e.income; }));
    
    statsContainer.innerHTML = 
        '<div class="growth-stat">' +
            '<div class="growth-stat-label">Start</div>' +
            '<div class="growth-stat-value">' + fmt(startIncome, displayCurrency) + '</div>' +
        '</div>' +
        '<div class="growth-stat">' +
            '<div class="growth-stat-label">Current</div>' +
            '<div class="growth-stat-value">' + fmt(endIncome, displayCurrency) + '</div>' +
        '</div>' +
        '<div class="growth-stat">' +
            '<div class="growth-stat-label">Change</div>' +
            '<div class="growth-stat-value ' + (change >= 0 ? 'positive' : 'negative') + '">' +
                (change >= 0 ? '+' : '') + fmt(change, displayCurrency) + ' (' + changePct.toFixed(1) + '%)' +
            '</div>' +
        '</div>';
    
    var width = container.offsetWidth || 800;
    var height = 200;
    var padding = { top: 20, right: 20, bottom: 30, left: 50 };
    var chartWidth = width - padding.left - padding.right;
    var chartHeight = height - padding.top - padding.bottom;
    
    var xScale = function(i) {
        return padding.left + (i / Math.max(1, filtered.length - 1)) * chartWidth;
    };
    
    var yScale = function(value) {
        var range = maxIncome - minIncome;
        if (range === 0) return padding.top + chartHeight / 2;
        return padding.top + chartHeight - ((value - minIncome) / range) * chartHeight;
    };
    
    var pathData = filtered.map(function(entry, i) {
        var x = xScale(i);
        var y = yScale(entry.income);
        return (i === 0 ? 'M' : 'L') + x + ',' + y;
    }).join(' ');
    
    var areaData = 'M' + padding.left + ',' + (padding.top + chartHeight) + ' ' +
        pathData.substring(1) + ' L' + xScale(filtered.length - 1) + ',' + (padding.top + chartHeight) + ' Z';
    
    var svg = '<svg class="chart-svg" viewBox="0 0 ' + width + ' ' + height + '">' +
        '<defs>' +
            '<linearGradient id="gradient" x1="0%" y1="0%" x2="0%" y2="100%">' +
                '<stop offset="0%" style="stop-color:#4d94ff;stop-opacity:0.5" />' +
                '<stop offset="100%" style="stop-color:#4d94ff;stop-opacity:0" />' +
            '</linearGradient>' +
        '</defs>';
    
    for (var i = 0; i <= 4; i++) {
        var yPos = padding.top + (chartHeight / 4) * i;
        svg += '<line class="chart-grid" x1="' + padding.left + '" y1="' + yPos + '" x2="' + (padding.left + chartWidth) + '" y2="' + yPos + '" />';
        var val = maxIncome - ((maxIncome - minIncome) / 4) * i;
        svg += '<text class="chart-label" x="' + (padding.left - 10) + '" y="' + (yPos + 4) + '" text-anchor="end">' + 
            Math.round(fromDKK(val, displayCurrency) / 1000) + 'K</text>';
    }
    
    svg += '<path class="chart-area" d="' + areaData + '" />';
    svg += '<path class="chart-line" d="' + pathData + '" />';
    
    filtered.forEach(function(entry, i) {
        var x = xScale(i);
        var y = yScale(entry.income);
        svg += '<circle class="chart-dot" cx="' + x + '" cy="' + y + '" r="4" data-date="' + entry.date + '" data-income="' + entry.income + '" />';
    });
    
    svg += '</svg>';
    svg += '<div class="chart-tooltip" id="chartTooltip"></div>';
    
    container.innerHTML = svg;
    
    document.querySelectorAll('.chart-dot').forEach(function(dot) {
        dot.onmouseover = function(e) {
            var tooltip = document.getElementById('chartTooltip');
            var date = this.getAttribute('data-date');
            var income = parseFloat(this.getAttribute('data-income'));
            var displayIncome = fromDKK(income, displayCurrency);
            tooltip.innerHTML = '<div style="font-weight:600;margin-bottom:4px;">' + date + '</div>' +
                '<div>' + fmt(displayIncome, displayCurrency) + '</div>';
            tooltip.style.left = e.offsetX + 10 + 'px';
            tooltip.style.top = e.offsetY - 40 + 'px';
            tooltip.classList.add('show');
        };
        dot.onmouseout = function() {
            document.getElementById('chartTooltip').classList.remove('show');
        };
    });
}

function render() {
    var filtered = getFiltered();
    
    // Calculate portfolio totals across all holdings
    // Works correctly with mixed price sources:
    // - API-fetched prices (stocks/RSU with live data)
    // - Manual prices (unsupported exchanges like .CO, .MC)
    // - Fund prices (always manual)
    // - Property valuations
    // - Savings amounts
    var totVal=0, totCost=0, totInc=0;
    filtered.forEach(function(h) {
        totVal += holdingValue(h);
        totCost += (h.type==='property'||h.type==='savings') ? holdingValue(h) : toDKK((h.cost||0)*(h.shares||0), h.costCurrency||'DKK');
        totInc += holdingIncome(h);
    });

    var dVal  = fromDKK(totVal, displayCurrency);
    var dInc  = fromDKK(totInc, displayCurrency);
    var dChg  = fromDKK(totVal-totCost, displayCurrency);
    var chgPct = totCost ? ((totVal-totCost)/totCost*100) : 0;
    var yldPct = totVal  ? (totInc/totVal*100) : 0;

    var totYieldOnCost = 0;
    filtered.forEach(function(h) {
        if (h.type !== 'property' && h.type !== 'savings') {
            totYieldOnCost += toDKK((h.cost || 0) * (h.shares || 0), h.costCurrency || 'DKK');
        }
    });
    var yocPct = totYieldOnCost > 0 ? (totInc/totYieldOnCost*100) : 0;

    var monthlyInc = calculateMonthlyIncome(totInc);
    var dMonthlyInc = fromDKK(monthlyInc, displayCurrency);
    
    // Record daily portfolio snapshot (in DKK for consistency)
    recordDailySnapshot(totVal, totInc);

    document.getElementById('totalValue').textContent = fmt(dVal, displayCurrency);
    document.getElementById('monthlyIncome').textContent = fmt(dMonthlyInc, displayCurrency);
    document.getElementById('annualIncome').textContent = fmt(dInc, displayCurrency);
    document.getElementById('yieldPercent').textContent = yldPct.toFixed(2)+'%';
    document.getElementById('yieldOnCostPercent').textContent = yocPct.toFixed(2)+'%';

    var chgEl = document.getElementById('totalChange');
    chgEl.textContent = (dChg>=0?'+':'') + fmt(dChg,displayCurrency) + ' (' + chgPct.toFixed(1) + '%)';
    chgEl.className = 'change ' + (dChg>=0?'positive':'negative');

    var lbl = activeFilters.length === 0 
        ? 'All' 
        : activeFilters.map(function(t){ return t.charAt(0).toUpperCase() + t.slice(1); }).join(' + ');
    document.getElementById('filterLabel').textContent = '('+lbl+')';
    document.getElementById('incomeFilterLabel').textContent = '('+lbl+')';

    var container = document.getElementById('holdings');
    container.innerHTML = '';

    if (filtered.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:40px;color:#9ba5b8;">No holdings found</div>';
    } else {
        filtered.forEach(function(h) {
            var val=holdingValue(h), inc=holdingIncome(h);
            var yld=val?(inc/val*100):0;
            var dv=fromDKK(val,displayCurrency), di=fromDKK(Math.abs(inc),displayCurrency);
            var badge='', lines='', status='';

            if (h.type==='savings') {
                badge='<span class="badge badge-savings">SAVINGS</span>';
                lines='<div class="meta">Interest: '+(h.interestRate||0).toFixed(2)+'% per year</div>';
            } else if (h.type==='property') {
                badge='<span class="badge badge-property">PROPERTY</span>';
                lines=h.address?'<div class="meta">'+h.address+'</div>':'';
                var c=h.costs||{}, tc=(c.tax||0)+(c.power||0)+(c.water||0)+(c.gas||0)+(c.internet||0)+(c.other||0);
                if (tc>0) lines+='<div class="meta">Annual costs: '+fmt(fromDKK(toDKK(tc,h.costsCurrency||'DKK'),displayCurrency),displayCurrency)+'</div>';
            } else {
                var cv=toDKK((h.cost||0)*(h.shares||0),h.costCurrency||'DKK');
                var chg=val-cv, dCv=fromDKK(cv,displayCurrency), dChg2=fromDKK(chg,displayCurrency);
                var chgP=cv?(chg/cv*100):0;
                
                // Add type badges
                if (h.type==='fund') { 
                    badge='<span class="badge badge-fund">FUND</span>'; 
                }
                else if (h.type==='rsu') { 
                    badge='<span class="badge badge-rsu">RSU</span>'; 
                }
                
                // Add manual price badge if applicable
                if (h.isManualPrice) {
                    badge += '<span class="badge badge-manual" title="Price manually entered">MANUAL</span>';
                }
                
                // Set status indicator
                if (h.type==='fund') {
                    status='<span class="status manual-badge">Manual price</span>';
                } else if (h.type!=='fund') {
                    if (h.isManualPrice) {
                        status='<span class="status manual-badge" title="This price was manually entered">Manual price</span>';
                    } else if (h.fetchError) {
                        status='<span class="status failed">Fetch failed</span>';
                    } else if (h.currentPrice) {
                        status='<span class="status live">Live price</span>';
                    }
                }
                
                lines='<div class="meta">'+(h.shares||0)+' shares @ '+(h.cost||0).toFixed(2)+' '+(h.costCurrency||'DKK')+' = '+fmt(dCv,displayCurrency)+' cost</div>';
                lines+='<div class="meta '+(chg>=0?'positive':'negative')+'">'+(chg>=0?'+':'')+fmt(dChg2,displayCurrency)+' ('+chgP.toFixed(1)+'%)</div>';
            }

            var incLabel=inc>=0?'Income':'Cost';
            var yocDisplay = '';
            
            if (h.type !== 'property' && h.type !== 'savings') {
                var yoc = holdingYieldOnCost(h);
                if (yoc > 0) {
                    yocDisplay = '<div class="meta">Yield-on-Cost: <span class="positive">' + yoc.toFixed(2) + '%</span></div>';
                }
            }
            
            var d=document.createElement('div');
            d.className='holding';
            var hIdx=portfolio.holdings.indexOf(h);
            d.id = 'holding-' + hIdx;
            
            var editPriceBtn = '';
            if (manualPriceMode && (h.type === 'stock' || h.type === 'fund' || h.type === 'rsu')) {
                editPriceBtn = '<button class="edit-price-btn" onclick="event.stopPropagation(); showInlinePriceEditor(' + hIdx + ')">Edit Price</button>';
            }
            
            d.onclick=(function(i){ return function(){ editHolding(i); }; })(hIdx);
            d.innerHTML='<div class="holding-header"><span class="holding-name">'+h.name+badge+editPriceBtn+'</span><span>'+fmt(dv,displayCurrency)+'</span></div>'+lines+'<div class="meta">'+incLabel+': '+fmt(di,displayCurrency)+'/yr ('+yld.toFixed(1)+'%)</div>'+yocDisplay+status;
            container.appendChild(d);
        });
    }

    renderChart(filtered);
    renderMonthlyCalendar();
    renderIncomeGrowthChart(activeTimeRange);
    
    // Draw portfolio history chart
    var historyData = getChartData(activeHistoryRange);
    var chartValues = activeHistoryMetric === 'value' ? historyData.values 
                    : activeHistoryMetric === 'income' ? historyData.income 
                    : historyData.yield;
    drawHistoryChart(historyData.labels, chartValues, activeHistoryMetric);
    
    // Update goals progress
    renderGoals();
    checkGoalNotifications();
    
    if (portfolio.lastUpdate) {
        document.getElementById('lastUpdate').textContent = 'Last update: ' + new Date(portfolio.lastUpdate).toLocaleString('da-DK');
    }
    updateNextDisplay();
}

document.getElementById('addBtn').onclick = function() { editingIdx=null; clearForm(); document.getElementById('modalTitle').textContent='Add Holding'; document.getElementById('modal').classList.add('show'); };
document.getElementById('closeBtn').onclick = function() { document.getElementById('modal').classList.remove('show'); };
document.getElementById('saveBtn').onclick = saveHolding;
document.getElementById('deleteBtn').onclick = deleteHolding;
document.getElementById('refreshBtn').onclick = refreshPrices;
document.getElementById('chatBtn').onclick = toggleChat;
document.getElementById('closeChatBtn').onclick = toggleChat;
document.getElementById('type').onchange = toggleFields;
document.getElementById('chatSendBtn').onclick = sendChatMessage;
document.getElementById('chatInput').onkeypress = function(e) { if (e.key==='Enter') sendChatMessage(); };
document.getElementById('settingsBtn').onclick = function() { document.getElementById('settingsModal').classList.add('show'); };
document.getElementById('closeSettingsBtn').onclick = function() { document.getElementById('settingsModal').classList.remove('show'); };
document.getElementById('exportBtn').onclick = exportData;
document.getElementById('importBtn').onclick = function() { document.getElementById('importFile').click(); };
document.getElementById('clearAllData').onclick = function() { if (confirm('Delete ALL data? Cannot be undone!')) { localStorage.clear(); location.reload(); } };

document.getElementById('manualPriceToggle').checked = manualPriceMode;
document.getElementById('manualPriceToggle').onchange = function() {
    manualPriceMode = this.checked;
    localStorage.setItem('manualPriceMode', manualPriceMode);
    // If modal is open, refresh fields visibility
    if (document.getElementById('modal').classList.contains('show')) {
        toggleFields();
    }
};

document.getElementById('goalNotificationsToggle').checked = goalNotificationsEnabled;
document.getElementById('goalNotificationsToggle').onchange = function() {
    goalNotificationsEnabled = this.checked;
    localStorage.setItem('goalNotifications', goalNotificationsEnabled);
};

document.getElementById('searchInput').oninput = function(e) { searchTerm=e.target.value; render(); };
document.getElementById('sortSelect').onchange = function(e) { sortBy=e.target.value; render(); };

document.querySelectorAll('.filter-checkbox input[type="checkbox"]').forEach(function(checkbox) {
    checkbox.onchange = updateFilters;
});

document.querySelectorAll('.preset-btn').forEach(function(btn) {
    btn.onclick = function() {
        applyPreset(btn.dataset.preset);
    };
});

document.getElementById('clearFiltersBtn').onclick = clearFilters;

var activeTimeRange = 30;
var activeHistoryRange = 'all';
var activeHistoryMetric = 'value';

document.querySelectorAll('.time-toggle').forEach(function(toggle) {
    toggle.onclick = function() {
        document.querySelectorAll('.time-toggle').forEach(function(t) {
            t.classList.remove('active');
        });
        this.classList.add('active');
        var range = this.dataset.range;
        activeTimeRange = range === 'all' ? 'all' : parseInt(range);
        renderIncomeGrowthChart(activeTimeRange);
    };
});

document.querySelectorAll('.history-range-toggle').forEach(function(toggle) {
    toggle.onclick = function() {
        document.querySelectorAll('.history-range-toggle').forEach(function(t) {
            t.classList.remove('active');
        });
        this.classList.add('active');
        activeHistoryRange = this.dataset.range;
        var historyData = getChartData(activeHistoryRange);
        var chartValues = activeHistoryMetric === 'value' ? historyData.values 
                        : activeHistoryMetric === 'income' ? historyData.income 
                        : historyData.yield;
        drawHistoryChart(historyData.labels, chartValues, activeHistoryMetric);
    };
});

document.getElementById('historyMetric').onchange = function() {
    activeHistoryMetric = this.value;
    var historyData = getChartData(activeHistoryRange);
    var chartValues = activeHistoryMetric === 'value' ? historyData.values 
                    : activeHistoryMetric === 'income' ? historyData.income 
                    : historyData.yield;
    drawHistoryChart(historyData.labels, chartValues, activeHistoryMetric);
};

// Goal tracking event handlers
document.getElementById('saveGoalBtn').onclick = createGoal;
document.getElementById('goalCurrency').value = displayCurrency; // Default to display currency

updateRates();
checkAutoUpdate();
updateClearButton();
render();
renderGoals(); // Initialize goals display
recordIncomeSnapshot();
setInterval(checkAutoUpdate, 60000);
setInterval(updateNextDisplay, 60000);
setInterval(recordIncomeSnapshot, 3600000);
</script>

</body>
</html>
