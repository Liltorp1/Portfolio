<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passive Income Portfolio</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: #0a0e1a; color: #e8edf4; padding: 20px 20px 100px; }
        h1 { font-size: 28px; margin-bottom: 10px; }
        .card { background: #1a2237; border: 1px solid #2a3550; border-radius: 12px; padding: 20px; margin-bottom: 15px; }
        .label { font-size: 12px; color: #9ba5b8; text-transform: uppercase; margin-bottom: 8px; }
        .value { font-size: 32px; font-weight: 300; margin-bottom: 5px; }
        .change { font-size: 14px; color: #9ba5b8; }
        .positive { color: #00ff88; }
        .negative { color: #ff4466; }
        .btn { background: #4d94ff; color: white; border: none; border-radius: 10px; padding: 14px 24px; font-size: 16px; width: 100%; cursor: pointer; }
        .btn:active { opacity: 0.8; }
        .btn-small { width: auto; padding: 10px 20px; font-size: 14px; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); padding: 20px; overflow-y: auto; z-index: 1000; }
        .modal.show { display: block; }
        .modal-content { background: #1a2237; border-radius: 16px; padding: 24px; max-width: 500px; margin: 40px auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close { font-size: 30px; color: #9ba5b8; cursor: pointer; background: none; border: none; }
        input, select { width: 100%; background: #0a0e1a; border: 1px solid #2a3550; border-radius: 8px; padding: 12px; color: #e8edf4; font-size: 16px; margin-bottom: 15px; }
        label { display: block; font-size: 14px; color: #9ba5b8; margin-bottom: 5px; }
        .holding { background: #1a2237; border: 1px solid #2a3550; border-radius: 10px; padding: 15px; margin-bottom: 10px; cursor: pointer; }
        .holding:active { background: #202840; }
        .holding-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .ticker { font-size: 18px; font-weight: 600; }
        .meta { font-size: 12px; color: #9ba5b8; margin-top: 4px; }
        .section-title { font-size: 12px; text-transform: uppercase; color: #9ba5b8; margin: 20px 0 15px; display: flex; justify-content: space-between; align-items: center; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: #151b2e; padding: 12px; display: flex; gap: 8px; }
        .nav-btn { flex: 1; padding: 12px; background: #1a2237; border: 1px solid #2a3550; border-radius: 8px; color: #9ba5b8; font-size: 14px; cursor: pointer; border: none; }
        .status { font-size: 10px; margin-top: 3px; }
        .currency-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .currency-row input { flex: 2; margin-bottom: 0; }
        .currency-row select { flex: 1; margin-bottom: 0; }
        .live { color: #00ff88; }
        .manual-price { color: #ffc044; }
        .failed { color: #ff4466; }
        .fund-badge { background: #2a3550; padding: 2px 8px; border-radius: 4px; font-size: 10px; margin-left: 8px; }
        .info-text { font-size: 12px; color: #9ba5b8; margin-top: -10px; margin-bottom: 15px; font-style: italic; }
        .filter-tabs { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; }
        .filter-tab { padding: 8px 16px; background: #1a2237; border: 1px solid #2a3550; border-radius: 8px; color: #9ba5b8; font-size: 13px; cursor: pointer; white-space: nowrap; }
        .filter-tab.active { background: #4d94ff; color: white; border-color: #4d94ff; }
        .filter-tab:active { opacity: 0.7; }
        .next-update { font-size: 11px; color: #9ba5b8; margin-top: 5px; }
        body.light {
            --bg: #f8f9fa;
            --text: #212529;
            --card-bg: #ffffff;
            --border: #dee2e6;
            --input-bg: #ffffff;
            --input-text: #212529;
            --btn-bg: #007bff;
            --btn-text: white;
        }
        body.light .card { background: var(--card-bg); border-color: var(--border); }
        body.light input, body.light select { background: var(--input-bg); color: var(--input-text); border-color: #ced4da; }
        body.light button { background: var(--btn-bg); color: var(--btn-text); }
        #theme-toggle {
            position: fixed; top: 1rem; right: 1rem; z-index: 1000;
            padding: 0.5rem 1rem; background: #444; color: white; border: none; border-radius: 6px; cursor: pointer;
        }
        body.light #theme-toggle { background: #ddd; color: #333; }
    </style>
</head>
<body class="dark">
    <button id="theme-toggle">Toggle Theme</button>
    <h1>Passive Income</h1>
    <div class="meta" id="lastUpdate" style="margin-bottom:5px;">Never updated</div>
    <div class="next-update" id="nextUpdate">Next auto-update: calculating...</div>

    <!-- Your existing cards, filter-tabs, search/sort, holdings div, modal, bottom-nav remain unchanged -->
    <div class="card">
        <div class="label">Portfolio Value <span id="filterLabel" style="text-transform:none;">(All)</span></div>
        <div class="value" id="totalValue">0 DKK</div>
        <div class="change" id="totalChange">—</div>
    </div>
    <div class="card">
        <div class="label">Annual Income <span id="incomeFilterLabel" style="text-transform:none;">(All)</span></div>
        <div class="value" id="annualIncome">0 DKK</div>
        <div class="change"><span id="yieldPercent">0.0%</span> yield</div>
    </div>
    <div class="card" id="allocation-card">
        <h3>Portfolio Allocation</h3>
        <canvas id="allocationChart" height="200"></canvas>
    </div>
    <!-- ... rest of your HTML (filters, holdings, modal, bottom nav) ... -->

    <script>
        // === API KEYS (inserted from your message) ===
        const EODHD_API_KEY = '698fa6d0d113a5.96289084';
        const TWELVEDATA_API_KEY = 'f4faaf5fc1f149eeb9364b8065b8298b';

        var data = JSON.parse(localStorage.getItem('portfolio') || '{"holdings":[],"lastUpdate":null}');
        var editing = null;
        var isRefreshing = false;
        var activeFilter = 'all';

        let exchangeRates = { DKK: 1, EUR: 7.46, USD: 6.88 };

        async function updateExchangeRates() {
            try {
                const response = await fetch('https://api.frankfurter.app/latest?to=DKK,EUR,USD');
                if (!response.ok) throw new Error('Rates fetch failed');
                const rateData = await response.json();
                const rates = rateData.rates;
                exchangeRates.EUR = rates.DKK ? rates.DKK : exchangeRates.EUR;
                exchangeRates.USD = rates.USD ? rates.DKK / rates.USD : exchangeRates.USD;
                console.log('Exchange rates updated:', exchangeRates);
                render();
            } catch (err) {
                console.error('Failed to fetch exchange rates:', err);
                alert('Could not update exchange rates – using cached values.');
            }
        }

        function convertToDKK(amount, currency) {
            return amount * (exchangeRates[currency] || 1);
        }

        // Keep your existing getNextUpdateTime, updateNextUpdateDisplay, theme handling, getFilteredAndSortedHoldings, renderAllocationChart, getHoldingValue, render functions...
        // (Omit repeating them here for brevity – keep them as in your previous version)

        async function fetchPriceForHolding(h) {
            if (h.type === 'fund' || !h.ticker) {
                h.fetchError = true;
                return;
            }

            const symbol = h.ticker.toUpperCase();
            let fetched = false;

            // 1. Try EODHD (primary – best for .CO / .MC)
            if (EODHD_API_KEY) {
                try {
                    const url = `https://eodhd.com/api/real-time/${symbol}?api_token=${EODHD_API_KEY}&fmt=json`;
                    const response = await fetch(url);
                    if (response.ok) {
                        const json = await response.json();
                        let price = json.close || json.previousClose || json.price;
                        if (price && price > 0) {
                            h.currentPrice = price;
                            h.priceCurrency = json.currency || 'USD';
                            h.fetchError = false;
                            fetched = true;
                            console.log(`EODHD SUCCESS: ${symbol} → ${price} ${h.priceCurrency}`);
                        }
                    }
                } catch (e) {
                    console.warn(`EODHD failed for ${symbol}: ${e.message}`);
                }
            }

            // 2. Fallback to Twelve Data
            if (!fetched && TWELVEDATA_API_KEY) {
                try {
                    const url = `https://api.twelvedata.com/quote?symbol=${symbol}&apikey=${TWELVEDATA_API_KEY}`;
                    const response = await fetch(url);
                    if (response.ok) {
                        const json = await response.json();
                        if (json.code === 400 || json.status === "error") throw new Error(json.message || "API error");
                        let price = json.close || json.previous_close || json.last;
                        if (price && price > 0) {
                            h.currentPrice = price;
                            h.priceCurrency = json.currency || 'USD';
                            h.fetchError = false;
                            fetched = true;
                            console.log(`Twelve Data SUCCESS: ${symbol} → ${price} ${h.priceCurrency}`);
                        }
                    }
                } catch (e) {
                    console.warn(`Twelve Data failed for ${symbol}: ${e.message}`);
                }
            }

            if (!fetched) {
                h.fetchError = true;
                console.error(`All price fetches failed for ${symbol} – using manual/backup price`);
            }
        }

        async function refreshPrices() {
            if (isRefreshing) return;
            isRefreshing = true;
            document.getElementById('refreshBtn').textContent = 'Refreshing...';

            await updateExchangeRates();

            const promises = data.holdings
                .filter(h => h.type !== 'fund' && h.ticker)
                .map(fetchPriceForHolding);

            await Promise.all(promises);

            data.lastUpdate = new Date().toISOString();
            localStorage.setItem('portfolio', JSON.stringify(data));

            render();

            isRefreshing = false;
            document.getElementById('refreshBtn').textContent = 'Refresh';
        }

        // Keep your existing checkAutoUpdate, modal functions, save/delete, export, event listeners, init...
        // (unchanged – just make sure refreshBtn calls refreshPrices)

        // Init
        updateExchangeRates();
        checkAutoUpdate();
        render();
        setInterval(checkAutoUpdate, 60000);
    </script>
</body>
</html>
