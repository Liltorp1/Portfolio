<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passive Income Portfolio</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
            background: #0a0e1a; 
            color: #e8edf4; 
            padding: 20px 20px 100px; 
            min-height: 100vh;
        }
        h1 { font-size: 28px; margin-bottom: 10px; }
        .card { 
            background: #1a2237; 
            border: 1px solid #2a3550; 
            border-radius: 12px; 
            padding: 20px; 
            margin-bottom: 15px; 
        }
        .label { font-size: 12px; color: #9ba5b8; text-transform: uppercase; margin-bottom: 8px; }
        .value { font-size: 32px; font-weight: 300; margin-bottom: 5px; }
        .change { font-size: 14px; color: #9ba5b8; }
        .positive { color: #00ff88; }
        .negative { color: #ff4466; }
        .btn { 
            background: #4d94ff; 
            color: white; 
            border: none; 
            border-radius: 10px; 
            padding: 14px 24px; 
            font-size: 16px; 
            width: 100%; 
            cursor: pointer; 
        }
        .btn:active { opacity: 0.8; }
        .btn-small { width: auto; padding: 10px 20px; font-size: 14px; }
        .modal { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: rgba(0,0,0,0.9); 
            padding: 20px; 
            overflow-y: auto; 
            z-index: 1000; 
        }
        .modal.show { display: block; }
        .modal-content { 
            background: #1a2237; 
            border-radius: 16px; 
            padding: 24px; 
            max-width: 500px; 
            margin: 40px auto; 
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close { font-size: 30px; color: #9ba5b8; cursor: pointer; background: none; border: none; }
        input, select { 
            width: 100%; 
            background: #0a0e1a; 
            border: 1px solid #2a3550; 
            border-radius: 8px; 
            padding: 12px; 
            color: #e8edf4; 
            font-size: 16px; 
            margin-bottom: 15px; 
        }
        label { display: block; font-size: 14px; color: #9ba5b8; margin-bottom: 5px; }
        .holding { 
            background: #1a2237; 
            border: 1px solid #2a3550; 
            border-radius: 10px; 
            padding: 15px; 
            margin-bottom: 10px; 
            cursor: pointer; 
        }
        .holding:active { background: #202840; }
        .holding-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .ticker { font-size: 18px; font-weight: 600; }
        .meta { font-size: 12px; color: #9ba5b8; margin-top: 4px; }
        .section-title { 
            font-size: 12px; 
            text-transform: uppercase; 
            color: #9ba5b8; 
            margin: 20px 0 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .bottom-nav { 
            position: fixed; 
            bottom: 0; left: 0; right: 0; 
            background: #151b2e; 
            padding: 12px; 
            display: flex; 
            gap: 8px; 
        }
        .nav-btn { 
            flex: 1; 
            padding: 12px; 
            background: #1a2237; 
            border: 1px solid #2a3550; 
            border-radius: 8px; 
            color: #9ba5b8; 
            font-size: 14px; 
            cursor: pointer; 
        }
        .status { font-size: 10px; margin-top: 3px; }
        .currency-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .currency-row input { flex: 2; margin-bottom: 0; }
        .currency-row select { flex: 1; margin-bottom: 0; }
        .live { color: #00ff88; }
        .manual-price { color: #ffc044; }
        .failed { color: #ff4466; }
        .fund-badge { background: #2a3550; padding: 2px 8px; border-radius: 4px; font-size: 10px; margin-left: 8px; }
        .info-text { font-size: 12px; color: #9ba5b8; margin-top: -10px; margin-bottom: 15px; font-style: italic; }
        .filter-tabs { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 4px; }
        .filter-tab { 
            padding: 8px 16px; 
            background: #1a2237; 
            border: 1px solid #2a3550; 
            border-radius: 8px; 
            color: #9ba5b8; 
            font-size: 13px; 
            cursor: pointer; 
            white-space: nowrap; 
        }
        .filter-tab.active { background: #4d94ff; color: white; border-color: #4d94ff; }
        .next-update { font-size: 11px; color: #9ba5b8; margin-top: 5px; }
        body.light {
            --bg: #f8f9fa;
            --text: #212529;
            --card-bg: #ffffff;
            --border: #dee2e6;
            --input-bg: #ffffff;
            --input-text: #212529;
            --btn-bg: #007bff;
            --btn-text: white;
        }
        body.light .card { background: var(--card-bg); border-color: var(--border); }
        body.light input, body.light select { background: var(--input-bg); color: var(--input-text); border-color: #ced4da; }
        body.light button { background: var(--btn-bg); color: var(--btn-text); }
        #theme-toggle {
            position: fixed; top: 1rem; right: 1rem; z-index: 1000;
            padding: 0.5rem 1rem; background: #444; color: white; border: none; border-radius: 6px; cursor: pointer;
        }
        body.light #theme-toggle { background: #ddd; color: #333; }
    </style>
</head>
<body class="dark">

    <button id="theme-toggle">Toggle Theme</button>

    <h1>Passive Income</h1>
    <div class="meta" id="lastUpdate" style="margin-bottom:5px;">Never updated</div>
    <div class="next-update" id="nextUpdate">Next auto-update: calculating...</div>

    <div class="card">
        <div class="label">Portfolio Value <span id="filterLabel" style="text-transform:none;">(All)</span></div>
        <div class="value" id="totalValue">0 DKK</div>
        <div class="change" id="totalChange">—</div>
    </div>

    <div class="card">
        <div class="label">Annual Income <span id="incomeFilterLabel" style="text-transform:none;">(All)</span></div>
        <div class="value" id="annualIncome">0 DKK</div>
        <div class="change"><span id="yieldPercent">0.0%</span> yield</div>
    </div>

    <div class="card" id="allocation-card">
        <h3>Portfolio Allocation</h3>
        <canvas id="allocationChart" height="200"></canvas>
    </div>

    <div class="filter-tabs">
        <div class="filter-tab active" data-filter="all">All</div>
        <div class="filter-tab" data-filter="stock">Stocks</div>
        <div class="filter-tab" data-filter="fund">Funds</div>
        <div class="filter-tab" data-filter="rsu">RSU</div>
        <div class="filter-tab" data-filter="stock,fund">Stocks + Funds</div>
        <div class="filter-tab" data-filter="stock,rsu">Stocks + RSU</div>
        <div class="filter-tab" data-filter="fund,rsu">Funds + RSU</div>
    </div>

    <div class="section-title">
        <span>HOLDINGS</span>
        <button class="btn btn-small" id="addBtn">+ Add</button>
    </div>

    <div style="margin: 1rem 0; display: flex; gap: 1rem; flex-wrap: wrap;">
        <input type="text" id="searchInput" placeholder="Search by name/ticker..." style="padding: 0.5rem; flex: 1;">
        <select id="sortSelect">
            <option value="value-desc">Value (High → Low)</option>
            <option value="value-asc">Value (Low → High)</option>
            <option value="yield-desc">Yield (High → Low)</option>
            <option value="name">Name (A-Z)</option>
        </select>
    </div>

    <div id="holdings"></div>

    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add Holding</h2>
                <button class="close" id="closeBtn">×</button>
            </div>

            <label>Type</label>
            <select id="type">
                <option value="stock">Stock (auto-updates)</option>
                <option value="fund">Fund (manual only)</option>
                <option value="rsu">RSU (auto-updates)</option>
            </select>

            <div id="tickerField">
                <label>Ticker Symbol</label>
                <input type="text" id="ticker" placeholder="e.g., ASTK.CO, FLYW, IBE.MC">
            </div>

            <label>Name</label>
            <input type="text" id="name" placeholder="e.g., Asetek A/S">

            <label>Shares / Units</label>
            <input type="number" step="0.01" id="shares">

            <label>Average Cost per Share/Unit</label>
            <div class="currency-row">
                <input type="number" step="0.01" id="cost">
                <select id="costCurrency">
                    <option value="DKK">DKK</option>
                    <option value="EUR">EUR</option>
                    <option value="USD">USD</option>
                </select>
            </div>

            <div id="currentPriceField">
                <label>Current Price <span id="priceLabel">(optional - backup if auto-fetch fails)</span></label>
                <div class="info-text" id="priceInfoStock" style="display:block;">
                    Stocks/RSU: Auto-updates via EODHD / Twelve Data. Enter manually only as backup.
                </div>
                <div class="info-text" id="priceInfoFund" style="display:none;">
                    Funds: Required - will NOT auto-update. Update manually when needed.
                </div>
                <div class="currency-row">
                    <input type="number" step="0.01" id="currentPrice" placeholder="Leave empty for auto-fetch">
                    <select id="priceCurrency">
                        <option value="DKK">DKK</option>
                        <option value="EUR">EUR</option>
                        <option value="USD">USD</option>
                    </select>
                </div>
            </div>

            <label>Annual Dividend/Distribution per Share</label>
            <div class="currency-row">
                <input type="number" step="0.01" id="dividend" placeholder="0 if none">
                <select id="dividendCurrency">
                    <option value="DKK">DKK</option>
                    <option value="EUR">EUR</option>
                    <option value="USD">USD</option>
                </select>
            </div>

            <button class="btn" id="saveBtn">Save</button>
            <button class="btn" id="deleteBtn" style="display:none; background:#ff4466; margin-top:10px;">Delete</button>
        </div>
    </div>

    <div class="bottom-nav">
        <button class="nav-btn">Dashboard</button>
        <button class="nav-btn" id="refreshBtn">Refresh</button>
        <button class="nav-btn" id="exportBtn">Export</button>
    </div>

    <script>
        // API KEYS
        const EODHD_API_KEY = '698fa6d0d113a5.96289084';
        const TWELVEDATA_API_KEY = 'f4faaf5fc1f149eeb9364b8065b8298b';

        let data = JSON.parse(localStorage.getItem('portfolio') || '{"holdings":[],"lastUpdate":null}');
        let editing = null;
        let isRefreshing = false;
        let activeFilter = 'all';
        let searchTerm = '';
        let sortBy = 'value-desc';

        let exchangeRates = { DKK: 1, EUR: 7.46, USD: 6.88 };

        let allocationChart = null;

        // Exchange Rates
        async function updateExchangeRates() {
            try {
                const res = await fetch('https://api.frankfurter.app/latest?to=DKK,EUR,USD');
                if (!res.ok) throw new Error('Rates fetch failed');
                const json = await res.json();
                const rates = json.rates;
                exchangeRates.EUR = rates.DKK ? rates.DKK : exchangeRates.EUR;
                exchangeRates.USD = rates.USD ? rates.DKK / rates.USD : exchangeRates.USD;
                console.log('Exchange rates updated:', exchangeRates);
            } catch (err) {
                console.error('Exchange rates failed:', err);
            }
        }

        function convertToDKK(amount, currency) {
            return (amount || 0) * (exchangeRates[currency] || 1);
        }

        // Time helpers
        function getNextUpdateTime() {
            const now = new Date();
            let cet = new Date(now.getTime() + (now.getTimezoneOffset() + 60) * 60000);
            let h = cet.getHours();
            let next = new Date(cet);
            if (h < 8)      next.setHours(8, 0, 0, 0);
            else if (h < 22) next.setHours(22,0, 0, 0);
            else {
                next.setDate(next.getDate()+1);
                next.setHours(8,0,0,0);
            }
            return new Date(next.getTime() - (now.getTimezoneOffset() + 60) * 60000);
        }

        function updateNextUpdateDisplay() {
            const next = getNextUpdateTime();
            const diffMs = next - Date.now();
            const h = Math.floor(diffMs / 3600000);
            const m = Math.floor((diffMs % 3600000) / 60000);
            const timeStr = next.toLocaleTimeString('da-DK', {hour:'2-digit', minute:'2-digit'});
            let text = h < 1 ? `in ${m} min` : h < 24 ? `in ${h}h ${m}m` : `tomorrow at ${timeStr}`;
            document.getElementById('nextUpdate').textContent = `Next auto-update ${text} (${timeStr})`;
        }

        // Theme toggle
        const themeToggle = document.getElementById('theme-toggle');
        let currentTheme = localStorage.getItem('theme') || 'dark';
        document.body.className = currentTheme;
        themeToggle.textContent = currentTheme === 'dark' ? 'Light Mode' : 'Dark Mode';

        themeToggle.onclick = () => {
            if (document.body.classList.contains('dark')) {
                document.body.classList.remove('dark');
                document.body.classList.add('light');
                localStorage.setItem('theme', 'light');
                themeToggle.textContent = 'Dark Mode';
            } else {
                document.body.classList.remove('light');
                document.body.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                themeToggle.textContent = 'Light Mode';
            }
        };

        // ────────────────────────────────────────────────
        //  IMPROVED PRICE FETCHING
        // ────────────────────────────────────────────────
        async function fetchPriceForHolding(h) {
            if (h.type === 'fund' || !h.ticker) {
                h.fetchError = true;
                console.log(`Skipping fetch for fund or missing ticker: ${h.name}`);
                return;
            }

            const symbol = h.ticker.toUpperCase();
            let fetched = false;

            console.log(`Trying to fetch price for: ${symbol}`);

            // 1. EODHD (primary)
            if (EODHD_API_KEY) {
                try {
                    const url = `https://eodhd.com/api/real-time/${symbol}?api_token=${EODHD_API_KEY}&fmt=json`;
                    const response = await fetch(url);
                    console.log(`EODHD HTTP status for ${symbol}: ${response.status}`);

                    if (response.ok) {
                        const json = await response.json();
                        console.log(`EODHD full response for ${symbol}:`, json);

                        // Use fields that exist in your actual response
                        let price = json.close || json.previousClose || json.open || 0;

                        if (price > 0) {
                            h.currentPrice = price;
                            h.priceCurrency = json.currency || 'DKK';  // .CO is DKK
                            h.fetchError = false;
                            fetched = true;
                            console.log(`EODHD SUCCESS: ${symbol} → ${price} ${h.priceCurrency}`);
                        } else {
                            console.warn(`EODHD returned no valid price for ${symbol}`);
                        }
                    } else {
                        console.warn(`EODHD HTTP error ${response.status} for ${symbol}`);
                    }
                } catch (err) {
                    console.error(`EODHD fetch error for ${symbol}:`, err.message);
                }
            }

            // 2. Twelve Data fallback
            if (!fetched && TWELVEDATA_API_KEY) {
                try {
                    // Try both formats
                    let attempts = [symbol, symbol.replace('.CO', ':XCSE')];
                    for (let attempt of attempts) {
                        const url = `https://api.twelvedata.com/quote?symbol=${encodeURIComponent(attempt)}&apikey=${TWELVEDATA_API_KEY}`;
                        const response = await fetch(url);
                        console.log(`Twelve Data attempt ${attempt} status: ${response.status}`);

                        if (response.ok) {
                            const json = await response.json();
                            console.log(`Twelve Data response for ${attempt}:`, json);

                            if (json.status === 'error' || json.code) continue;

                            let price = json.close || json.previous_close || json.last || 0;
                            if (price > 0) {
                                h.currentPrice = price;
                                h.priceCurrency = json.currency || 'USD';
                                h.fetchError = false;
                                fetched = true;
                                console.log(`Twelve Data SUCCESS: ${attempt} → ${price} ${h.priceCurrency}`);
                                break;
                            }
                        }
                    }
                } catch (err) {
                    console.error(`Twelve Data error for ${symbol}:`, err.message);
                }
            }

            if (!fetched) {
                h.fetchError = true;
                console.error(`All price sources failed for ${symbol} — using manual price if set`);
            }
        }

        async function refreshPrices() {
            if (isRefreshing) return;
            isRefreshing = true;
            document.getElementById('refreshBtn').textContent = 'Refreshing...';

            await updateExchangeRates();

            const promises = data.holdings
                .filter(h => h.type !== 'fund' && h.ticker)
                .map(h => fetchPriceForHolding(h));

            await Promise.all(promises);

            data.lastUpdate = new Date().toISOString();
            localStorage.setItem('portfolio', JSON.stringify(data));

            render();

            isRefreshing = false;
            document.getElementById('refreshBtn').textContent = 'Refresh';
        }

        function checkAutoUpdate() {
            const now = new Date();
            const last = data.lastUpdate ? new Date(data.lastUpdate) : new Date(0);
            if (now - last > 3600000) {
                const next = getNextUpdateTime();
                if (now >= next) refreshPrices();
            }
        }

        function getHoldingValue(h) {
            const price = h.fetchError ? (h.manualPrice || 0) : (h.currentPrice || 0);
            return h.shares * convertToDKK(price, h.priceCurrency || 'DKK');
        }

        function getFilteredAndSortedHoldings() {
            let holdings = data.holdings.filter(h => {
                if (activeFilter === 'all') return true;
                return activeFilter.split(',').includes(h.type);
            });

            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                holdings = holdings.filter(h =>
                    h.name.toLowerCase().includes(term) ||
                    (h.ticker && h.ticker.toLowerCase().includes(term))
                );
            }

            if (sortBy === 'value-desc') {
                holdings.sort((a,b) => getHoldingValue(b) - getHoldingValue(a));
            } else if (sortBy === 'value-asc') {
                holdings.sort((a,b) => getHoldingValue(a) - getHoldingValue(b));
            } else if (sortBy === 'yield-desc') {
                holdings.sort((a,b) => {
                    const va = getHoldingValue(a);
                    const vb = getHoldingValue(b);
                    const ya = va > 0 ? convertToDKK((a.dividend||0)*a.shares, a.dividendCurrency||'DKK') / va : 0;
                    const yb = vb > 0 ? convertToDKK((b.dividend||0)*b.shares, b.dividendCurrency||'DKK') / vb : 0;
                    return yb - ya;
                });
            } else {
                holdings.sort((a,b) => a.name.localeCompare(b.name));
            }

            return holdings;
        }

        function renderAllocationChart(filtered) {
            const ctx = document.getElementById('allocationChart')?.getContext('2d');
            if (!ctx) return;

            const types = {};
            let total = 0;
            filtered.forEach(h => {
                const v = getHoldingValue(h);
                types[h.type] = (types[h.type] || 0) + v;
                total += v;
            });

            const labels = Object.keys(types);
            const dataPoints = Object.values(types);

            if (allocationChart) allocationChart.destroy();

            allocationChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels.map((l,i) => `${l} (${(dataPoints[i]/total*100 || 0).toFixed(1)}%)`),
                    datasets: [{
                        data: dataPoints,
                        backgroundColor: ['#36A2EB','#FF6384','#FFCE56','#4BC0C0','#9966FF','#FF9F40']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: ctx => `${ctx.label}: ${Math.round(ctx.raw).toLocaleString()} DKK`
                            }
                        }
                    }
                }
            });
        }

        function render() {
            const filtered = getFilteredAndSortedHoldings();

            let totalValue = 0, totalCost = 0, annualIncome = 0;

            filtered.forEach(h => {
                const value = getHoldingValue(h);
                const cost  = convertToDKK(h.cost * h.shares, h.costCurrency);
                const income = convertToDKK((h.dividend||0) * h.shares, h.dividendCurrency || 'DKK');

                totalValue += value;
                totalCost += cost;
                annualIncome += income;
            });

            const change = totalValue - totalCost;
            const changePct = totalCost ? (change / totalCost * 100) : 0;
            const yieldPct = totalValue ? (annualIncome / totalValue * 100) : 0;

            document.getElementById('totalValue').textContent = Math.round(totalValue).toLocaleString('da-DK') + ' DKK';
            document.getElementById('totalChange').textContent =
                (change > 0 ? '+' : '') + Math.round(change).toLocaleString('da-DK') + ' DKK (' + changePct.toFixed(1) + '%)';
            document.getElementById('totalChange').className = 'change ' + (change > 0 ? 'positive' : change < 0 ? 'negative' : '');

            document.getElementById('annualIncome').textContent = Math.round(annualIncome).toLocaleString('da-DK') + ' DKK';
            document.getElementById('yieldPercent').textContent = yieldPct.toFixed(1) + '%';

            const lbl = activeFilter.split(',').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' + ') || 'All';
            document.getElementById('filterLabel').textContent = `(${lbl})`;
            document.getElementById('incomeFilterLabel').textContent = `(${lbl})`;

            const container = document.getElementById('holdings');
            container.innerHTML = '';

            filtered.forEach(h => {
                const div = document.createElement('div');
                div.className = 'holding';
                div.onclick = () => editHolding(data.holdings.indexOf(h));

                const value = getHoldingValue(h);
                const cost = convertToDKK(h.cost * h.shares, h.costCurrency);
                const chg = value - cost;
                const chgPct = cost ? chg / cost * 100 : 0;
                const inc = convertToDKK((h.dividend||0) * h.shares, h.dividendCurrency || 'DKK');
                const yld = value ? inc / value * 100 : 0;

                let status = '';
                if (h.type === 'fund') {
                    status = '<span class="status manual-price">Manual price</span>';
                } else if (h.fetchError) {
                    status = '<span class="status failed">Fetch failed - using manual</span>';
                } else if (h.currentPrice) {
                    status = '<span class="status live">Live price</span>';
                }

                div.innerHTML = `
                    <div class="holding-header">
                        <span class="ticker">${h.name}${h.type==='fund'?' <span class="fund-badge">Fund</span>':''}</span>
                        <span class="value">${Math.round(value).toLocaleString('da-DK')} DKK</span>
                    </div>
                    <div class="meta">${h.shares} shares @ ${h.cost.toFixed(2)} ${h.costCurrency}</div>
                    <div class="meta">Income: ${Math.round(inc)} DKK/yr (${yld.toFixed(1)}%)</div>
                    <div class="meta ${chg>0?'positive':chg<0?'negative':''}">
                        ${(chg>0?'+':'') + Math.round(chg).toLocaleString('da-DK')} DKK (${chgPct.toFixed(1)}%)
                    </div>
                    ${status}
                `;
                container.appendChild(div);
            });

            renderAllocationChart(filtered);

            if (data.lastUpdate) {
                const d = new Date(data.lastUpdate);
                document.getElementById('lastUpdate').textContent = 'Last update: ' + d.toLocaleString('da-DK');
            }

            updateNextUpdateDisplay();
        }

        // Modal & CRUD
        function showModal() { document.getElementById('modal').classList.add('show'); }
        function hideModal() { document.getElementById('modal').classList.remove('show'); }

        function clearForm() {
            document.getElementById('type').value = 'stock';
            document.getElementById('ticker').value = '';
            document.getElementById('name').value = '';
            document.getElementById('shares').value = '';
            document.getElementById('cost').value = '';
            document.getElementById('costCurrency').value = 'DKK';
            document.getElementById('currentPrice').value = '';
            document.getElementById('priceCurrency').value = 'DKK';
            document.getElementById('dividend').value = '0';
            document.getElementById('dividendCurrency').value = 'DKK';
            document.getElementById('deleteBtn').style.display = 'none';
            togglePriceInfo();
        }

        function editHolding(idx) {
            editing = idx;
            const h = data.holdings[idx];
            document.getElementById('modalTitle').textContent = 'Edit Holding';
            document.getElementById('type').value = h.type;
            document.getElementById('ticker').value = h.ticker || '';
            document.getElementById('name').value = h.name;
            document.getElementById('shares').value = h.shares;
            document.getElementById('cost').value = h.cost;
            document.getElementById('costCurrency').value = h.costCurrency || 'DKK';
            document.getElementById('currentPrice').value = h.manualPrice || '';
            document.getElementById('priceCurrency').value = h.priceCurrency || 'DKK';
            document.getElementById('dividend').value = h.dividend || 0;
            document.getElementById('dividendCurrency').value = h.dividendCurrency || 'DKK';
            document.getElementById('deleteBtn').style.display = 'block';
            togglePriceInfo();
            showModal();
        }

        function saveHolding() {
            const type = document.getElementById('type').value;
            const ticker = document.getElementById('ticker').value.trim().toUpperCase();
            const name = document.getElementById('name').value.trim();
            const shares = parseFloat(document.getElementById('shares').value) || 0;
            const cost = parseFloat(document.getElementById('cost').value) || 0;
            const costCur = document.getElementById('costCurrency').value;
            const manPrice = parseFloat(document.getElementById('currentPrice').value) || undefined;
            const priceCur = document.getElementById('priceCurrency').value;
            const div = parseFloat(document.getElementById('dividend').value) || 0;
            const divCur = document.getElementById('dividendCurrency').value;

            if (!name || shares <= 0 || cost <= 0) {
                alert('Name, Shares >0 and Cost >0 required.');
                return;
            }
            if (type !== 'fund' && !ticker) {
                alert('Ticker required for stocks/RSU.');
                return;
            }
            if (type === 'fund' && !manPrice) {
                alert('Current price required for funds.');
                return;
            }

            const holding = {
                type,
                ticker: type !== 'fund' ? ticker : undefined,
                name,
                shares,
                cost,
                costCurrency: costCur,
                manualPrice: manPrice,
                priceCurrency: priceCur,
                dividend: div,
                dividendCurrency: divCur
            };

            if (editing !== null) {
                data.holdings[editing] = holding;
                editing = null;
            } else {
                data.holdings.push(holding);
            }

            localStorage.setItem('portfolio', JSON.stringify(data));
            hideModal();
            clearForm();
            render();
        }

        function deleteHolding() {
            if (!confirm('Delete this holding?')) return;
            data.holdings.splice(editing, 1);
            localStorage.setItem('portfolio', JSON.stringify(data));
            hideModal();
            clearForm();
            render();
        }

        function togglePriceInfo() {
            const isFund = document.getElementById('type').value === 'fund';
            document.getElementById('tickerField').style.display = isFund ? 'none' : 'block';
            document.getElementById('priceInfoStock').style.display = isFund ? 'none' : 'block';
            document.getElementById('priceInfoFund').style.display = isFund ? 'block' : 'none';
            document.getElementById('currentPrice').placeholder = isFund ? 'Required for funds' : 'Leave empty for auto-fetch';
        }

        function exportData() {
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'portfolio-backup.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Event Listeners
        document.getElementById('addBtn').onclick = () => { editing = null; clearForm(); showModal(); };
        document.getElementById('closeBtn').onclick = hideModal;
        document.getElementById('saveBtn').onclick = saveHolding;
        document.getElementById('deleteBtn').onclick = deleteHolding;
        document.getElementById('refreshBtn').onclick = refreshPrices;
        document.getElementById('exportBtn').onclick = exportData;
        document.getElementById('type').onchange = togglePriceInfo;

        document.querySelectorAll('.filter-tab').forEach(tab => {
            tab.onclick = () => {
                document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                activeFilter = tab.dataset.filter;
                render();
            };
        });

        document.getElementById('searchInput').oninput = e => {
            searchTerm = e.target.value;
            render();
        };

        document.getElementById('sortSelect').onchange = e => {
            sortBy = e.target.value;
            render();
        };

        // Init
        updateExchangeRates();
        checkAutoUpdate();
        render();
        setInterval(checkAutoUpdate, 60000);
    </script>
</body>
</html>
